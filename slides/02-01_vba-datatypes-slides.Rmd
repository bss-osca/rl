---
title: "Variables"
author: "Lars Relund Nielsen"
output:
  xaringan::moon_reader:
    css: "./libs/slides.css"
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightLines: true
      highlightStyle: solarized-light
      countIncrementalSlides: false
editor_options: 
  chunk_output_type: console
---

```{r, child = "setup.Rmd", echo=FALSE}
```

```{r include=FALSE}
# use xaringan::inf_mr(cast_from = ".") to preview
```

layout: true

<div class="my-footer">
<span>
<a href="https://bss-osca.github.io/tfa/mod-vba-datatypes.html" target="_blank">Book</a> | <a href="https://bss-osca.github.io/tfa/slides/02-01_vba-datatypes-slides.html" target="_blank">Slides</a> | <a href="https://github.com/bss-osca/tfa/blob/master/slides/02-01_vba-datatypes-slides.Rmd" target="_blank">Source</a> | <a href="https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm" target="_blank">Excel</a>
</span>
</div> 

---

## Variables

.pull-left[
- Variables are used to store information in the program.
- A variable is a box that can contain 
  - A number
  - A string of text
  - A date
  - An array of integers
  - Another datatype.
- The variable name is the label on the box.
]

.pull-right[
```{r, echo = FALSE, out.width="120%", fig.cap="Computer memory"} 
knitr::include_graphics("./img/storage.jpg", dpi = 250) 
```
]

---

## Basic datatypes

A selected set of datatypes are (see all in the [documentation](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/data-type-summary)):

Name    | Type      | Details                                                                        
------- | --------- | -------------------------------------------------------------------------------
Byte    | Numerical | Whole number between 0 and 255.                                                
Integer | Numerical | Whole number between -32'768 and 32'767.                                       
Long    | Numerical | Whole number between - 2'147'483'648 and 2'147'483'647.                        
Double  | Numerical | Floating decimal number between -1.79769313486232E308 and 1.79769313486232E308.
String  | Text      | Text.                                                                          
Date    | Date      | Date and time.                                                                 
Boolean | Boolean   | True or False.                                                                 
Variant | Any type  | Any kind of data (default type if the variable is not declared). 

---

## Memory

.midi[
- Variables take up different storage place in memory. 
- Memory consists of bits (0/1). 1 Bit = Binary Digit, 8 Bits = 1 Byte, 1024 Bytes = 1 Kilobyte, 1024 Kilobytes = 1 Megabyte, 1024 Megabytes = 1 Gigabyte, 1024 Gigabytes = 1 Terabyte.
- Size of selected datatypes:

.left-column-wide[
Data type                                 | Storage size            
----------------------------------------- | ------------------------
Byte                                      | 1 byte                  
Boolean                                   | 2 bytes                 
Integer                                   | 2 bytes                 
Long  (long integer)                      | 4 bytes                 
Double  (double-precision floating-point) | 8 bytes                 
Date                                      | 8 bytes                 
String                                    | 10 bytes + string length
Variant  (with numbers)                   | 16 bytes                
Variant  (with characters)                | 22 bytes + string length
]
.right-column-small[Arrays require 20 bytes of memory plus 4 bytes for each array dimension plus the number of bytes occupied by the data itself. 
A Variant containing an array requires 12 bytes more than the array alone.]
]

---

## Declare and set variables

Variables must be declared by

  ```
  Dim {variable name} As {data type}
  ```

Example:
  ```
  Dim intC As Integer		
  intC = 2
  Dim dblCost As Double		
  dblCost = 2.45
  Dim rng As Range			
  Set rng = Range(“A3”)
  ```

Note the `Set` keyword for setting object variables.

Have a look at the sub `DeclareVariables` in module `A_Declarations` in this [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm).

---

## Why declare variables

- Optimize memory usage
- Avoid errors
- Speed up code (instead of storing in a sheet)

Example: 10000 customer locations on a map. Need to store the distance between each customer in a 10000 x 10000 array. Define array as:

.midi[
Set                                  | Memory
------------------------------------ | ------------------------------------------------------------------------------
Dim location(10000,10000) As Variant | (28 + 10000\*10000\*16)/1024/1024 ~ 1526 MB (default if don’t define explicit)
Dim location(10000,10000) As Double  | (28 + 10000\*10000\*8)/1024/1024 ~ 763 MB                                     
Dim location(10000,10000) As Integer | (28 + 10000\*10000\*2)/1024/1024 ~ 191 MB  
]

Often your computer memory is around 5 GB, i.e. think about which data type you need! 

---

## Use `Option Explicit`

VBA are sloppy with declaring variables. If not declared then assume a variant datatype. But it is BAD coding practice. Hence use
  ```
  Option Explicit
  ```
in the top of every module

Then the VBA editor will tell you if you forget to declare variables (this can be done automatically under the editor options)

---

## Variable scope

- Global variables are known to the whole module or the whole file
- Declare global variables in the top of the file.
- In general try to avoid global variables!
- Local variables are local to a procedure and only known within that procedure.
- Declare local variables inside the procedure.

Have a look at the module `B_Scope` in the [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm) and try to run the functions in debug mode (place the cursor in the top of a procedure and press the step into button). 

For more details about scope see this [page](http://www.cpearson.com/excel/scope.aspx) (extra).

---

## Strings

- Strings are special variables with varying length 
  ```
  Dim strX As String
  Dim strY As String
  Dim strRes As String
  strX = "Advanced"
  strY = "Excel"
  strRes = strX & " " & strY  
  ```
- We use the `&` to concatenate strings (glue strings together).
- An empty string is of length zero.

Further reading can be done in Chapter 13 in the VBA book (extra).

---

## Arrays

.pull-left[
An array store groups of variables of a specific datatype.
  ```
  Dim intValues(8) As Integer
  ```
We have an array with 9 elements which can be accessed using index 0, 1, 2, ..., 8. Access to value in the box with index 4:
]
.pull-right[
```{r, echo = FALSE, out.width="100%", fig.cap="An array in memory."} 
knitr::include_graphics("./img/array.jpg") 
```
]

  ```
  
  MsgBox(intValues(4))  ' return 98     
  ```

Note the default start index is 0. If you want to start with index 1 then add `Option Base 1` to the top of your module! 

Have a look at procedures `ArrayEx1` and `ArrayEx2` in the module `A_Declarations` in the [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm). To test the `Option Base 1` check out module `C_Base1`.

---

## Multidimension arrays

.pull-left[
An array can have different dimensions:
  ```
  Dim intOrderSize(52, 100, 50) As Integer  
  ```
where indices may be (week, customer, product) number. Let us assume that index start from 1 then we have an array with $52 \cdot 100 \cdot 50$ elements which can be accessed using e.g.
]
.pull-right[
```{r, echo = FALSE, out.width="100%", fig.cap="Arrays with different dimensions."} 
knitr::include_graphics("./img/3d-array.png") 
```
]

  ```
  
  MsgBox intOrderSize(2, 10, 20)  ' order size week 2, customer 10, product 20 
  ```

Have a look at procedure `MultidimArray` in the module `D_MultidimArray` in the [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm). 

---

## Dynamic arrays

Often we don't know the size of the array we need when we start the program. Use `ReDim` to set the dimension 
 
```
Dim strPeople() As String
...
n = 8
ReDim strPeople(n)
```

Have a look at procedure `DynArray` in the module `A_Declarations` in the [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm).

You can always lowest and highest index using functions `LBound` and `UBound`

---

## Collections

Collections are a way of storing a group of items together (think of it as a set). If we compare collections against arrays:

- Collections are similar to arrays but better to use when the number of items is not fixed. With an array you normally set the size once. On the contrary you often add or remove items from a collection.
- Collections are better when adding and removing items.
- An item in a collection are read-only whereas an entry in an array are read/write.
- Collection can be accessed using a key or an index (starting from 1).
- Items of a collection do not have to share the same data type.

Have a look at the module `E_Collections` in the [Excel file](https://github.com/bss-osca/tfa/blob/master/vba/vba-datatypes-template.xlsm).





```{r copy to docs, include=FALSE}
file.copy(list.files(pattern = ".html"), "../docs/slides/", overwrite = T)
file.copy("./slides.css", "./libs/", overwrite = T)
file.copy("libs", "../docs/slides/", recursive = T)
file.copy("img", "../docs/slides/", recursive = T)
system2("Rscript", args = "-e 'rmarkdown::render(\"index.Rmd\", quiet = TRUE)'")
```