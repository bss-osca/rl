---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, code = readLines("common.R"), cache = FALSE, include=FALSE}
```

# (PART) Programming in VBA {-}

# Data types and variables {#mod-vba-datatypes}

This module gives a short introduction to variables and data types. In general syllabus will point to chapters in @vba-book; however, there is a lot for videos about VBA online such as courses [30 for 30 Excel VBA Absolute Beginner Course][vba-yt-course1] and [14-Hour VBA Course][vba-yt-course2]. You may have a look at these videos instead if you prefer a different learning style. In the learning path diagram, links to alternative online content will be pointed out. Note this is alternatives to the standard learning path that you may use instead. The learning path may also have extra content that is not a part of syllabus you can have a look at.

__Learning path diagram__

Click/hover the nodes to follow links and see details.

```{r, echo=FALSE, out.width="100%", fig.asp=NA}
g <- create_learning_path(
   url = "https://docs.google.com/spreadsheets/d/1bBe42LHK-bE7CsU9eNBzi_7VNjbmv-Ybr7285pE61jM/edit?usp=sharing", 
   sheet = "vba-datatypes", 
   x_legend = 3.5, y_legend = 4.5)
render_graph(g, height = 400)
```

## Learning outcomes {#lo-vba-datatypes}

By the end of this module, you are expected to be able to:

* Describe what a variable is.
* Name different datatypes and how they effect memory size.
* Declare a variable as a datatype.
* Describe that scope for a variable means.
* Declare an array variable with both fixed and dynamic dimension.
* Assign values to variables.
* Formulate well-structured code.

The learning outcomes relate to the [overall learning goals](#lg-course) number 1, 2, 4, 8 and 9 of the course.

<!-- SOLO increasing: identify · memorise · name · do simple procedure · collect data · -->
<!-- enumerate · describe · interpret · formulate · list · paraphrase · combine · do -->
<!-- algorithms · compare · contrast · explain causes · analyse · relate · derive · -->
<!-- evaluate · apply · argue · theorise · generalise · hypothesise · solve · reflect -->


## Datatypes {#vba-datatypes}

Variables are used to store information in a program that is saved in memory. A variable may store different datatypes such as an integer, a double, a string or an object (e.g. a range).

Read Chapter 4 in @vba-book. You may also have a look at the alternative and extra videos instead as listed in the learning path diagram.

### Collections

A useful datatype not mentioned in Chapter 4 is a collection. Collections are a way of storing a group of items together (think of it as a set). Collections and arrays are both used to group variables. They both store a set of items e.g. a list of student marks or country names. If we compare collections against arrays:

- Collections are similar to arrays but better to use when the number of items is not fixed. With an array you normally set the size once. On the contrary you often add or remove items from a collection.
- Collections are better when adding and removing items.
- An item in a collection are read-only whereas an entry in an array are read/write.
- Collection can be accessed using a key or an index (starting from 1).
- Items of a collection do not have to share the same data type.

Collections are a part of the [Object Model](#mod-vba-object-model) and hence a collection have to be defined in a special way. Let us consider an [example](https://github.com/bss-osca/tfa/blob/master/vba/vba-collection-examples.xlsm). First we declare and create a collection:
```
Dim col As New Collection
```
The collection (or set) is now defined with zero items. You can add items using
```
col.Add "Apple"
col.Add "Pear"
col.Add 123
```
Let us create a function that prints the items of a collection as string:
```
Function Coll2Str(col As Collection) As String
    Dim e As Variant
    Dim str As String
    
    For Each e In col
        str = str & e & ", "
    Next e
    str = Left(str, Len(str) - 1)
    Coll2Str = str
End Function
```
Then the output of 
```
Debug.Print "The collection now contains " & col.Count & " items: " & Coll2Str(col)
```
in the Immediate window becomes
```
The collection now contains 3 items: Apple, Pear, 123
```
You can access values in the collection using index:
```
Debug.Print "The 1. item is: " & col(1)
Debug.Print "The 3. item is: " & col(3)
```
```
The 1. item is: Apple
The 3. item is: 123
```
Items are removed using:
```
col.Remove (2)
Debug.Print "The collection now contains " & col.Count & " items: " & Coll2Str(col)
```

```
The collection now contains 2 items: Apple, 123
```

Note index of items has now changed (the 3. item has become the 2. item):
```
Debug.Print "The 1. item is: " & col(1)
Debug.Print "The 2. item is: " & col(2)
```

```
The 1. item is: Apple
The 2. item is: 123
```

You clear a collection using:
```
Set col = Nothing
Debug.Print "The collection now contains " & col.Count & " items."
```

```
The collection now contains 0 items.
```

An item in a collection can be given a key:
```
col.Add "Hans Jørgensen", "ID123"   ' value, key
col.Add "Jens Hansen", "ID234"
col.Add "Lone Nielsen", "ID456"
' col.Add "Sine Mikkelsen", "ID456" ' gives an error since already used the key
Debug.Print "The collection now contains " & col.Count & " items: " & Coll2Str(col)
```

```
The collection now contains 3 items: Hans Jørgensen, Jens Hansen, Lone Nielsen
```
You can now access the item using the key:
```
Debug.Print "The item with key ID123 is: " & col("ID123")
```

```
The item with key ID123 is: Hans Jørgensen
```
Similar you can remove an item using a key:
```
 col.Remove "ID123"
 Debug.Print "The collection now contains " & col.Count & " items: " & Coll2Str(col)
```

```
The collection now contains 2 items: Jens Hansen, Lone Nielsen
```

It is recommended to use keys since using keys has three advantages:

- If the order changes your code will still access the correct item
- You can directly access the item without reading through the entire collection
- It can make you code more readable

For more information about collections you may have a look at this [webpage](http://excelmacromastery.com/excel-vba-collections/).


## How do I structure my code? {#vba-code-structure}

When you program it is always a good idea to structure your code. The main reason for using a consistent set of coding conventions is to standardize the structure and coding style of an application so that you and others can easily read and understand the code. Good coding conventions result in precise, readable, and unambiguous source code that is consistent with other language conventions and as intuitive as possible. 

Have a look at the [guidelines given here](#coding-convention).


## Recap

- Variables are used to store information in a program. The information is saved in memory. A variable may store different datatypes such as an integer, a double, a string or an object (e.g. a range).
- A selected set of datatypes are (see all in the [documentation](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/data-type-summary)):

   Name    | Type      | Details                                                                        
   ------- | --------- | -------------------------------------------------------------------------------
   Byte    | Numerical | Whole number between 0 and 255.                                                
   Integer | Numerical | Whole number between -32'768 and 32'767.                                       
   Long    | Numerical | Whole number between - 2'147'483'648 and 2'147'483'647.                        
   Double  | Numerical | Floating decimal number between -1.79769313486232E308 and 1.79769313486232E308.
   String  | Text      | Text.                                                                          
   Date    | Date      | Date and time.                                                                 
   Boolean | Boolean   | True or False.                                                                 
   Variant | Any type  | Any kind of data (default type if the variable is not declared). 

- Memory consists of bits (binary digit) where a bit can take the value 0 or 1. 
- Common naming of memory chunks are 8 Bits = 1 Byte, 1024 Bytes = 1 Kilobyte, 1024 Kilobytes = 1 Megabyte, 1024 Megabytes = 1 Gigabyte, 1024 Gigabytes = 1 Terabyte.
- Variables take up different storage place in memory based on the datatype they use. The size of selected datatypes:

   Data type                                 | Storage size            
   ----------------------------------------- | ------------------------
   Byte                                      | 1 byte                  
   Boolean                                   | 2 bytes                 
   Integer                                   | 2 bytes                 
   Long  (long integer)                      | 4 bytes                 
   Double  (double-precision floating-point) | 8 bytes                 
   Date                                      | 8 bytes                 
   String                                    | 10 bytes + string length
   Variant  (with numbers)                   | 16 bytes                
   Variant  (with characters)                | 22 bytes + string length

   Arrays require 20 bytes of memory plus 4 bytes for each array dimension plus the number of bytes occupied by the data itself. A Variant containing an array requires 12 bytes more than the array alone.

- Variables must be declared by

  ```
  Dim {variable name} As {data type}
  ```

  Example:
  ```
  Dim intC As Integer		
  intC = 2
  Dim dblCost As Double		
  dblCost = 2.45
  Dim rng As Range			
  Set rng = Range(“A3”)
  ```

  Note the `Set` keyword for setting object variables.

- Declare varibles to optimize memory usage, avoid errors and speed up code (instead of storing in a sheet).
- Use `Option Explicit` in the top of every module so the VBA editor will tell you if you forget to declare variables.
- Variable scope:
   - Global variables are known to the whole module or the whole file
   - Declare global variables in the top of the file.
   - In general try to avoid global variables!
   - Local variables are local to a procedure and only known within that procedure.
   - Declare local variables inside the procedure.
- Strings are special variables with varying length.
- Use the `&` to concatenate strings (glue strings together).
- An empty string is of length zero.
- An array store groups of variables of a specific datatype. For example
  ```
  Dim intValues(8) As Integer
  ```
  The variable `intValues` is an array with 9 elements which can be accessed using index 0, 1, 2, ..., 8. 
- The default start index of an array is 0. If you want to start with index 1 then add `Option Base 1` to the top of your module.
- An array can have different dimensions, e.g.
  ```
  Dim intOrderSize(52, 100, 50) As Integer  
  ```
  where indices may be (week, customer, product) number. Let us assume that index start from 1 then we have an array with $52 \cdot 100 \cdot 50$ elements which can be accessed using e.g.

  ```
  intOrderSize(2,10, 20)  ' order size week 2, customer 10, product 20 
  ```
- Dynamic arrays are arrays where the dimension is unknown when they are declared. Use `ReDim` to set the dimension later:
 
   ```
   Dim strPeople() As String
   ...
   n = 8
   ReDim strPeople(n)
   ```

You may also have a look at the [slides for this module](https://bss-osca.github.io/tfa/slides/02-01_vba-datatypes-slides.html).

## Exercises {#ex-vba-datatypes}

`r strExercises`

### Exercise - Product search {#ex-vba-search-products}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-search-products-template.xlsm) contains a sheet _Products_ with a set of products with product code and price. Cell D1 contains the total number of products. 

   (1) Create a sub `FindProduct` that 
       * Declare two arrays to store the price and product code.
       * Uses `ReDim` to set the size of the arrays.
       * Use a for loop to assign values to the arrays.
       * Use an input box to ask for a product code.
       * Use a for loop to search for the product and output the price in a message box.
   (2) Test you code using different product codes
   (3) Add a button to the Main sheet that run the procedure.
   (4) What happens if you write the product code without capital letters? If your code do not work, have a look at the [`UCase`](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/ucase-function) function.
   (5) Modify your code so that if the product is not found then "Product not found!" is given in a message box. Hint: the [`Exit sub`](https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/exit-statement) may be useful inside the last for loop.
       

### Exercise - Read arrays {#ex-vba-read-arrays}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-read-arrays-template.xlsm) contains different sheets with numbers to be read into an array. 

   (1) The sheet _1D Array_ contains an index number `i` (column A) and value `v` (column B) also known as a long format. Create an array `ary1D` (with index starting from 0) that store the values `v` in array entry `ary1D(i)`. Assume that the default array value is 10. Hint you need a for loop to iterate though the numbers. Have a look at the unfinished sub `Read1DAry` for further hints.
   (2) The sheet _2D Array_ contains an array in matrix format where a cell in row `r` and column `c` contains the value to be stored in the array entry `ary2D(r, c)`. Create the array and store the values. Note `ary2D` start indexing from 1 and not 0. Have a look at the unfinished sub `Read2DAry` for further hints.
   (3) Modify sub `Read2DAry` so that indexing start from 0 instead of 1, i.e. a cell in row `r` and column `c` contains the value to be stored in the array entry `ary2D(r - 1, c - 1)`.
   (4) The sheet _4D Array_ contains values to be stored in a long format (column A:D indices and column E values). Create an array `ary4D` (with index starting from 0) that store the values. Assume that the default value is 5. Have a look at the unfinished sub `Read4DAry` for further hints.
   
   
### Exercise - Read collections {#ex-vba-read-collections}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-read-collections-template.xlsm) contains different sheets with numbers to be read into a collection.

Sheet _Data no keys_ contains some numbers. Create a procedure `CollNoKeys` that:

   (1) Create a collection `col` and add all the numbers.
   (2) Print the collection in a message box (you may use the function `Coll2Str` here).
   (3) Create another collection and add all the items in `col` with value below 5.

Sheet _Data with keys_ contains some ID numbers and prices for a set of products. Create a procedure `CollKeys` that:

   (1) Create a collection `col` and add all the prices using ID as key.
   (2) Print the price of the product with ID92011 in a message box.
   (3) What happens if you try to print the price of ID92?
   
   
```{r links, child="links.md", include=FALSE}
```