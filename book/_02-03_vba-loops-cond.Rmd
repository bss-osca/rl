---
output: html_document
editor_options: 
  chunk_output_type: console
---
```{r, code = readLines("common.R"), cache = FALSE, include=FALSE}
```

# Loops and conditional statements {#mod-vba-loops-cond}

This module gives a short introduction to loops and conditional statements. In general syllabus will point to chapters in @vba-book; however, there is a lot for videos about VBA online such as course [14-Hour VBA Course][vba-yt-course2]. You may have a look at these videos instead if you prefer a different learning style. In the learning path diagram, links to alternative online content will be pointed out. Note this is alternatives to the standard learning path that you may use instead. The learning path may also have extra content that is not a part of syllabus you can have a look at.

__Learning path diagram__

Click/hover the nodes to follow links and see details.

```{r, echo=FALSE, out.width="100%", fig.asp=NA}
g <- create_learning_path(
   url = "https://docs.google.com/spreadsheets/d/1bBe42LHK-bE7CsU9eNBzi_7VNjbmv-Ybr7285pE61jM/edit?usp=sharing", 
   sheet = "vba-loops-cond", 
   x_legend = 3.8, y_legend = 4.5)
render_graph(g, height = 400)
```

## Learning outcomes {#lo-vba-loops-cond}

By the end of this module, you are expected to be able to:

* Describe what a conditional statement is.
* Test a condition built using relational/logical operators.
* Declare a conditional statement.
* Describe what a loop is.
* Declare a loop.
* Declare nested loops.
* Exit a loop.

The learning outcomes relate to the [overall learning goals](#lg-course) number 1, 2, 4, 8, 9-12 and 16 of the course.

<!-- SOLO increasing: identify · memorise · name · do simple procedure · collect data · -->
<!-- enumerate · describe · interpret · formulate · list · paraphrase · combine · do -->
<!-- algorithms · compare · contrast · explain causes · analyse · relate · derive · -->
<!-- evaluate · apply · argue · theorise · generalise · hypothesise · solve · reflect -->


## Conditional statements {#vba-cond}

Conditional statements are used to make decisions based on the conditions, i.e. a conditional statement control the flow in which the code runs. If the condition is met then the code is executed. 
  
Read Sections 6.1-6.2.1 in Chapter 6 in @vba-book. You may also have a look at the extra videos as listed in the learning path diagram.


## Loops {#vba-loops}

Loops are used to repeat pieces of code.

Read Sections 6.3-6.4 and Section 6.5.2 in Chapter 6 in @vba-book. You may also have a look at the extra videos as listed in the learning path diagram.


## Recap

- Loops are used to repeat pieces of code.
- For loops (repeat a number of times):
  ```
  For i = 1 To 10 
      <code>
  Next
  ```
      
- While loops (repeat until a condition is met - two versions):

   ```
   While {condition true}    
       <code>
   Wend
   
   Do While {condition true}    
       <code>
   Loop
   ```
      
- Use `Exit for` and `Exit Do` to break a `For` and a `Do While` loop before it ends (jump to the code after the loop). You can not exit `While` loops this way.
- Loops may be nested inside each other:

   ```
   For i = 1 To 2     
     For j = 1 To 3  
         MsgBox ("(" & i & "," & j & ")")
     Next
   Next
   ```
   
- Conditional Statements are used to make decisions based on the conditions. If the condition is met then the code is executed. 
- An if-then-else statement:

   ```
   If k <= 10 Then
    <code>
   ElseIf k <= 13 Then
    <code>
   Else
    <code>
   End If
   ```
   
- You may drop `ElseIf` and `Else` code chunks. 

You may also have a look at the [slides for this module](https://bss-osca.github.io/tfa/slides/02-03_vba-loops-cond-slides.html).

## Exercises {#ex-vba-loops-cond}

`r strExercises`

### Exercise - Loops {#ex-vba-loops}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-loops-template.xlsm) may be used as a starting point for this exercise. Use the sheet _Testing_ for output.

   (1) Create a for loop that writes numbers 1 to 4 in rows 1 to 4 in column A.  
   (2) Create a while loop that writes numbers 1 to 4 in rows 1 to 4 in column B. 
   (3) Create a do while loop that writes numbers 1 to 4 in rows 1 to 4 in column C.
   (4) Create a loop that writes numbers 1 to 4 in rows 3 to 6 in column D.
   (5) Create a loop that writes numbers -1 to -4 in rows 1 to 4 in column E.
   (6) Create a loop that writes numbers 1 to 4 in rows 4 to 7 in column F, except if the number is 3 then the output should to a string `missing`.
   (7) Create a do while loop that writes numbers i = 1, 2, ... in column G until i/5 + 3 = 8. Hint: you may use a `Exit Do` to quit the loop. 
   (8) Create a sub `Main` that runs all the loops.

### Exercise - Flight search {#ex-vba-flight}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-flight-template.xlsm) should be used as a starting point for this exercise. 

The sheet _Data_ contains a set of flights between different destinations. You task is to create a program that can search for matching flights given a set of origins and destinations. 

   (1) Have a look at the results in sheet _Main_. The origin and destinations to search for are given in columns A and B and the search result in columns D, E and F. 
   (2) Try pressing the **Clear Search** button and see what happens. Have a look at the code in the VBA editor for this sub and get an overview. You are not expected to understand all the code.
   (3) Try to finish the first part of the `SearchFlights` sub and store the flights in arrays. Use the debugger to check if the values are stored correctly. 

```{r, hint=TRUE, eval=FALSE, title="Hint 2"}
 For o = 1 To intOrigins
     For i = 0 To intFlights - 1
         If Cells(5 + o, 1) = Origin(i) Then 
             For d = 1 To intDestinations
                 ___
             Next 
         End If
     Next 
 Next 
```
```{r, hint=TRUE, eval=FALSE, title="Hint 1", text="You need nested loops (loop over origins, flights, destinations)"}
```
   
   (4) Try to finish the second part of the `SearchFlights` sub and search for matching origin-destination pairs. Note origins and destinations listed to be searched for are also matching origin-destination pairs if they are not in the same row.

### Exercise - Job sequencing {#ex-vba-job-seq}

The [file](https://github.com/bss-osca/tfa/blob/master/vba/vba-job-sequence-template.xlsm) should be used as a starting point for this exercise. 

Consider $i = 1,...,n$ jobs that has to be done on a machine and let $c_{ij}$ denote the setup cost of switching from job $i$ to job $j$. Moreover, let $c_{0i}$ denote the setup cost of setting up job $i$ when the machine is idle (index 0). Let $s = (0, s_1, \ldots, s_n)$ denote the sequence of jobs and $C$ the total setup costs, e.g. if $s = (0,1,3,2,6,5,4)$, then $C = c_{01} + c_{13} + c_{32} + c_{26} + c_{65} + c_{54}$. Different algorithms for finding a good strategy minimizing the total setup costs exists. A greedy algorithm is:

<div class="box">
**Step 0**: Select the first job as one with minimal idle setup cost.

**Step 1**: Given current job $i$ select the unscheduled with minimal setup cost. 

**Step 2**: If no unscheduled jobs then stop and output the found job sequence else go to Step 1.
</div>

Often a better algorithm is:

<div class="box">
**Step 0**: For each column $j$ find $\bar{c}_j = min(c_{0j},\ldots,c_{j-1,j},c_{j+1,j},\ldots,c_{nj})$ and define relative setup costs $\hat{c}_{ij} = c_{ij}-\bar{c}_{j}$ (the cost is subtracted the minimum value in that column).

**Step 1**: Call the greedy algorithm using costs $\hat{c}_{ij}$.
</div>

Consider sheet _Main_ that contains the setup costs for a scheduling problem.

   (1) Implement the greedy algorithm in a sub `Greedy` that store the setup costs in an ($n+1 \times n$) 2D array `costs` assuming the setup costs table start in cell A4. Next, call the sub `GreedyAlg(costs)` that takes the costs as input argument. The sub must
       - Store the job sequence in an 1D array.
       - Output the number of jobs in cell C1, the job sequence in cell C2 and the total setup costs in cell F1.
       - Highlight the cells with setup costs used in the sequence.
       
   (2) Implement the better algorithm in a sub `Better` that
       - Find and store the minimum setup costs for each column.
       - Calculate the relative costs.
       - Call the greedy algorithm using the relative costs.
       - Correct the total setup costs by adding the minimum costs.
   (3) Add three buttons to _Main_ that remove the solution, run greedy and run better.
   (4) Try to use different datasets from the sheet _Data_ and paste it into A4 in _Main_.

```{r links, child="links.md", include=FALSE}
```

