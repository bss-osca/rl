<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Module 8 Temporal difference methods for control | Reinforcement Learning for Business (RL)</title>
  <meta name="description" content="Course notes for ‘Reinforcement Learning for Business’" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Module 8 Temporal difference methods for control | Reinforcement Learning for Business (RL)" />
  <meta property="og:type" content="book" />
  <meta property="og:image" content="https://bss-osca.github.io/rl//img/logo.png" />
  <meta property="og:description" content="Course notes for ‘Reinforcement Learning for Business’" />
  <meta name="github-repo" content="bss-osca/rl" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Module 8 Temporal difference methods for control | Reinforcement Learning for Business (RL)" />
  
  <meta name="twitter:description" content="Course notes for ‘Reinforcement Learning for Business’" />
  <meta name="twitter:image" content="https://bss-osca.github.io/rl//img/logo.png" />

<meta name="author" content="Lars Relund Nielsen" />


<meta name="date" content="2024-11-18" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="assets/favicon.ico" type="image/x-icon" />
<link rel="prev" href="mod-td-pred.html"/>
<link rel="next" href="mod-r-setup.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />
<link href="libs/htmltools-fill-0.5.8.1/fill.css" rel="stylesheet" />
<script src="libs/htmlwidgets-1.6.4/htmlwidgets.js"></script>
<link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="libs/datatables-binding-0.33/datatables.js"></script>
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="libs/dt-core-1.13.6/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="libs/dt-core-1.13.6/js/jquery.dataTables.min.js"></script>
<link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet" />
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script>
<link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet" />
<script src="libs/selectize-0.12.0/selectize.min.js"></script>
<link href="libs/crosstalk-1.2.1/css/crosstalk.min.css" rel="stylesheet" />
<script src="libs/crosstalk-1.2.1/js/crosstalk.min.js"></script>
<html>
<head>

<script id="code-folding-options" type="application/json">
  {"initial-state": "hide"}
</script>
   
<script>
  $(document).ready(function() {

  // Section anchors
  $('.section h1, .section h2, .section h3, .section h4, .section h5').each(function() {
    anchor = '#' + $(this).parent().attr('id');
    $(this).addClass("hasAnchor").prepend('<a href="' + anchor + '" class="anchor"></a>');
  });
});

// code folding
document.addEventListener("DOMContentLoaded", function() {
  const languages = ['r', 'python', 'bash', 'sql', 'cpp', 'stan', 'julia', 'foldable'];
  const options = JSON.parse(document.getElementById("code-folding-options").text);
  const show = options["initial-state"] !== "hide";
  Array.from(document.querySelectorAll("pre.sourceCode")).map(function(pre) {
    const classList = pre.classList;
    if (languages.some(x => classList.contains(x))) {
      const div = pre.parentElement;
      const state = show || classList.contains("fold-show") && !classList.contains("fold-hide") ? " open" : "";
      div.outerHTML = `<details${state}><summary></summary>${div.outerHTML}</details>`;
    }
  });
});
</script>

<script src="https://hypothes.is/embed.js" async></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

</head>
</html>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>
<style type="text/css">
/* Used with Pandoc 2.11+ new --citeproc when CSL is used */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>

<link rel="stylesheet" href="assets/style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="toc-logo"><a href="./"><img src="img/logo.png"></a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>About the course notes</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-outcomes"><i class="fa fa-check"></i>Learning outcomes</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#purpose-of-the-course"><i class="fa fa-check"></i>Purpose of the course</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#learning-goals-of-the-course"><i class="fa fa-check"></i>Learning goals of the course</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#reinforcement-learning-textbook"><i class="fa fa-check"></i>Reinforcement learning textbook</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#course-organization"><i class="fa fa-check"></i>Course organization</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#programming-software"><i class="fa fa-check"></i>Programming software</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#ack"><i class="fa fa-check"></i>Acknowledgements and license</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#sec-intro-ex"><i class="fa fa-check"></i>Exercises</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#sec-intro-ex-annotate"><i class="fa fa-check"></i>Exercise - How to annotate</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#sec-intro-ex-templates"><i class="fa fa-check"></i>Exercise - Templates</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>I Introduction to RL</b></span></li>
<li class="chapter" data-level="1" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html"><i class="fa fa-check"></i><b>1</b> An introduction to RL</a>
<ul>
<li class="chapter" data-level="1.1" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#mod-rl-intro-lo"><i class="fa fa-check"></i><b>1.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="1.2" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#textbook-readings"><i class="fa fa-check"></i><b>1.2</b> Textbook readings</a></li>
<li class="chapter" data-level="1.3" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#what-is-reinforcement-learning"><i class="fa fa-check"></i><b>1.3</b> What is reinforcement learning</a></li>
<li class="chapter" data-level="1.4" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#rl-and-business-analytics"><i class="fa fa-check"></i><b>1.4</b> RL and Business Analytics</a></li>
<li class="chapter" data-level="1.5" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#rl-in-different-research-deciplines"><i class="fa fa-check"></i><b>1.5</b> RL in different research deciplines</a></li>
<li class="chapter" data-level="1.6" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#rl-and-machine-learning"><i class="fa fa-check"></i><b>1.6</b> RL and machine learning</a></li>
<li class="chapter" data-level="1.7" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#the-rl-data-stream"><i class="fa fa-check"></i><b>1.7</b> The RL data-stream</a></li>
<li class="chapter" data-level="1.8" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#states-actions-rewards-and-policies"><i class="fa fa-check"></i><b>1.8</b> States, actions, rewards and policies</a></li>
<li class="chapter" data-level="1.9" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#exploitation-vs-exploration"><i class="fa fa-check"></i><b>1.9</b> Exploitation vs Exploration</a></li>
<li class="chapter" data-level="1.10" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#rl-in-action-tic-tac-toe"><i class="fa fa-check"></i><b>1.10</b> RL in action (Tic-Tac-Toe)</a>
<ul>
<li class="chapter" data-level="1.10.1" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#players-and-learning-to-play"><i class="fa fa-check"></i><b>1.10.1</b> Players and learning to play</a></li>
<li class="chapter" data-level="1.10.2" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#gameplay"><i class="fa fa-check"></i><b>1.10.2</b> Gameplay</a></li>
<li class="chapter" data-level="1.10.3" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#rl-intro-tic-learn"><i class="fa fa-check"></i><b>1.10.3</b> Learning by a sequence of games</a></li>
</ul></li>
<li class="chapter" data-level="1.11" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#summary"><i class="fa fa-check"></i><b>1.11</b> Summary</a></li>
<li class="chapter" data-level="1.12" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#sec-rl-intro-ex"><i class="fa fa-check"></i><b>1.12</b> Exercises</a>
<ul>
<li class="chapter" data-level="1.12.1" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#ex-r-intro-self"><i class="fa fa-check"></i><b>1.12.1</b> Exercise - Self-Play</a></li>
<li class="chapter" data-level="1.12.2" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#ex-r-intro-sym"><i class="fa fa-check"></i><b>1.12.2</b> Exercise - Symmetries</a></li>
<li class="chapter" data-level="1.12.3" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#ex-r-intro-greedy"><i class="fa fa-check"></i><b>1.12.3</b> Exercise - Greedy Play</a></li>
<li class="chapter" data-level="1.12.4" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#ex-r-intro-exploit"><i class="fa fa-check"></i><b>1.12.4</b> Exercise - Learning from Exploration</a></li>
<li class="chapter" data-level="1.12.5" data-path="mod-rl-intro.html"><a href="mod-rl-intro.html#ex-r-intro-other"><i class="fa fa-check"></i><b>1.12.5</b> Exercise - Other Improvements</a></li>
</ul></li>
</ul></li>
<li class="part"><span><b>II Tabular methods</b></span></li>
<li class="chapter" data-level="2" data-path="mod-bandit.html"><a href="mod-bandit.html"><i class="fa fa-check"></i><b>2</b> Multi-armed bandits</a>
<ul>
<li class="chapter" data-level="2.1" data-path="mod-bandit.html"><a href="mod-bandit.html#learning-outcomes-1"><i class="fa fa-check"></i><b>2.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="2.2" data-path="mod-bandit.html"><a href="mod-bandit.html#textbook-readings-1"><i class="fa fa-check"></i><b>2.2</b> Textbook readings</a></li>
<li class="chapter" data-level="2.3" data-path="mod-bandit.html"><a href="mod-bandit.html#the-k-armed-bandit-problem"><i class="fa fa-check"></i><b>2.3</b> The k-armed bandit problem</a></li>
<li class="chapter" data-level="2.4" data-path="mod-bandit.html"><a href="mod-bandit.html#estimating-the-value-of-an-action"><i class="fa fa-check"></i><b>2.4</b> Estimating the value of an action</a></li>
<li class="chapter" data-level="2.5" data-path="mod-bandit.html"><a href="mod-bandit.html#sec-bandit-step-size"><i class="fa fa-check"></i><b>2.5</b> The role of the step-size</a></li>
<li class="chapter" data-level="2.6" data-path="mod-bandit.html"><a href="mod-bandit.html#optimistic-initial-values"><i class="fa fa-check"></i><b>2.6</b> Optimistic initial values</a></li>
<li class="chapter" data-level="2.7" data-path="mod-bandit.html"><a href="mod-bandit.html#upper-confidence-bound-action-selection"><i class="fa fa-check"></i><b>2.7</b> Upper-Confidence Bound Action Selection</a></li>
<li class="chapter" data-level="2.8" data-path="mod-bandit.html"><a href="mod-bandit.html#summary-1"><i class="fa fa-check"></i><b>2.8</b> Summary</a></li>
<li class="chapter" data-level="2.9" data-path="mod-bandit.html"><a href="mod-bandit.html#sec-bandit-ex"><i class="fa fa-check"></i><b>2.9</b> Exercises</a>
<ul>
<li class="chapter" data-level="2.9.1" data-path="mod-bandit.html"><a href="mod-bandit.html#ex-bandit-adv"><i class="fa fa-check"></i><b>2.9.1</b> Exercise - Advertising</a></li>
<li class="chapter" data-level="2.9.2" data-path="mod-bandit.html"><a href="mod-bandit.html#ex-bandit-coin"><i class="fa fa-check"></i><b>2.9.2</b> Exercise - A coin game</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html"><i class="fa fa-check"></i><b>3</b> Markov decision processes (MDPs)</a>
<ul>
<li class="chapter" data-level="3.1" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#learning-outcomes-2"><i class="fa fa-check"></i><b>3.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="3.2" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#textbook-readings-2"><i class="fa fa-check"></i><b>3.2</b> Textbook readings</a></li>
<li class="chapter" data-level="3.3" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#an-mdp-as-a-model-for-the-agent-environment"><i class="fa fa-check"></i><b>3.3</b> An MDP as a model for the agent-environment</a></li>
<li class="chapter" data-level="3.4" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#rewards-and-the-objective-function-goal"><i class="fa fa-check"></i><b>3.4</b> Rewards and the objective function (goal)</a></li>
<li class="chapter" data-level="3.5" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#summary-2"><i class="fa fa-check"></i><b>3.5</b> Summary</a></li>
<li class="chapter" data-level="3.6" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#sec-mdp-1-ex"><i class="fa fa-check"></i><b>3.6</b> Exercises</a>
<ul>
<li class="chapter" data-level="3.6.1" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#ex-mdp-1-seq"><i class="fa fa-check"></i><b>3.6.1</b> Exercise - Sequential decision problems</a></li>
<li class="chapter" data-level="3.6.2" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#ex-mdp-1-exp-return"><i class="fa fa-check"></i><b>3.6.2</b> Exercise - Expected return</a></li>
<li class="chapter" data-level="3.6.3" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#ex-mdp-1-gambler"><i class="fa fa-check"></i><b>3.6.3</b> Exercise - Gambler’s problem</a></li>
<li class="chapter" data-level="3.6.4" data-path="mod-mdp-1.html"><a href="mod-mdp-1.html#ex-mdp-1-storage"><i class="fa fa-check"></i><b>3.6.4</b> Exercise - Factory storage</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html"><i class="fa fa-check"></i><b>4</b> Policies and value functions for MDPs</a>
<ul>
<li class="chapter" data-level="4.1" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#learning-outcomes-3"><i class="fa fa-check"></i><b>4.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="4.2" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#textbook-readings-3"><i class="fa fa-check"></i><b>4.2</b> Textbook readings</a></li>
<li class="chapter" data-level="4.3" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#policies-and-value-functions"><i class="fa fa-check"></i><b>4.3</b> Policies and value functions</a></li>
<li class="chapter" data-level="4.4" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#sec-mdp-opt"><i class="fa fa-check"></i><b>4.4</b> Optimal policies and value functions</a></li>
<li class="chapter" data-level="4.5" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#optimality-vs-approximation"><i class="fa fa-check"></i><b>4.5</b> Optimality vs approximation</a></li>
<li class="chapter" data-level="4.6" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#semi-mdps-non-fixed-time-length"><i class="fa fa-check"></i><b>4.6</b> Semi-MDPs (non-fixed time length)</a></li>
<li class="chapter" data-level="4.7" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#summary-3"><i class="fa fa-check"></i><b>4.7</b> Summary</a></li>
<li class="chapter" data-level="4.8" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#sec-mdp-2-ex"><i class="fa fa-check"></i><b>4.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="4.8.1" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#ex-mdp-2-policy"><i class="fa fa-check"></i><b>4.8.1</b> Exercise - Optimal policy</a></li>
<li class="chapter" data-level="4.8.2" data-path="mod-mdp-2.html"><a href="mod-mdp-2.html#ex-mdp-2-car"><i class="fa fa-check"></i><b>4.8.2</b> Exercise - Car rental</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="mod-dp.html"><a href="mod-dp.html"><i class="fa fa-check"></i><b>5</b> Dynamic programming</a>
<ul>
<li class="chapter" data-level="5.1" data-path="mod-dp.html"><a href="mod-dp.html#learning-outcomes-4"><i class="fa fa-check"></i><b>5.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="5.2" data-path="mod-dp.html"><a href="mod-dp.html#textbook-readings-4"><i class="fa fa-check"></i><b>5.2</b> Textbook readings</a></li>
<li class="chapter" data-level="5.3" data-path="mod-dp.html"><a href="mod-dp.html#sec-dp-pe"><i class="fa fa-check"></i><b>5.3</b> Policy evaluation</a></li>
<li class="chapter" data-level="5.4" data-path="mod-dp.html"><a href="mod-dp.html#policy-improvement"><i class="fa fa-check"></i><b>5.4</b> Policy Improvement</a></li>
<li class="chapter" data-level="5.5" data-path="mod-dp.html"><a href="mod-dp.html#policy-iteration"><i class="fa fa-check"></i><b>5.5</b> Policy Iteration</a></li>
<li class="chapter" data-level="5.6" data-path="mod-dp.html"><a href="mod-dp.html#value-iteration"><i class="fa fa-check"></i><b>5.6</b> Value Iteration</a></li>
<li class="chapter" data-level="5.7" data-path="mod-dp.html"><a href="mod-dp.html#generalized-policy-iteration"><i class="fa fa-check"></i><b>5.7</b> Generalized policy iteration</a></li>
<li class="chapter" data-level="5.8" data-path="mod-dp.html"><a href="mod-dp.html#exe-dp-storage"><i class="fa fa-check"></i><b>5.8</b> Example - Factory Storage</a></li>
<li class="chapter" data-level="5.9" data-path="mod-dp.html"><a href="mod-dp.html#summary-4"><i class="fa fa-check"></i><b>5.9</b> Summary</a></li>
<li class="chapter" data-level="5.10" data-path="mod-dp.html"><a href="mod-dp.html#exercises"><i class="fa fa-check"></i><b>5.10</b> Exercises</a>
<ul>
<li class="chapter" data-level="5.10.1" data-path="mod-dp.html"><a href="mod-dp.html#ex-dp-gambler"><i class="fa fa-check"></i><b>5.10.1</b> Exercise - Gambler’s problem</a></li>
<li class="chapter" data-level="5.10.2" data-path="mod-dp.html"><a href="mod-dp.html#ex-dp-maintain"><i class="fa fa-check"></i><b>5.10.2</b> Exercise - Maintenance problem</a></li>
<li class="chapter" data-level="5.10.3" data-path="mod-dp.html"><a href="mod-dp.html#ex-dp-rental"><i class="fa fa-check"></i><b>5.10.3</b> Exercise - Car rental</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="mod-mc.html"><a href="mod-mc.html"><i class="fa fa-check"></i><b>6</b> Monte Carlo methods for prediction and control</a>
<ul>
<li class="chapter" data-level="6.1" data-path="mod-mc.html"><a href="mod-mc.html#learning-outcomes-5"><i class="fa fa-check"></i><b>6.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="6.2" data-path="mod-mc.html"><a href="mod-mc.html#textbook-readings-5"><i class="fa fa-check"></i><b>6.2</b> Textbook readings</a></li>
<li class="chapter" data-level="6.3" data-path="mod-mc.html"><a href="mod-mc.html#mc-prediction-evaluation"><i class="fa fa-check"></i><b>6.3</b> MC prediction (evaluation)</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="mod-mc.html"><a href="mod-mc.html#mc-prediction-of-action-values"><i class="fa fa-check"></i><b>6.3.1</b> MC prediction of action-values</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="mod-mc.html"><a href="mod-mc.html#mc-control-improvement"><i class="fa fa-check"></i><b>6.4</b> MC control (improvement)</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="mod-mc.html"><a href="mod-mc.html#gpi-with-exploring-starts"><i class="fa fa-check"></i><b>6.4.1</b> GPI with exploring starts</a></li>
<li class="chapter" data-level="6.4.2" data-path="mod-mc.html"><a href="mod-mc.html#gpi-using-epsilon-soft-policies"><i class="fa fa-check"></i><b>6.4.2</b> GPI using <span class="math inline">\(\epsilon\)</span>-soft policies</a></li>
<li class="chapter" data-level="6.4.3" data-path="mod-mc.html"><a href="mod-mc.html#gpi-using-upper-confience-bound-action-selection"><i class="fa fa-check"></i><b>6.4.3</b> GPI using upper-confience bound action selection</a></li>
<li class="chapter" data-level="6.4.4" data-path="mod-mc.html"><a href="mod-mc.html#mc-seasonal"><i class="fa fa-check"></i><b>6.4.4</b> Example - Seasonal inventory and sales planning</a></li>
</ul></li>
<li class="chapter" data-level="6.5" data-path="mod-mc.html"><a href="mod-mc.html#sec-mc-off-policy"><i class="fa fa-check"></i><b>6.5</b> Off-policy MC prediction</a>
<ul>
<li class="chapter" data-level="6.5.1" data-path="mod-mc.html"><a href="mod-mc.html#weighted-importance-sampling"><i class="fa fa-check"></i><b>6.5.1</b> Weighted importance sampling</a></li>
</ul></li>
<li class="chapter" data-level="6.6" data-path="mod-mc.html"><a href="mod-mc.html#off-policy-control-improvement"><i class="fa fa-check"></i><b>6.6</b> Off-policy control (improvement)</a></li>
<li class="chapter" data-level="6.7" data-path="mod-mc.html"><a href="mod-mc.html#summary-5"><i class="fa fa-check"></i><b>6.7</b> Summary</a></li>
<li class="chapter" data-level="6.8" data-path="mod-mc.html"><a href="mod-mc.html#exercises-1"><i class="fa fa-check"></i><b>6.8</b> Exercises</a>
<ul>
<li class="chapter" data-level="6.8.1" data-path="mod-mc.html"><a href="mod-mc.html#ex-mc-seasonal"><i class="fa fa-check"></i><b>6.8.1</b> Exercise - Seasonal inventory and sales planning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="mod-td-pred.html"><a href="mod-td-pred.html"><i class="fa fa-check"></i><b>7</b> Temporal difference methods for prediction</a>
<ul>
<li class="chapter" data-level="7.1" data-path="mod-td-pred.html"><a href="mod-td-pred.html#learning-outcomes-6"><i class="fa fa-check"></i><b>7.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="7.2" data-path="mod-td-pred.html"><a href="mod-td-pred.html#textbook-readings-6"><i class="fa fa-check"></i><b>7.2</b> Textbook readings</a></li>
<li class="chapter" data-level="7.3" data-path="mod-td-pred.html"><a href="mod-td-pred.html#what-is-td-learning"><i class="fa fa-check"></i><b>7.3</b> What is TD learning?</a></li>
<li class="chapter" data-level="7.4" data-path="mod-td-pred.html"><a href="mod-td-pred.html#td-prediction"><i class="fa fa-check"></i><b>7.4</b> TD prediction</a>
<ul>
<li class="chapter" data-level="7.4.1" data-path="mod-td-pred.html"><a href="mod-td-pred.html#td-prediction-for-action-values"><i class="fa fa-check"></i><b>7.4.1</b> TD prediction for action-values</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="mod-td-pred.html"><a href="mod-td-pred.html#benefits-of-td-methods"><i class="fa fa-check"></i><b>7.5</b> Benefits of TD methods</a></li>
<li class="chapter" data-level="7.6" data-path="mod-td-pred.html"><a href="mod-td-pred.html#exercises-2"><i class="fa fa-check"></i><b>7.6</b> Exercises</a>
<ul>
<li class="chapter" data-level="7.6.1" data-path="mod-td-pred.html"><a href="mod-td-pred.html#ex-td-pred-random"><i class="fa fa-check"></i><b>7.6.1</b> Exercise - A randow walk</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="mod-td-control.html"><a href="mod-td-control.html"><i class="fa fa-check"></i><b>8</b> Temporal difference methods for control</a>
<ul>
<li class="chapter" data-level="8.1" data-path="mod-td-control.html"><a href="mod-td-control.html#learning-outcomes-7"><i class="fa fa-check"></i><b>8.1</b> Learning outcomes</a></li>
<li class="chapter" data-level="8.2" data-path="mod-td-control.html"><a href="mod-td-control.html#textbook-readings-7"><i class="fa fa-check"></i><b>8.2</b> Textbook readings</a></li>
<li class="chapter" data-level="8.3" data-path="mod-td-control.html"><a href="mod-td-control.html#sarsa---on-policy-gpi-using-td"><i class="fa fa-check"></i><b>8.3</b> SARSA - On-policy GPI using TD</a></li>
<li class="chapter" data-level="8.4" data-path="mod-td-control.html"><a href="mod-td-control.html#q-learning---off-policy-gpi-using-td"><i class="fa fa-check"></i><b>8.4</b> Q-learning - Off-policy GPI using TD</a></li>
<li class="chapter" data-level="8.5" data-path="mod-td-control.html"><a href="mod-td-control.html#expected-sarsa---gpi-using-td"><i class="fa fa-check"></i><b>8.5</b> Expected SARSA - GPI using TD</a></li>
<li class="chapter" data-level="8.6" data-path="mod-td-control.html"><a href="mod-td-control.html#summary-6"><i class="fa fa-check"></i><b>8.6</b> Summary</a></li>
<li class="chapter" data-level="8.7" data-path="mod-td-control.html"><a href="mod-td-control.html#exercises-3"><i class="fa fa-check"></i><b>8.7</b> Exercises</a>
<ul>
<li class="chapter" data-level="8.7.1" data-path="mod-td-control.html"><a href="mod-td-control.html#ex-td-control-storage"><i class="fa fa-check"></i><b>8.7.1</b> Exercise - Factory Storage</a></li>
<li class="chapter" data-level="8.7.2" data-path="mod-td-control.html"><a href="mod-td-control.html#ex-td-control-car"><i class="fa fa-check"></i><b>8.7.2</b> Exercise - Car Rental</a></li>
</ul></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="mod-r-setup.html"><a href="mod-r-setup.html"><i class="fa fa-check"></i><b>A</b> Setting up R</a></li>
<li class="chapter" data-level="B" data-path="groups.html"><a href="groups.html"><i class="fa fa-check"></i><b>B</b> Working in groups</a></li>
<li class="chapter" data-level="C" data-path="coding-convention.html"><a href="coding-convention.html"><i class="fa fa-check"></i><b>C</b> Coding/naming convention</a>
<ul>
<li class="chapter" data-level="C.1" data-path="coding-convention.html"><a href="coding-convention.html#commenting-your-code"><i class="fa fa-check"></i><b>C.1</b> Commenting your code</a></li>
</ul></li>
<li class="chapter" data-level="D" data-path="annotate.html"><a href="annotate.html"><i class="fa fa-check"></i><b>D</b> Annotate the course notes</a></li>
<li class="chapter" data-level="E" data-path="help.html"><a href="help.html"><i class="fa fa-check"></i><b>E</b> Getting help</a></li>
<li class="chapter" data-level="F" data-path="mod-lg-course.html"><a href="mod-lg-course.html"><i class="fa fa-check"></i><b>F</b> Learning goals</a></li>
<li class="chapter" data-level="G" data-path="colophon.html"><a href="colophon.html"><i class="fa fa-check"></i><b>G</b> Colophon</a></li>
<li class="divider"></li>
<li><center>
  <a rel="license" href="./index.html#ack">
    License: CC BY-NC-SA<br>
    <i class = "fab fa-creative-commons fa-2x"></i>
    <i class = "fab fa-creative-commons-by fa-2x"></i>
    <i class = "fab fa-creative-commons-nc fa-2x"></i>
    <i class = "fab fa-creative-commons-sa fa-2x"></i>
  </a>
</li></center>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Reinforcement Learning for Business (RL)</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="mod-td-control" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Module 8</span> Temporal difference methods for control<a href="mod-td-control.html#mod-td-control" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>In Module <a href="mod-td-pred.html#mod-td-pred">7</a> temporal difference (TD) was used to estimate state-values. In this module we focus on improving the policy (control) by applying generalized policy iteration (GPI) using TD methods. GPI repeatedly apply policy evaluation and policy improvement. Since we do not have a model (the transition probability matrix and reward distribution are not known) all our action-values are estimates. Hence an element of exploration are needed to estimate the action-values. For convergence to the optimal policy a model-free GPI algorithm must satisfy:</p>
<ol style="list-style-type: decimal">
<li><em>Infinite exploration</em>: all state-action <span class="math inline">\((s,a)\)</span> pairs should be explored infinitely many times as the number of iterations go to infinity (in the limit), i.e. as the number of iterations <span class="math inline">\(k\)</span> goes to infinity the number of visits <span class="math inline">\(n_k\)</span> does too <span class="math display">\[\lim_{k\rightarrow\infty} n_k(s, a) = \infty.\]</span></li>
<li><em>Greedy in the limit</em>: while we maintain infinite exploration, we do eventually need to converge to the optimal policy:
<span class="math display">\[\lim_{k\rightarrow\infty} \pi_k(a|s) = 1 \text{ for } a = \arg\max_a q(s, a).\]</span></li>
</ol>
<div id="learning-outcomes-7" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Learning outcomes<a href="mod-td-control.html#learning-outcomes-7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>By the end of this module, you are expected to:</p>
<ul>
<li>Describe how generalized policy iteration (GPI) can be used with TD to find improved policies.</li>
<li>Identify the properties that must the satisfied for GPI to converge to the optimal policy.</li>
<li>Derive and explain SARSA an on-policy GPI algorithm using TD.</li>
<li>Describe the relationship between SARSA and the Bellman equations.</li>
<li>Derive and explain Q-learning an off-policy GPI algorithm using TD.</li>
<li>Argue how Q-learning can be off-policy without using importance sampling.</li>
<li>Describe the relationship between Q-learning and the Bellman optimality equations.</li>
<li>Derive and explain expected SARSA an on/off-policy GPI algorithm using TD.</li>
<li>Describe the relationship between expected SARSA and the Bellman equations.</li>
<li>Explain how expected SARSA generalizes Q-learning.</li>
<li>List the differences between Q-learning, SARSA and expected SARSA.</li>
<li>Apply the algorithms to an MDP to find the optimal policy.</li>
</ul>
<p>The learning outcomes relate to the <a href="mod-lg-course.html#mod-lg-course">overall learning goals</a> number 3, 4, 6, 9, and 12 of the course.</p>
<!-- SOLO increasing: identify · memorise · name · do simple procedure · collect data · -->
<!-- enumerate · describe · interpret · formulate · list · paraphrase · combine · do -->
<!-- algorithms · compare · contrast · explain causes · analyse · relate · derive · -->
<!-- evaluate · apply · argue · theorise · generalise · hypothesise · solve · reflect -->
</div>
<div id="textbook-readings-7" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Textbook readings<a href="mod-td-control.html#textbook-readings-7" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>For this week, you will need to read Chapter 6.4-6.6 in <span class="citation">Sutton and Barto (<a href="#ref-Sutton18">2018</a>)</span>. Read it before continuing this module. A summary of the book notation can be seen <a href="https://bss-osca.github.io/rl/misc/sutton-notation.pdf">here</a>.</p>
<div>
Slides for this module can be seen
<a href="https://bss-osca.github.io/rl/slides/08_td-control-slides.html" target="_blank">here.</a>
You do not have to look at them before the lecture!
</div>
</div>
<div id="sarsa---on-policy-gpi-using-td" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> SARSA - On-policy GPI using TD<a href="mod-td-control.html#sarsa---on-policy-gpi-using-td" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The first GPI algorithm we will consider is SARSA. Since we do not have a model we need to estimate action-values so the optimal policy can be found using <span class="math inline">\(q_*\)</span> (see Eq. <a href="mod-mdp-2.html#eq:bell-opt-state-policy">(4.3)</a>). Hence to predict action-values for a policy <span class="math inline">\(\pi\)</span>, the incremental update Eq. <a href="mod-td-pred.html#eq:td0">(7.1)</a> must be modified to use <span class="math inline">\(Q\)</span> values:
<span class="math display">\[
Q(S_t, A_t) \leftarrow Q(S_t, A_t) + \alpha \left[R_{t+1} + \gamma Q(S_{t+1}, A_{t+1}) - Q(S_t, A_t) \right]
\]</span>
Note given a policy <span class="math inline">\(\pi\)</span> you need to know <span class="math inline">\(S_t, A_t, R_{t+1}, S_{t+1}, A_{t+1}\)</span> or short SARSA before you can make an update. This acronym is used to name the algorithm.</p>
<p>The algorithm is given in Figure <a href="mod-td-control.html#fig:td-sarsa-alg">8.1</a>. To ensure infinite exploration of all action-values, we need e.g. an <span class="math inline">\(\epsilon\)</span>-greedy policy. The algorithm can also be applied for processes with continuing tasks. To ensure greedy in the limit a decreasing epsilon can be used (e.g. <span class="math inline">\(\epsilon = 1/t\)</span>). No stopping criterion is given but could stop when small differences in action-values are observed.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:td-sarsa-alg"></span>
<img src="img/td-gpi-sarsa.png" alt="SARSA - On-policy GPI using TD [@Sutton18]."  />
<p class="caption">
Figure 8.1: SARSA - On-policy GPI using TD <span class="citation">(<a href="#ref-Sutton18">Sutton and Barto 2018</a>)</span>.
</p>
</div>
<p>SARSA is a sample based algorithm that do updates based on the Bellman equation for action-values (<span class="math inline">\(q\)</span>):
<span class="math display">\[
\begin{align}
  q_\pi(s, a) &amp;= \mathbb{E}_\pi[G_t | S_t = s, A_t = a] \\
  &amp;= \mathbb{E}_\pi[R_{t+1} + \gamma G_{t+1} | S_t = s, A_t = a] \\
  &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma v_\pi(s&#39;)\right) \\
  &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma \sum_{a&#39;} \pi(a&#39;|s) q_\pi(s&#39;, a&#39;)\right).
\end{align}
\]</span>
That is, we update the estimate based on samples <span class="math inline">\(r\)</span> and the estimate <span class="math inline">\(q_\pi\)</span> in <span class="math inline">\(s&#39;\)</span>. This is the same approach as policy iteration in DP: we first calculate new estimates of <span class="math inline">\(q_\pi\)</span> given the current policy <span class="math inline">\(\pi\)</span> and then improve. Hence SARSA is a sample based version of policy iteration in DP.</p>
</div>
<div id="q-learning---off-policy-gpi-using-td" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Q-learning - Off-policy GPI using TD<a href="mod-td-control.html#q-learning---off-policy-gpi-using-td" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Q-learning resembles SARSA; however there are some differences. The algorithm is given in Figure <a href="mod-td-control.html#fig:td-q-learning-alg">8.2</a>. Note the incremental update equation is now:
<span class="math display">\[\begin{equation}
Q(S_t, A_t) \leftarrow Q(S_t, A_t) + \alpha \left[R_{t+1} + \gamma \max_{a} Q(S_{t+1}, a) - Q(S_t, A_t) \right]
\end{equation}\]</span>
That is, the next action used to update <span class="math inline">\(Q\)</span> is selected greedy. That is, we are no longer following an <span class="math inline">\(\epsilon\)</span>-greedy policy for our updates.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:td-q-learning-alg"></span>
<img src="img/td-gpi-q-learn.png" alt="Q-learning - Off-policy GPI using TD [@Sutton18]."  />
<p class="caption">
Figure 8.2: Q-learning - Off-policy GPI using TD <span class="citation">(<a href="#ref-Sutton18">Sutton and Barto 2018</a>)</span>.
</p>
</div>
<p>SARSA is an on-policy algorithm, meaning that the behavioural and target policy is the same, e.g. an <span class="math inline">\(\epsilon\)</span>-greedy policy to ensure exploration. That is, for fixed <span class="math inline">\(\epsilon\)</span> the greedy in the limit assumption is not fulfilled. Q-learning, on the other hand, is an off-policy algorithm where the behavioural policy is an <span class="math inline">\(\epsilon\)</span>-greedy and the target policy is the (deterministic) greedy policy. That is, Q-learning fulfil both the ‘infinite exploration’ and ‘greedy in the limit’ assumptions.</p>
<p>Note under MC prediction an off-policy algorithm needed to use importance sampling to estimate the action-value of the target policy (see Section <a href="mod-mc.html#sec-mc-off-policy">6.5</a>). This is not necessary for one-step TD, since
<span class="math display" id="eq:bellman-q">\[
\begin{align}
q_\pi(s,a) &amp;= \mathbb{E}_{\pi}[R_t + \gamma G_{t+1}|S_t = s, A_t = a] \\
           &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma \sum_{a&#39;} \pi(a&#39;|s) q_\pi(s&#39;, a&#39;)\right) \\
           &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma \max_{a&#39;} q_\pi(s&#39;, a&#39;)\right) \\
\end{align}
\tag{8.1}
\]</span></p>
<p>That is, because the target policy is greedy and deterministic expectation the <span class="math inline">\(G_{t+1}\)</span> becomes a maximum. Hence we can update the action-value estimates <span class="math inline">\(Q\)</span> for the target policy <span class="math inline">\(\pi\)</span> even though we sample from an <span class="math inline">\(\epsilon\)</span>-greedy behavioural policy.</p>
<p>Q-learning is a sample based algorithm that do updates based on the Bellman optimality equation for action-values (<span class="math inline">\(q_*\)</span>):
<span class="math display">\[
\begin{align}
  q_*(s, a) &amp;= \max_\pi q_\pi(s, a) \\
  &amp;= \max_\pi \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma v_\pi(s&#39;)\right) \\
  &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma \max_\pi v_\pi(s&#39;)\right) \\
  &amp;= \sum_{s&#39;,r} p(s&#39;, r | s, a) \left(r + \gamma \max_{a&#39;} q_*(s&#39;, a&#39;)\right)
\end{align}
\]</span>
That is, we update the estimate based on samples <span class="math inline">\(r\)</span> and the estimate <span class="math inline">\(q_*\)</span> in <span class="math inline">\(s&#39;\)</span>. This is the same approach as value iteration in DP: we update the estimates of <span class="math inline">\(q_\pi\)</span> and improve the policy in one operation. Hence Q-learning is a sample based version of value iteration in DP.</p>
</div>
<div id="expected-sarsa---gpi-using-td" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Expected SARSA - GPI using TD<a href="mod-td-control.html#expected-sarsa---gpi-using-td" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The expected SARSA, as SARSA, focus on the Bellman equation <a href="mod-td-control.html#eq:bellman-q">(8.1)</a>. SARSA generate action <span class="math inline">\(A_{t+1}\)</span> from the policy <span class="math inline">\(\pi\)</span> and use the estimated action-value of <span class="math inline">\((S_{t+1},A_{t+1})\)</span>. However, since we know the current policy <span class="math inline">\(\pi\)</span>, we might update based on the expected value instead:
<span class="math display">\[
Q(S_t, A_t) \leftarrow Q(S_t, A_t) + \alpha \left[R_{t+1} + \gamma \sum_{a} \pi(a | S_{t+1}) Q(S_{t+1}, a) - Q(S_t, A_t) \right] \\
\]</span>
That is, we use a better estimate of the Bellman equation <a href="mod-td-control.html#eq:bellman-q">(8.1)</a> by not sampling <span class="math inline">\(A_{t+1}\)</span> but using the (deterministic) expectation over all actions instead. Doing so reduces the variance induced by selecting random actions according to an <span class="math inline">\(\epsilon\)</span>-greedy policy. As a result, given the same amount of experiences, expected SARSA generally performs better than SARSA, but has a higher computational cost.</p>
<p>Expected SARSA is more robust to different step-size values. The incremental update formula can be written as
<span class="math display">\[
Q(S_t, A_t) \leftarrow Q(S_t, A_t) + \alpha \left[T_t - Q(S_t, A_t) \right] = (1-\alpha)Q(S_t, A_t) + \alpha T_t,
\]</span>
with step-size <span class="math inline">\(\alpha\)</span> and target <span class="math inline">\(T_t\)</span>. For SARSA the target is
<span class="math display">\[T_t = R_{t+1} + \gamma Q(S_{t+1}, A_{t+1}),\]</span>
and for expected SARSA the target is: <span class="math display">\[T_t = R_{t+1} + \gamma \sum_{a} \pi(a | S_{t+1}) Q(S_{t+1}, a).\]</span> Now assume that we have run the algorithm over many time-steps so that our estimates <span class="math inline">\(Q(S_t, A_t)\)</span> are close to <span class="math inline">\(q_*(S_t, A_t)\)</span>. Since the target in expected SARSA is deterministic (we do not sample <span class="math inline">\(A_{t+1}\)</span>), the target <span class="math inline">\(T_t \approx Q(S_t, A_t)\)</span> and no matter the step-size <span class="math inline">\(Q(S_t, A_t)\)</span> will be updated to the same value. On the other hand, the target in SARSA uses a sample action <span class="math inline">\(A_{t+1}\)</span> that might have an action-value far from the expectation. This implies that for large step-sizes <span class="math inline">\(Q(S_t, A_t)\)</span> will be updated to the target which is wrong. Hence SARSA is more sensitive to large step-sizes.</p>
<p>Expected SARSA can be both on-policy and off-policy. If the behavioural policy and the target policy are different it is off-policy. If they are the same it is on-policy. For instance, expected SARSA is off-policy if the target policy is greedy and the behavioural policy <span class="math inline">\(\epsilon\)</span>-greedy. In which case expected SARSA becomes Q-learning since the expectation of a greedy policy is the maximum value (<span class="math inline">\(\pi(s|a) = 1\)</span> here). Hence expected SARSA can be seen as a generalisation of Q-learning that improves SARSA.</p>
</div>
<div id="summary-6" class="section level2 hasAnchor" number="8.6">
<h2><span class="header-section-number">8.6</span> Summary<a href="mod-td-control.html#summary-6" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Read Chapter 6.9 in <span class="citation">Sutton and Barto (<a href="#ref-Sutton18">2018</a>)</span>.</p>
</div>
<div id="exercises-3" class="section level2 hasAnchor" number="8.7">
<h2><span class="header-section-number">8.7</span> Exercises<a href="mod-td-control.html#exercises-3" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Below you will find a set of exercises. Always have a look at the exercises before you meet in your study group and try to solve them yourself. Are you stuck, see the <a href="help.html#help">help page</a>. Sometimes solutions can be seen by pressing the button besides a question. Beware, you will not learn by giving up too early. Put some effort into finding a solution!</p>
<div id="ex-td-control-storage" class="section level3 hasAnchor" number="8.7.1">
<h3><span class="header-section-number">8.7.1</span> Exercise - Factory Storage<a href="mod-td-control.html#ex-td-control-storage" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Consider Example <a href="mod-dp.html#exe-dp-storage">5.8</a> where a factory has a storage tank with a capacity of 4 <span class="math inline">\(\mathrm{m}^{3}\)</span> for temporarily storing waste produced by the factory. Each week the factory produces <span class="math inline">\(0,1\)</span>, 2 or 3 <span class="math inline">\(\mathrm{m}^{3}\)</span> waste with respective probabilities
<span class="math display">\[p_{0}=\displaystyle \frac{1}{8},\ p_{1}=\displaystyle \frac{1}{2},\ p_{2}=\displaystyle \frac{1}{4} \text{ and } p_{3}=\displaystyle \frac{1}{8}.\]</span>
If the amount of waste produced in one week exceeds the remaining capacity of the tank, the excess is specially removed at a cost of $30 per cubic metre. At the end of each week there is a regular opportunity to remove all waste from the storage tank at a fixed cost of $25 and a variable cost of $5 per cubic metre.</p>
<p>An MDP model was formulated in Example <a href="mod-dp.html#exe-dp-storage">5.8</a> and solved using policy iteration. Our goal here is to solve the same problem with GPI using TD. For this we need an environment representing the problem:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb80-1"><a href="mod-td-control.html#cb80-1" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb80-2"><a href="mod-td-control.html#cb80-2" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb80-3"><a href="mod-td-control.html#cb80-3" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb80-4"><a href="mod-td-control.html#cb80-4" tabindex="-1"></a></span>
<span id="cb80-5"><a href="mod-td-control.html#cb80-5" tabindex="-1"></a><span class="co">#&#39; R6 Class representing the RL environment for the problem</span></span>
<span id="cb80-6"><a href="mod-td-control.html#cb80-6" tabindex="-1"></a>RLEnvFactory <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">&quot;RLEnvFactory&quot;</span>,</span>
<span id="cb80-7"><a href="mod-td-control.html#cb80-7" tabindex="-1"></a>   <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb80-8"><a href="mod-td-control.html#cb80-8" tabindex="-1"></a></span>
<span id="cb80-9"><a href="mod-td-control.html#cb80-9" tabindex="-1"></a>      <span class="co">#&#39; @field pr Probability of 0, 1, 2, and 3 m2 waste</span></span>
<span id="cb80-10"><a href="mod-td-control.html#cb80-10" tabindex="-1"></a>      <span class="at">pr =</span> <span class="fu">c</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">2</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">8</span>),</span>
<span id="cb80-11"><a href="mod-td-control.html#cb80-11" tabindex="-1"></a>      </span>
<span id="cb80-12"><a href="mod-td-control.html#cb80-12" tabindex="-1"></a>      <span class="co">#&#39; @description Return all states (keys).</span></span>
<span id="cb80-13"><a href="mod-td-control.html#cb80-13" tabindex="-1"></a>      <span class="at">getStates =</span> <span class="cf">function</span>() {</span>
<span id="cb80-14"><a href="mod-td-control.html#cb80-14" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">str_c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">4</span>))</span>
<span id="cb80-15"><a href="mod-td-control.html#cb80-15" tabindex="-1"></a>      },</span>
<span id="cb80-16"><a href="mod-td-control.html#cb80-16" tabindex="-1"></a>      </span>
<span id="cb80-17"><a href="mod-td-control.html#cb80-17" tabindex="-1"></a>      <span class="co">#&#39; @description Return all actions (keys) for a state.</span></span>
<span id="cb80-18"><a href="mod-td-control.html#cb80-18" tabindex="-1"></a>      <span class="co">#&#39; @param s State considered.</span></span>
<span id="cb80-19"><a href="mod-td-control.html#cb80-19" tabindex="-1"></a>      <span class="at">getActions =</span> <span class="cf">function</span>(s) {</span>
<span id="cb80-20"><a href="mod-td-control.html#cb80-20" tabindex="-1"></a>         <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">&quot;0&quot;</span>) <span class="fu">return</span>(<span class="st">&quot;keep&quot;</span>)</span>
<span id="cb80-21"><a href="mod-td-control.html#cb80-21" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">c</span>(<span class="st">&quot;empty&quot;</span>, <span class="st">&quot;keep&quot;</span>))</span>
<span id="cb80-22"><a href="mod-td-control.html#cb80-22" tabindex="-1"></a>      },</span>
<span id="cb80-23"><a href="mod-td-control.html#cb80-23" tabindex="-1"></a>      </span>
<span id="cb80-24"><a href="mod-td-control.html#cb80-24" tabindex="-1"></a>      <span class="co">#&#39; @description Returns the next state and reward given current state and action as a list (with names `r` and `sN`).</span></span>
<span id="cb80-25"><a href="mod-td-control.html#cb80-25" tabindex="-1"></a>      <span class="co">#&#39; @param s Current state.</span></span>
<span id="cb80-26"><a href="mod-td-control.html#cb80-26" tabindex="-1"></a>      <span class="co">#&#39; @param a Current action.</span></span>
<span id="cb80-27"><a href="mod-td-control.html#cb80-27" tabindex="-1"></a>      <span class="at">getTimeStepData =</span> <span class="cf">function</span>(s, a) {</span>
<span id="cb80-28"><a href="mod-td-control.html#cb80-28" tabindex="-1"></a>         s <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(s)</span>
<span id="cb80-29"><a href="mod-td-control.html#cb80-29" tabindex="-1"></a>         <span class="cf">if</span> (a <span class="sc">==</span> <span class="st">&quot;empty&quot;</span>) {</span>
<span id="cb80-30"><a href="mod-td-control.html#cb80-30" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">r =</span> <span class="sc">-</span>(<span class="dv">25</span> <span class="sc">+</span> <span class="dv">5</span><span class="sc">*</span>s), <span class="at">sN =</span> <span class="fu">as.character</span>(<span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="at">prob =</span> self<span class="sc">$</span>pr))))</span>
<span id="cb80-31"><a href="mod-td-control.html#cb80-31" tabindex="-1"></a>         }</span>
<span id="cb80-32"><a href="mod-td-control.html#cb80-32" tabindex="-1"></a>         <span class="cf">if</span> (a <span class="sc">==</span> <span class="st">&quot;keep&quot;</span>) {</span>
<span id="cb80-33"><a href="mod-td-control.html#cb80-33" tabindex="-1"></a>            sN <span class="ot">&lt;-</span> s <span class="sc">+</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">3</span>, <span class="dv">1</span>, <span class="at">prob =</span> self<span class="sc">$</span>pr)</span>
<span id="cb80-34"><a href="mod-td-control.html#cb80-34" tabindex="-1"></a>            rew <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb80-35"><a href="mod-td-control.html#cb80-35" tabindex="-1"></a>            <span class="cf">if</span> (sN <span class="sc">&gt;</span> <span class="dv">4</span>) {</span>
<span id="cb80-36"><a href="mod-td-control.html#cb80-36" tabindex="-1"></a>               rew <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">30</span> <span class="sc">*</span> (sN <span class="sc">-</span> <span class="dv">4</span>)</span>
<span id="cb80-37"><a href="mod-td-control.html#cb80-37" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb80-38"><a href="mod-td-control.html#cb80-38" tabindex="-1"></a>            }</span>
<span id="cb80-39"><a href="mod-td-control.html#cb80-39" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">r =</span> rew, <span class="at">sN =</span> <span class="fu">as.character</span>(sN)))</span>
<span id="cb80-40"><a href="mod-td-control.html#cb80-40" tabindex="-1"></a>         }</span>
<span id="cb80-41"><a href="mod-td-control.html#cb80-41" tabindex="-1"></a>         <span class="fu">stop</span>(<span class="st">&quot;Error finding next state and reward!&quot;</span>)</span>
<span id="cb80-42"><a href="mod-td-control.html#cb80-42" tabindex="-1"></a>      }</span>
<span id="cb80-43"><a href="mod-td-control.html#cb80-43" tabindex="-1"></a>   )</span>
<span id="cb80-44"><a href="mod-td-control.html#cb80-44" tabindex="-1"></a>)</span></code></pre></div>
<p>Note that for using the GPI algorithms in the agent class we need a method <code>getTimeStepData</code> that given a state and action return the reward and the next state.</p>
<!-- Q1 -->
<div id="pf2q17JBj9wrp3uaEifN" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="pf2q17JBj9wrp3uaEifN-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="pf2q17JBj9wrp3uaEifN-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb81"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb81-1"><a href="mod-td-control.html#cb81-1" tabindex="-1"></a>env <span class="ot">&lt;-</span> RLEnvFactory<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb81-2"><a href="mod-td-control.html#cb81-2" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;0&quot;</span>, <span class="st">&quot;keep&quot;</span>)</span>
<span id="cb81-3"><a href="mod-td-control.html#cb81-3" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb81-4"><a href="mod-td-control.html#cb81-4" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb81-5"><a href="mod-td-control.html#cb81-5" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb81-6"><a href="mod-td-control.html#cb81-6" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb81-7"><a href="mod-td-control.html#cb81-7" tabindex="-1"></a><span class="co">#&gt; [1] &quot;0&quot;</span></span>
<span id="cb81-8"><a href="mod-td-control.html#cb81-8" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;4&quot;</span>, <span class="st">&quot;keep&quot;</span>)</span>
<span id="cb81-9"><a href="mod-td-control.html#cb81-9" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb81-10"><a href="mod-td-control.html#cb81-10" tabindex="-1"></a><span class="co">#&gt; [1] -60</span></span>
<span id="cb81-11"><a href="mod-td-control.html#cb81-11" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb81-12"><a href="mod-td-control.html#cb81-12" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb81-13"><a href="mod-td-control.html#cb81-13" tabindex="-1"></a><span class="co">#&gt; [1] &quot;4&quot;</span></span>
<span id="cb81-14"><a href="mod-td-control.html#cb81-14" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;2&quot;</span>, <span class="st">&quot;empty&quot;</span>)</span>
<span id="cb81-15"><a href="mod-td-control.html#cb81-15" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb81-16"><a href="mod-td-control.html#cb81-16" tabindex="-1"></a><span class="co">#&gt; [1] -35</span></span>
<span id="cb81-17"><a href="mod-td-control.html#cb81-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb81-18"><a href="mod-td-control.html#cb81-18" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb81-19"><a href="mod-td-control.html#cb81-19" tabindex="-1"></a><span class="co">#&gt; [1] &quot;1&quot;</span></span></code></pre></div>
<p>
The method returns the next state and reward given current state and action as a list (with names <code>r</code> and <code>sN</code>).
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#pf2q17JBj9wrp3uaEifN">
Solution
</button>
<ol style="list-style-type: decimal">
<li>Consider the <code>getTimeStepData</code> method and explain what it does. Generate a reward and next state for <span class="math inline">\((s,a)\)</span> pairs (0, keep), (4, keep) and (2, empty).</li>
</ol>
<p>Next we have to add the GPI algorithms to the generic agent class:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb82-1"><a href="mod-td-control.html#cb82-1" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb82-2"><a href="mod-td-control.html#cb82-2" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb82-3"><a href="mod-td-control.html#cb82-3" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb82-4"><a href="mod-td-control.html#cb82-4" tabindex="-1"></a></span>
<span id="cb82-5"><a href="mod-td-control.html#cb82-5" tabindex="-1"></a><span class="do">## Generic RL agent for tabular data (R6 class)</span></span>
<span id="cb82-6"><a href="mod-td-control.html#cb82-6" tabindex="-1"></a>RLAgent <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">&quot;RLAgent&quot;</span>,</span>
<span id="cb82-7"><a href="mod-td-control.html#cb82-7" tabindex="-1"></a>   <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb82-8"><a href="mod-td-control.html#cb82-8" tabindex="-1"></a>      <span class="co">#&#39; @field model The model is used to represent the information we have. The</span></span>
<span id="cb82-9"><a href="mod-td-control.html#cb82-9" tabindex="-1"></a>      <span class="co">#&#39; model is represented using a hash list for the states. Each states contains </span></span>
<span id="cb82-10"><a href="mod-td-control.html#cb82-10" tabindex="-1"></a>      <span class="co">#&#39;    - A list with `actions` (a hash #&#39; list with actions).</span></span>
<span id="cb82-11"><a href="mod-td-control.html#cb82-11" tabindex="-1"></a>      <span class="co">#&#39;    - `pi` (a named vector with policy pr (only positive values).</span></span>
<span id="cb82-12"><a href="mod-td-control.html#cb82-12" tabindex="-1"></a>      <span class="co">#&#39;    - `piG` the greedy action (a string). </span></span>
<span id="cb82-13"><a href="mod-td-control.html#cb82-13" tabindex="-1"></a>      <span class="co">#&#39;    - `n` a visit counter</span></span>
<span id="cb82-14"><a href="mod-td-control.html#cb82-14" tabindex="-1"></a>      <span class="co">#&#39; The `actions` hash list contains </span></span>
<span id="cb82-15"><a href="mod-td-control.html#cb82-15" tabindex="-1"></a>      <span class="co">#&#39;    - The action-values `q`.</span></span>
<span id="cb82-16"><a href="mod-td-control.html#cb82-16" tabindex="-1"></a>      <span class="co">#&#39;    - `n` a visit counter.</span></span>
<span id="cb82-17"><a href="mod-td-control.html#cb82-17" tabindex="-1"></a>      <span class="at">model =</span> <span class="cn">NULL</span>,  </span>
<span id="cb82-18"><a href="mod-td-control.html#cb82-18" tabindex="-1"></a>      </span>
<span id="cb82-19"><a href="mod-td-control.html#cb82-19" tabindex="-1"></a>      <span class="co">#&#39; @description Create an object (when call new).</span></span>
<span id="cb82-20"><a href="mod-td-control.html#cb82-20" tabindex="-1"></a>      <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb82-21"><a href="mod-td-control.html#cb82-21" tabindex="-1"></a>         self<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="fu">hash</span>()</span>
<span id="cb82-22"><a href="mod-td-control.html#cb82-22" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-23"><a href="mod-td-control.html#cb82-23" tabindex="-1"></a>      },</span>
<span id="cb82-24"><a href="mod-td-control.html#cb82-24" tabindex="-1"></a></span>
<span id="cb82-25"><a href="mod-td-control.html#cb82-25" tabindex="-1"></a>      <span class="co">#&#39; @description Add state and action to the hash (only if not already added)</span></span>
<span id="cb82-26"><a href="mod-td-control.html#cb82-26" tabindex="-1"></a>      <span class="co">#&#39; @param s State key/string.</span></span>
<span id="cb82-27"><a href="mod-td-control.html#cb82-27" tabindex="-1"></a>      <span class="co">#&#39; @param a Action key/string.</span></span>
<span id="cb82-28"><a href="mod-td-control.html#cb82-28" tabindex="-1"></a>      <span class="at">addStateAction =</span> <span class="cf">function</span>(s, a) {</span>
<span id="cb82-29"><a href="mod-td-control.html#cb82-29" tabindex="-1"></a>         <span class="cf">if</span> (<span class="sc">!</span><span class="fu">has.key</span>(s, self<span class="sc">$</span>model)) <span class="fu">addStates</span>(s)</span>
<span id="cb82-30"><a href="mod-td-control.html#cb82-30" tabindex="-1"></a>         <span class="cf">if</span> (<span class="sc">!</span><span class="fu">has.key</span>(a, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">q =</span> <span class="dv">0</span>, <span class="at">n =</span> <span class="dv">0</span>)</span>
<span id="cb82-31"><a href="mod-td-control.html#cb82-31" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-32"><a href="mod-td-control.html#cb82-32" tabindex="-1"></a>      },</span>
<span id="cb82-33"><a href="mod-td-control.html#cb82-33" tabindex="-1"></a>      </span>
<span id="cb82-34"><a href="mod-td-control.html#cb82-34" tabindex="-1"></a>      <span class="co">#&#39; @description Add the states (keys) and define void policy and empty action hash. </span></span>
<span id="cb82-35"><a href="mod-td-control.html#cb82-35" tabindex="-1"></a>      <span class="co">#&#39; @param states A vector of states (converted to strings).</span></span>
<span id="cb82-36"><a href="mod-td-control.html#cb82-36" tabindex="-1"></a>      <span class="at">addStates =</span> <span class="cf">function</span>(states) {</span>
<span id="cb82-37"><a href="mod-td-control.html#cb82-37" tabindex="-1"></a>         keys <span class="ot">&lt;-</span> <span class="fu">make.keys</span>(states)</span>
<span id="cb82-38"><a href="mod-td-control.html#cb82-38" tabindex="-1"></a>         self<span class="sc">$</span>model[keys] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">pi =</span> <span class="cn">NA</span>)   <span class="co"># don&#39;t use pi = NULL since then won&#39;t be defined </span></span>
<span id="cb82-39"><a href="mod-td-control.html#cb82-39" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> keys) {</span>
<span id="cb82-40"><a href="mod-td-control.html#cb82-40" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb82-41"><a href="mod-td-control.html#cb82-41" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions <span class="ot">&lt;-</span> <span class="fu">hash</span>()</span>
<span id="cb82-42"><a href="mod-td-control.html#cb82-42" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># counter visited</span></span>
<span id="cb82-43"><a href="mod-td-control.html#cb82-43" tabindex="-1"></a>         }</span>
<span id="cb82-44"><a href="mod-td-control.html#cb82-44" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-45"><a href="mod-td-control.html#cb82-45" tabindex="-1"></a>      },</span>
<span id="cb82-46"><a href="mod-td-control.html#cb82-46" tabindex="-1"></a>      </span>
<span id="cb82-47"><a href="mod-td-control.html#cb82-47" tabindex="-1"></a>      <span class="co">#&#39; @description Add the actions to a state</span></span>
<span id="cb82-48"><a href="mod-td-control.html#cb82-48" tabindex="-1"></a>      <span class="co">#&#39; @param s State (key).</span></span>
<span id="cb82-49"><a href="mod-td-control.html#cb82-49" tabindex="-1"></a>      <span class="co">#&#39; @param actions A vector of actions (converted to strings).</span></span>
<span id="cb82-50"><a href="mod-td-control.html#cb82-50" tabindex="-1"></a>      <span class="at">addActions =</span> <span class="cf">function</span>(s, actions) {</span>
<span id="cb82-51"><a href="mod-td-control.html#cb82-51" tabindex="-1"></a>         keys <span class="ot">&lt;-</span> <span class="fu">make.keys</span>(actions)</span>
<span id="cb82-52"><a href="mod-td-control.html#cb82-52" tabindex="-1"></a>         <span class="cf">for</span> (a <span class="cf">in</span> keys) {</span>
<span id="cb82-53"><a href="mod-td-control.html#cb82-53" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">addStateAction</span>(s, a)</span>
<span id="cb82-54"><a href="mod-td-control.html#cb82-54" tabindex="-1"></a>         }</span>
<span id="cb82-55"><a href="mod-td-control.html#cb82-55" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-56"><a href="mod-td-control.html#cb82-56" tabindex="-1"></a>      },</span>
<span id="cb82-57"><a href="mod-td-control.html#cb82-57" tabindex="-1"></a>      </span>
<span id="cb82-58"><a href="mod-td-control.html#cb82-58" tabindex="-1"></a>      <span class="co">#&#39; @description Add states and actions to the hash with initial values. If already exists nothing happens. </span></span>
<span id="cb82-59"><a href="mod-td-control.html#cb82-59" tabindex="-1"></a>      <span class="co">#&#39; @param df A tibble with string columns `s` (states) and `a` (actions).</span></span>
<span id="cb82-60"><a href="mod-td-control.html#cb82-60" tabindex="-1"></a>      <span class="at">addStatesAndActions =</span> <span class="cf">function</span>(df) {</span>
<span id="cb82-61"><a href="mod-td-control.html#cb82-61" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb82-62"><a href="mod-td-control.html#cb82-62" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">addStateAction</span>(df<span class="sc">$</span>s[i], df<span class="sc">$</span>a[i])</span>
<span id="cb82-63"><a href="mod-td-control.html#cb82-63" tabindex="-1"></a>         }</span>
<span id="cb82-64"><a href="mod-td-control.html#cb82-64" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-65"><a href="mod-td-control.html#cb82-65" tabindex="-1"></a>      },</span>
<span id="cb82-66"><a href="mod-td-control.html#cb82-66" tabindex="-1"></a>      </span>
<span id="cb82-67"><a href="mod-td-control.html#cb82-67" tabindex="-1"></a>      <span class="co">#&#39; @description Set the action-values for all actions.</span></span>
<span id="cb82-68"><a href="mod-td-control.html#cb82-68" tabindex="-1"></a>      <span class="co">#&#39; @param value The value.</span></span>
<span id="cb82-69"><a href="mod-td-control.html#cb82-69" tabindex="-1"></a>      <span class="at">setActionValue =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">0</span>) {</span>
<span id="cb82-70"><a href="mod-td-control.html#cb82-70" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb82-71"><a href="mod-td-control.html#cb82-71" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) {</span>
<span id="cb82-72"><a href="mod-td-control.html#cb82-72" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">=</span> value</span>
<span id="cb82-73"><a href="mod-td-control.html#cb82-73" tabindex="-1"></a>            }</span>
<span id="cb82-74"><a href="mod-td-control.html#cb82-74" tabindex="-1"></a>         }</span>
<span id="cb82-75"><a href="mod-td-control.html#cb82-75" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-76"><a href="mod-td-control.html#cb82-76" tabindex="-1"></a>      },</span>
<span id="cb82-77"><a href="mod-td-control.html#cb82-77" tabindex="-1"></a>      </span>
<span id="cb82-78"><a href="mod-td-control.html#cb82-78" tabindex="-1"></a>      <span class="co">#&#39; @description Set the state-value of states</span></span>
<span id="cb82-79"><a href="mod-td-control.html#cb82-79" tabindex="-1"></a>      <span class="co">#&#39; @param states A vector of states.</span></span>
<span id="cb82-80"><a href="mod-td-control.html#cb82-80" tabindex="-1"></a>      <span class="co">#&#39; @param value The value.</span></span>
<span id="cb82-81"><a href="mod-td-control.html#cb82-81" tabindex="-1"></a>      <span class="at">setStateValue =</span> <span class="cf">function</span>(<span class="at">states =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model), <span class="at">value =</span> <span class="dv">0</span>) {</span>
<span id="cb82-82"><a href="mod-td-control.html#cb82-82" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-83"><a href="mod-td-control.html#cb82-83" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> value</span>
<span id="cb82-84"><a href="mod-td-control.html#cb82-84" tabindex="-1"></a>         }</span>
<span id="cb82-85"><a href="mod-td-control.html#cb82-85" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-86"><a href="mod-td-control.html#cb82-86" tabindex="-1"></a>      },</span>
<span id="cb82-87"><a href="mod-td-control.html#cb82-87" tabindex="-1"></a>      </span>
<span id="cb82-88"><a href="mod-td-control.html#cb82-88" tabindex="-1"></a>      <span class="co">#&#39; @description Set the action visit counter values for all actions.</span></span>
<span id="cb82-89"><a href="mod-td-control.html#cb82-89" tabindex="-1"></a>      <span class="co">#&#39; @param ctrValue Counter value.</span></span>
<span id="cb82-90"><a href="mod-td-control.html#cb82-90" tabindex="-1"></a>      <span class="at">setActionCtrValue =</span> <span class="cf">function</span>(<span class="at">ctrValue =</span> <span class="dv">0</span>) {</span>
<span id="cb82-91"><a href="mod-td-control.html#cb82-91" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb82-92"><a href="mod-td-control.html#cb82-92" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) {</span>
<span id="cb82-93"><a href="mod-td-control.html#cb82-93" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb82-94"><a href="mod-td-control.html#cb82-94" tabindex="-1"></a>            }</span>
<span id="cb82-95"><a href="mod-td-control.html#cb82-95" tabindex="-1"></a>         }</span>
<span id="cb82-96"><a href="mod-td-control.html#cb82-96" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-97"><a href="mod-td-control.html#cb82-97" tabindex="-1"></a>      },</span>
<span id="cb82-98"><a href="mod-td-control.html#cb82-98" tabindex="-1"></a>      </span>
<span id="cb82-99"><a href="mod-td-control.html#cb82-99" tabindex="-1"></a>      <span class="co">#&#39; @description Set the action-values for a single action (including the counter values).</span></span>
<span id="cb82-100"><a href="mod-td-control.html#cb82-100" tabindex="-1"></a>      <span class="co">#&#39; @param value The value.</span></span>
<span id="cb82-101"><a href="mod-td-control.html#cb82-101" tabindex="-1"></a>      <span class="co">#&#39; @param ctrValue Counter value.</span></span>
<span id="cb82-102"><a href="mod-td-control.html#cb82-102" tabindex="-1"></a>      <span class="at">setActionValueSingle =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">0</span>, <span class="at">ctrValue =</span> <span class="dv">0</span>, s, a) {</span>
<span id="cb82-103"><a href="mod-td-control.html#cb82-103" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">=</span> value</span>
<span id="cb82-104"><a href="mod-td-control.html#cb82-104" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb82-105"><a href="mod-td-control.html#cb82-105" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-106"><a href="mod-td-control.html#cb82-106" tabindex="-1"></a>      },</span>
<span id="cb82-107"><a href="mod-td-control.html#cb82-107" tabindex="-1"></a>      </span>
<span id="cb82-108"><a href="mod-td-control.html#cb82-108" tabindex="-1"></a>      <span class="co">#&#39; @description Set the policy to a random epsilon-greedy policy.</span></span>
<span id="cb82-109"><a href="mod-td-control.html#cb82-109" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used in epsilon-greedy policy.</span></span>
<span id="cb82-110"><a href="mod-td-control.html#cb82-110" tabindex="-1"></a>      <span class="at">setRandomEpsGreedyPolicy =</span> <span class="cf">function</span>(eps) {</span>
<span id="cb82-111"><a href="mod-td-control.html#cb82-111" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb82-112"><a href="mod-td-control.html#cb82-112" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-113"><a href="mod-td-control.html#cb82-113" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb82-114"><a href="mod-td-control.html#cb82-114" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(actions), <span class="fu">length</span>(actions))</span>
<span id="cb82-115"><a href="mod-td-control.html#cb82-115" tabindex="-1"></a>            <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi) <span class="ot">&lt;-</span> actions</span>
<span id="cb82-116"><a href="mod-td-control.html#cb82-116" tabindex="-1"></a>            piG <span class="ot">&lt;-</span> <span class="fu">sample</span>(self<span class="sc">$</span><span class="fu">getActionKeys</span>(s), <span class="dv">1</span>)</span>
<span id="cb82-117"><a href="mod-td-control.html#cb82-117" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[piG] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[piG] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb82-118"><a href="mod-td-control.html#cb82-118" tabindex="-1"></a>         }</span>
<span id="cb82-119"><a href="mod-td-control.html#cb82-119" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-120"><a href="mod-td-control.html#cb82-120" tabindex="-1"></a>      },</span>
<span id="cb82-121"><a href="mod-td-control.html#cb82-121" tabindex="-1"></a>      </span>
<span id="cb82-122"><a href="mod-td-control.html#cb82-122" tabindex="-1"></a>      <span class="co">#&#39; @description Set the policy to the optimal epsilon-greedy policy </span></span>
<span id="cb82-123"><a href="mod-td-control.html#cb82-123" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used in epsilon-greedy policy.</span></span>
<span id="cb82-124"><a href="mod-td-control.html#cb82-124" tabindex="-1"></a>      <span class="co">#&#39; @param states States under consideration.</span></span>
<span id="cb82-125"><a href="mod-td-control.html#cb82-125" tabindex="-1"></a>      <span class="at">setEpsGreedyPolicy =</span> <span class="cf">function</span>(eps, states) {</span>
<span id="cb82-126"><a href="mod-td-control.html#cb82-126" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-127"><a href="mod-td-control.html#cb82-127" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb82-128"><a href="mod-td-control.html#cb82-128" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(actions), <span class="fu">length</span>(actions))</span>
<span id="cb82-129"><a href="mod-td-control.html#cb82-129" tabindex="-1"></a>            <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi) <span class="ot">&lt;-</span> actions</span>
<span id="cb82-130"><a href="mod-td-control.html#cb82-130" tabindex="-1"></a>            idx <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">which.is.max</span>(<span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,]))  <span class="co"># choose among max values at random</span></span>
<span id="cb82-131"><a href="mod-td-control.html#cb82-131" tabindex="-1"></a>            <span class="co"># idx &lt;- which.max(unlist(values(self$model[[s]]$actions)[&quot;q&quot;,]))  # choose first max </span></span>
<span id="cb82-132"><a href="mod-td-control.html#cb82-132" tabindex="-1"></a>            <span class="co"># self$model[[s]]$piG &lt;- actions[idx]</span></span>
<span id="cb82-133"><a href="mod-td-control.html#cb82-133" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[idx] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[idx] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb82-134"><a href="mod-td-control.html#cb82-134" tabindex="-1"></a>         }</span>
<span id="cb82-135"><a href="mod-td-control.html#cb82-135" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-136"><a href="mod-td-control.html#cb82-136" tabindex="-1"></a>      },</span>
<span id="cb82-137"><a href="mod-td-control.html#cb82-137" tabindex="-1"></a>      </span>
<span id="cb82-138"><a href="mod-td-control.html#cb82-138" tabindex="-1"></a>      <span class="co">#&#39; @description Set the greedy policy based on action-values. </span></span>
<span id="cb82-139"><a href="mod-td-control.html#cb82-139" tabindex="-1"></a>      <span class="co">#&#39; @param states States under consideration.</span></span>
<span id="cb82-140"><a href="mod-td-control.html#cb82-140" tabindex="-1"></a>      <span class="at">setGreedyPolicy =</span> <span class="cf">function</span>(<span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb82-141"><a href="mod-td-control.html#cb82-141" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-142"><a href="mod-td-control.html#cb82-142" tabindex="-1"></a>            pi <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb82-143"><a href="mod-td-control.html#cb82-143" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb82-144"><a href="mod-td-control.html#cb82-144" tabindex="-1"></a>            <span class="co"># idx &lt;- nnet::which.is.max(unlist(values(self$model[[s]]$actions)[&quot;q&quot;,]))  # choose among max values at random</span></span>
<span id="cb82-145"><a href="mod-td-control.html#cb82-145" tabindex="-1"></a>            idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,]))  <span class="co"># choose first max</span></span>
<span id="cb82-146"><a href="mod-td-control.html#cb82-146" tabindex="-1"></a>            <span class="fu">names</span>(pi) <span class="ot">&lt;-</span> actions[idx]</span>
<span id="cb82-147"><a href="mod-td-control.html#cb82-147" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> pi</span>
<span id="cb82-148"><a href="mod-td-control.html#cb82-148" tabindex="-1"></a>         }</span>
<span id="cb82-149"><a href="mod-td-control.html#cb82-149" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-150"><a href="mod-td-control.html#cb82-150" tabindex="-1"></a>      },</span>
<span id="cb82-151"><a href="mod-td-control.html#cb82-151" tabindex="-1"></a>      </span>
<span id="cb82-152"><a href="mod-td-control.html#cb82-152" tabindex="-1"></a>      <span class="co">#&#39; @description Set the policy to the named vector pi for a set of states</span></span>
<span id="cb82-153"><a href="mod-td-control.html#cb82-153" tabindex="-1"></a>      <span class="co">#&#39; @param states States under consideration.</span></span>
<span id="cb82-154"><a href="mod-td-control.html#cb82-154" tabindex="-1"></a>      <span class="co">#&#39; @param pi A named vector with policy pr (only psitive values).</span></span>
<span id="cb82-155"><a href="mod-td-control.html#cb82-155" tabindex="-1"></a>      <span class="at">setPolicy =</span> <span class="cf">function</span>(states, pi) {</span>
<span id="cb82-156"><a href="mod-td-control.html#cb82-156" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-157"><a href="mod-td-control.html#cb82-157" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> pi</span>
<span id="cb82-158"><a href="mod-td-control.html#cb82-158" tabindex="-1"></a>         }</span>
<span id="cb82-159"><a href="mod-td-control.html#cb82-159" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-160"><a href="mod-td-control.html#cb82-160" tabindex="-1"></a>      },</span>
<span id="cb82-161"><a href="mod-td-control.html#cb82-161" tabindex="-1"></a>      </span>
<span id="cb82-162"><a href="mod-td-control.html#cb82-162" tabindex="-1"></a>      <span class="co">#&#39; @description Set the state visit counter values for all states.</span></span>
<span id="cb82-163"><a href="mod-td-control.html#cb82-163" tabindex="-1"></a>      <span class="co">#&#39; @param ctrValue Counter value.</span></span>
<span id="cb82-164"><a href="mod-td-control.html#cb82-164" tabindex="-1"></a>      <span class="at">setStateCtrValue =</span> <span class="cf">function</span>(<span class="at">ctrValue =</span> <span class="dv">0</span>) {</span>
<span id="cb82-165"><a href="mod-td-control.html#cb82-165" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb82-166"><a href="mod-td-control.html#cb82-166" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb82-167"><a href="mod-td-control.html#cb82-167" tabindex="-1"></a>         }</span>
<span id="cb82-168"><a href="mod-td-control.html#cb82-168" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-169"><a href="mod-td-control.html#cb82-169" tabindex="-1"></a>      },</span>
<span id="cb82-170"><a href="mod-td-control.html#cb82-170" tabindex="-1"></a>      </span>
<span id="cb82-171"><a href="mod-td-control.html#cb82-171" tabindex="-1"></a>      <span class="co">#&#39; @description Return the state keys</span></span>
<span id="cb82-172"><a href="mod-td-control.html#cb82-172" tabindex="-1"></a>      <span class="at">getStateKeys =</span> <span class="cf">function</span>() {</span>
<span id="cb82-173"><a href="mod-td-control.html#cb82-173" tabindex="-1"></a>         <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb82-174"><a href="mod-td-control.html#cb82-174" tabindex="-1"></a>      },</span>
<span id="cb82-175"><a href="mod-td-control.html#cb82-175" tabindex="-1"></a>      </span>
<span id="cb82-176"><a href="mod-td-control.html#cb82-176" tabindex="-1"></a>      <span class="co">#&#39; @description Return the state-value for a state and policy using the q/action-values </span></span>
<span id="cb82-177"><a href="mod-td-control.html#cb82-177" tabindex="-1"></a>      <span class="co">#&#39; @param s A state.</span></span>
<span id="cb82-178"><a href="mod-td-control.html#cb82-178" tabindex="-1"></a>      <span class="at">getStateValueQ =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-179"><a href="mod-td-control.html#cb82-179" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb82-180"><a href="mod-td-control.html#cb82-180" tabindex="-1"></a>         <span class="co"># print(pi)</span></span>
<span id="cb82-181"><a href="mod-td-control.html#cb82-181" tabindex="-1"></a>         val <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-182"><a href="mod-td-control.html#cb82-182" tabindex="-1"></a>         <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">names</span>(pi)) {</span>
<span id="cb82-183"><a href="mod-td-control.html#cb82-183" tabindex="-1"></a>            val <span class="ot">&lt;-</span> val <span class="sc">+</span> pi[a] <span class="sc">*</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb82-184"><a href="mod-td-control.html#cb82-184" tabindex="-1"></a>            <span class="co"># print(self$model[[s]]$actions[[a]]$q)</span></span>
<span id="cb82-185"><a href="mod-td-control.html#cb82-185" tabindex="-1"></a>         }</span>
<span id="cb82-186"><a href="mod-td-control.html#cb82-186" tabindex="-1"></a>         <span class="co"># print(val)</span></span>
<span id="cb82-187"><a href="mod-td-control.html#cb82-187" tabindex="-1"></a>         <span class="fu">return</span>(val)</span>
<span id="cb82-188"><a href="mod-td-control.html#cb82-188" tabindex="-1"></a>      },</span>
<span id="cb82-189"><a href="mod-td-control.html#cb82-189" tabindex="-1"></a>      </span>
<span id="cb82-190"><a href="mod-td-control.html#cb82-190" tabindex="-1"></a>      <span class="co">#&#39; @description Return the state-values as a tibble</span></span>
<span id="cb82-191"><a href="mod-td-control.html#cb82-191" tabindex="-1"></a>      <span class="co">#&#39; @param s A vector of state keys.</span></span>
<span id="cb82-192"><a href="mod-td-control.html#cb82-192" tabindex="-1"></a>      <span class="at">getStateValues =</span> <span class="cf">function</span>(<span class="at">s =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb82-193"><a href="mod-td-control.html#cb82-193" tabindex="-1"></a>         <span class="fu">tibble</span>(<span class="at">state =</span> s) <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">v =</span> self<span class="sc">$</span>model[[state]]<span class="sc">$</span>v) </span>
<span id="cb82-194"><a href="mod-td-control.html#cb82-194" tabindex="-1"></a>      },</span>
<span id="cb82-195"><a href="mod-td-control.html#cb82-195" tabindex="-1"></a>      </span>
<span id="cb82-196"><a href="mod-td-control.html#cb82-196" tabindex="-1"></a>      <span class="co">#&#39; @description Return the action keys</span></span>
<span id="cb82-197"><a href="mod-td-control.html#cb82-197" tabindex="-1"></a>      <span class="co">#&#39; @param s The state considered.</span></span>
<span id="cb82-198"><a href="mod-td-control.html#cb82-198" tabindex="-1"></a>      <span class="at">getActionKeys =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-199"><a href="mod-td-control.html#cb82-199" tabindex="-1"></a>         <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions) </span>
<span id="cb82-200"><a href="mod-td-control.html#cb82-200" tabindex="-1"></a>      },</span>
<span id="cb82-201"><a href="mod-td-control.html#cb82-201" tabindex="-1"></a>      </span>
<span id="cb82-202"><a href="mod-td-control.html#cb82-202" tabindex="-1"></a>      <span class="co">#&#39; @description Return information about actions stored in a state</span></span>
<span id="cb82-203"><a href="mod-td-control.html#cb82-203" tabindex="-1"></a>      <span class="co">#&#39; @param s The state considered.</span></span>
<span id="cb82-204"><a href="mod-td-control.html#cb82-204" tabindex="-1"></a>      <span class="at">getActionInfo =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-205"><a href="mod-td-control.html#cb82-205" tabindex="-1"></a>         <span class="fu">as.list</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions) </span>
<span id="cb82-206"><a href="mod-td-control.html#cb82-206" tabindex="-1"></a>      },</span>
<span id="cb82-207"><a href="mod-td-control.html#cb82-207" tabindex="-1"></a>      </span>
<span id="cb82-208"><a href="mod-td-control.html#cb82-208" tabindex="-1"></a>      <span class="co">#&#39; @description Return the current policy as a tibble</span></span>
<span id="cb82-209"><a href="mod-td-control.html#cb82-209" tabindex="-1"></a>      <span class="at">getPolicy =</span> <span class="cf">function</span>(<span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb82-210"><a href="mod-td-control.html#cb82-210" tabindex="-1"></a>         <span class="fu">map_dfr</span>(states, <span class="at">.f =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-211"><a href="mod-td-control.html#cb82-211" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> s, <span class="at">action =</span> <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi), <span class="at">pr =</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi)</span>
<span id="cb82-212"><a href="mod-td-control.html#cb82-212" tabindex="-1"></a>            })</span>
<span id="cb82-213"><a href="mod-td-control.html#cb82-213" tabindex="-1"></a>      },</span>
<span id="cb82-214"><a href="mod-td-control.html#cb82-214" tabindex="-1"></a>      </span>
<span id="cb82-215"><a href="mod-td-control.html#cb82-215" tabindex="-1"></a>      <span class="co">#&#39; @description Returns all action-values in a matrix (cols: actions, rows: states)</span></span>
<span id="cb82-216"><a href="mod-td-control.html#cb82-216" tabindex="-1"></a>      <span class="at">getStateActionQMat =</span> <span class="cf">function</span>() {</span>
<span id="cb82-217"><a href="mod-td-control.html#cb82-217" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb82-218"><a href="mod-td-control.html#cb82-218" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">sapply</span>(states, <span class="cf">function</span>(s) self<span class="sc">$</span><span class="fu">getActionKeys</span>(s))))</span>
<span id="cb82-219"><a href="mod-td-control.html#cb82-219" tabindex="-1"></a>         m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(states), <span class="at">ncol =</span> <span class="fu">length</span>(actions))</span>
<span id="cb82-220"><a href="mod-td-control.html#cb82-220" tabindex="-1"></a>         <span class="fu">colnames</span>(m) <span class="ot">&lt;-</span> actions</span>
<span id="cb82-221"><a href="mod-td-control.html#cb82-221" tabindex="-1"></a>         <span class="fu">rownames</span>(m) <span class="ot">&lt;-</span> states</span>
<span id="cb82-222"><a href="mod-td-control.html#cb82-222" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb82-223"><a href="mod-td-control.html#cb82-223" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)) {</span>
<span id="cb82-224"><a href="mod-td-control.html#cb82-224" tabindex="-1"></a>               m[s, a] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb82-225"><a href="mod-td-control.html#cb82-225" tabindex="-1"></a>            }</span>
<span id="cb82-226"><a href="mod-td-control.html#cb82-226" tabindex="-1"></a>         }</span>
<span id="cb82-227"><a href="mod-td-control.html#cb82-227" tabindex="-1"></a>         <span class="fu">return</span>(m)</span>
<span id="cb82-228"><a href="mod-td-control.html#cb82-228" tabindex="-1"></a>      },</span>
<span id="cb82-229"><a href="mod-td-control.html#cb82-229" tabindex="-1"></a>      </span>
<span id="cb82-230"><a href="mod-td-control.html#cb82-230" tabindex="-1"></a>      <span class="co">#&#39; @description Return the action-values as a tibble</span></span>
<span id="cb82-231"><a href="mod-td-control.html#cb82-231" tabindex="-1"></a>      <span class="co">#&#39; @param states A vector of state keys.</span></span>
<span id="cb82-232"><a href="mod-td-control.html#cb82-232" tabindex="-1"></a>      <span class="at">getActionValues =</span> <span class="cf">function</span>(<span class="at">states =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb82-233"><a href="mod-td-control.html#cb82-233" tabindex="-1"></a>         <span class="fu">map_dfr</span>(states, <span class="at">.f =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-234"><a href="mod-td-control.html#cb82-234" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> s, <span class="at">action =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions), <span class="at">q =</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,]), <span class="at">n =</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;n&quot;</span>,]))</span>
<span id="cb82-235"><a href="mod-td-control.html#cb82-235" tabindex="-1"></a>            })</span>
<span id="cb82-236"><a href="mod-td-control.html#cb82-236" tabindex="-1"></a>      },</span>
<span id="cb82-237"><a href="mod-td-control.html#cb82-237" tabindex="-1"></a>      </span>
<span id="cb82-238"><a href="mod-td-control.html#cb82-238" tabindex="-1"></a>      <span class="co">#&#39; @description Select next action using upper-confidence bound. Also update the visit counters for both state and selected action.</span></span>
<span id="cb82-239"><a href="mod-td-control.html#cb82-239" tabindex="-1"></a>      <span class="co">#&#39; @return Action.</span></span>
<span id="cb82-240"><a href="mod-td-control.html#cb82-240" tabindex="-1"></a>      <span class="at">getActionUCB =</span> <span class="cf">function</span>(s, <span class="at">coeff =</span> <span class="dv">1</span>) { </span>
<span id="cb82-241"><a href="mod-td-control.html#cb82-241" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb82-242"><a href="mod-td-control.html#cb82-242" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb82-243"><a href="mod-td-control.html#cb82-243" tabindex="-1"></a>         qV <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,])</span>
<span id="cb82-244"><a href="mod-td-control.html#cb82-244" tabindex="-1"></a>         nA <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;n&quot;</span>,])</span>
<span id="cb82-245"><a href="mod-td-control.html#cb82-245" tabindex="-1"></a>         nS <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n</span>
<span id="cb82-246"><a href="mod-td-control.html#cb82-246" tabindex="-1"></a>         val <span class="ot">&lt;-</span> qV <span class="sc">+</span> coeff <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">log</span>(nS <span class="sc">+</span> <span class="fl">0.0001</span>)<span class="sc">/</span>nA)</span>
<span id="cb82-247"><a href="mod-td-control.html#cb82-247" tabindex="-1"></a>         idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(val)</span>
<span id="cb82-248"><a href="mod-td-control.html#cb82-248" tabindex="-1"></a>         a <span class="ot">&lt;-</span> actions[idx]</span>
<span id="cb82-249"><a href="mod-td-control.html#cb82-249" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb82-250"><a href="mod-td-control.html#cb82-250" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb82-251"><a href="mod-td-control.html#cb82-251" tabindex="-1"></a>      },</span>
<span id="cb82-252"><a href="mod-td-control.html#cb82-252" tabindex="-1"></a>      </span>
<span id="cb82-253"><a href="mod-td-control.html#cb82-253" tabindex="-1"></a>      <span class="co">#&#39; @description Select next action using epsilon-greedy policy based on action-values. Also update the visit counters for both state and selected action.</span></span>
<span id="cb82-254"><a href="mod-td-control.html#cb82-254" tabindex="-1"></a>      <span class="co">#&#39; @return Action.</span></span>
<span id="cb82-255"><a href="mod-td-control.html#cb82-255" tabindex="-1"></a>      <span class="at">getActionEG =</span> <span class="cf">function</span>(s, eps) {</span>
<span id="cb82-256"><a href="mod-td-control.html#cb82-256" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb82-257"><a href="mod-td-control.html#cb82-257" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,])</span>
<span id="cb82-258"><a href="mod-td-control.html#cb82-258" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb82-259"><a href="mod-td-control.html#cb82-259" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(q), <span class="fu">length</span>(q))</span>
<span id="cb82-260"><a href="mod-td-control.html#cb82-260" tabindex="-1"></a>         idx <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">which.is.max</span>(q)  <span class="co"># choose among max values at random</span></span>
<span id="cb82-261"><a href="mod-td-control.html#cb82-261" tabindex="-1"></a>         <span class="co"># idx &lt;- which.max(unlist(values(self$model[[s]]$actions)[&quot;q&quot;,]))  # choose first max </span></span>
<span id="cb82-262"><a href="mod-td-control.html#cb82-262" tabindex="-1"></a>         pi[idx] <span class="ot">&lt;-</span> pi[idx] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb82-263"><a href="mod-td-control.html#cb82-263" tabindex="-1"></a>         a <span class="ot">&lt;-</span> actions[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(actions), <span class="dv">1</span>, <span class="at">prob =</span> pi)]</span>
<span id="cb82-264"><a href="mod-td-control.html#cb82-264" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb82-265"><a href="mod-td-control.html#cb82-265" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb82-266"><a href="mod-td-control.html#cb82-266" tabindex="-1"></a>      },</span>
<span id="cb82-267"><a href="mod-td-control.html#cb82-267" tabindex="-1"></a>      </span>
<span id="cb82-268"><a href="mod-td-control.html#cb82-268" tabindex="-1"></a>      <span class="co">#&#39; @description Find maximum action value in a state.</span></span>
<span id="cb82-269"><a href="mod-td-control.html#cb82-269" tabindex="-1"></a>      <span class="co">#&#39; @return Value.</span></span>
<span id="cb82-270"><a href="mod-td-control.html#cb82-270" tabindex="-1"></a>      <span class="at">getMaxActionValue =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-271"><a href="mod-td-control.html#cb82-271" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">&quot;q&quot;</span>,])</span>
<span id="cb82-272"><a href="mod-td-control.html#cb82-272" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">max</span>(q))</span>
<span id="cb82-273"><a href="mod-td-control.html#cb82-273" tabindex="-1"></a>      },</span>
<span id="cb82-274"><a href="mod-td-control.html#cb82-274" tabindex="-1"></a>      </span>
<span id="cb82-275"><a href="mod-td-control.html#cb82-275" tabindex="-1"></a>      <span class="co">#&#39; @description Find expected action value in a state based on current policy</span></span>
<span id="cb82-276"><a href="mod-td-control.html#cb82-276" tabindex="-1"></a>      <span class="co">#&#39; @return Value.</span></span>
<span id="cb82-277"><a href="mod-td-control.html#cb82-277" tabindex="-1"></a>      <span class="at">getExpActionValue =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-278"><a href="mod-td-control.html#cb82-278" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb82-279"><a href="mod-td-control.html#cb82-279" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">names</span>(pi)</span>
<span id="cb82-280"><a href="mod-td-control.html#cb82-280" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(pi)) {</span>
<span id="cb82-281"><a href="mod-td-control.html#cb82-281" tabindex="-1"></a>            pi[i] <span class="ot">&lt;-</span> pi[i] <span class="sc">*</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a[i]]]<span class="sc">$</span>q</span>
<span id="cb82-282"><a href="mod-td-control.html#cb82-282" tabindex="-1"></a>         }</span>
<span id="cb82-283"><a href="mod-td-control.html#cb82-283" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">sum</span>(pi))</span>
<span id="cb82-284"><a href="mod-td-control.html#cb82-284" tabindex="-1"></a>      },</span>
<span id="cb82-285"><a href="mod-td-control.html#cb82-285" tabindex="-1"></a>      </span>
<span id="cb82-286"><a href="mod-td-control.html#cb82-286" tabindex="-1"></a>      <span class="co">#&#39; @description Return and action sampled from the current policy pi. Also update the visit counters for both state and selected action.</span></span>
<span id="cb82-287"><a href="mod-td-control.html#cb82-287" tabindex="-1"></a>      <span class="co">#&#39; @param s The state considered.</span></span>
<span id="cb82-288"><a href="mod-td-control.html#cb82-288" tabindex="-1"></a>      <span class="at">getActionPi =</span> <span class="cf">function</span>(s) {</span>
<span id="cb82-289"><a href="mod-td-control.html#cb82-289" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb82-290"><a href="mod-td-control.html#cb82-290" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb82-291"><a href="mod-td-control.html#cb82-291" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> <span class="fu">names</span>(pi)</span>
<span id="cb82-292"><a href="mod-td-control.html#cb82-292" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">sample</span>(actions, <span class="dv">1</span>, <span class="at">prob =</span> pi)</span>
<span id="cb82-293"><a href="mod-td-control.html#cb82-293" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb82-294"><a href="mod-td-control.html#cb82-294" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb82-295"><a href="mod-td-control.html#cb82-295" tabindex="-1"></a>      },</span>
<span id="cb82-296"><a href="mod-td-control.html#cb82-296" tabindex="-1"></a>      </span>
<span id="cb82-297"><a href="mod-td-control.html#cb82-297" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb82-298"><a href="mod-td-control.html#cb82-298" tabindex="-1"></a><span class="co">#       getActionPi = function(s) {</span></span>
<span id="cb82-299"><a href="mod-td-control.html#cb82-299" tabindex="-1"></a><span class="co">#          pi &lt;- self$model[[s]]$pi</span></span>
<span id="cb82-300"><a href="mod-td-control.html#cb82-300" tabindex="-1"></a><span class="co">#          return(sample(names(pi), 1, prob = pi))</span></span>
<span id="cb82-301"><a href="mod-td-control.html#cb82-301" tabindex="-1"></a><span class="co">#       },</span></span>
<span id="cb82-302"><a href="mod-td-control.html#cb82-302" tabindex="-1"></a>      </span>
<span id="cb82-303"><a href="mod-td-control.html#cb82-303" tabindex="-1"></a>      <span class="co">#&#39; @description Policy evaluation using TD(0)</span></span>
<span id="cb82-304"><a href="mod-td-control.html#cb82-304" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb82-305"><a href="mod-td-control.html#cb82-305" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-306"><a href="mod-td-control.html#cb82-306" tabindex="-1"></a>      <span class="co">#&#39; @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb82-307"><a href="mod-td-control.html#cb82-307" tabindex="-1"></a>      <span class="co">#&#39; @param maxE Maximum number of episodes generated.  </span></span>
<span id="cb82-308"><a href="mod-td-control.html#cb82-308" tabindex="-1"></a>      <span class="co">#&#39; @param maxEL Maximum episode length.</span></span>
<span id="cb82-309"><a href="mod-td-control.html#cb82-309" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all state-values to 0.</span></span>
<span id="cb82-310"><a href="mod-td-control.html#cb82-310" tabindex="-1"></a>      <span class="co">#&#39; @param states Possible start states of each episode (one picked at random).</span></span>
<span id="cb82-311"><a href="mod-td-control.html#cb82-311" tabindex="-1"></a>      <span class="co">#&#39; @param ... Further arguments passed to `getEpisode` e.g the coefficient used for upper-confidence bound action selection. </span></span>
<span id="cb82-312"><a href="mod-td-control.html#cb82-312" tabindex="-1"></a>      <span class="at">policyEvalTD0 =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb82-313"><a href="mod-td-control.html#cb82-313" tabindex="-1"></a>         <span class="cf">if</span> (reset) self<span class="sc">$</span><span class="fu">setStateValue</span>(self<span class="sc">$</span><span class="fu">getStateKeys</span>())      <span class="co"># set to 0</span></span>
<span id="cb82-314"><a href="mod-td-control.html#cb82-314" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb82-315"><a href="mod-td-control.html#cb82-315" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among states</span></span>
<span id="cb82-316"><a href="mod-td-control.html#cb82-316" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with ss as start (max length 100000)</span></span>
<span id="cb82-317"><a href="mod-td-control.html#cb82-317" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb82-318"><a href="mod-td-control.html#cb82-318" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb82-319"><a href="mod-td-control.html#cb82-319" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb82-320"><a href="mod-td-control.html#cb82-320" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb82-321"><a href="mod-td-control.html#cb82-321" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb82-322"><a href="mod-td-control.html#cb82-322" tabindex="-1"></a>               oldV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb82-323"><a href="mod-td-control.html#cb82-323" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> oldV <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>v <span class="sc">-</span> oldV)</span>
<span id="cb82-324"><a href="mod-td-control.html#cb82-324" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb82-325"><a href="mod-td-control.html#cb82-325" tabindex="-1"></a>            }</span>
<span id="cb82-326"><a href="mod-td-control.html#cb82-326" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb82-327"><a href="mod-td-control.html#cb82-327" tabindex="-1"></a>         }</span>
<span id="cb82-328"><a href="mod-td-control.html#cb82-328" tabindex="-1"></a>      },</span>
<span id="cb82-329"><a href="mod-td-control.html#cb82-329" tabindex="-1"></a>      </span>
<span id="cb82-330"><a href="mod-td-control.html#cb82-330" tabindex="-1"></a>      </span>
<span id="cb82-331"><a href="mod-td-control.html#cb82-331" tabindex="-1"></a>      <span class="co">#&#39; @description Policy evaluation using every-visit Monte Carlo sampling.  </span></span>
<span id="cb82-332"><a href="mod-td-control.html#cb82-332" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getEpisode(agent, s, coeff)` that return an episode as a tibble with </span></span>
<span id="cb82-333"><a href="mod-td-control.html#cb82-333" tabindex="-1"></a>      <span class="co">#&#39;    cols s, a, r (last col the terminal reward). This method also must update the visit counters if needed! This is also </span></span>
<span id="cb82-334"><a href="mod-td-control.html#cb82-334" tabindex="-1"></a>      <span class="co">#&#39;    the method that decides which action selection method is used. </span></span>
<span id="cb82-335"><a href="mod-td-control.html#cb82-335" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-336"><a href="mod-td-control.html#cb82-336" tabindex="-1"></a>      <span class="co">#&#39; @param theta Threshold parameter.</span></span>
<span id="cb82-337"><a href="mod-td-control.html#cb82-337" tabindex="-1"></a>      <span class="co">#&#39; @param minIte Minimum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb82-338"><a href="mod-td-control.html#cb82-338" tabindex="-1"></a>      <span class="co">#&#39; @param maxIte Maximum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb82-339"><a href="mod-td-control.html#cb82-339" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all state-values to 0.</span></span>
<span id="cb82-340"><a href="mod-td-control.html#cb82-340" tabindex="-1"></a>      <span class="co">#&#39; @param states Start states in the episodes, which all are visited using a for loop.</span></span>
<span id="cb82-341"><a href="mod-td-control.html#cb82-341" tabindex="-1"></a>      <span class="co">#&#39; @param verbose If true then print info for each episode.</span></span>
<span id="cb82-342"><a href="mod-td-control.html#cb82-342" tabindex="-1"></a>      <span class="at">policyEvalMC =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">theta =</span> <span class="fl">0.1</span>, <span class="at">minIte =</span> <span class="dv">100</span>, <span class="at">maxIte =</span> <span class="dv">1000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb82-343"><a href="mod-td-control.html#cb82-343" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb82-344"><a href="mod-td-control.html#cb82-344" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb82-345"><a href="mod-td-control.html#cb82-345" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb82-346"><a href="mod-td-control.html#cb82-346" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb82-347"><a href="mod-td-control.html#cb82-347" tabindex="-1"></a>         }</span>
<span id="cb82-348"><a href="mod-td-control.html#cb82-348" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxIte) {</span>
<span id="cb82-349"><a href="mod-td-control.html#cb82-349" tabindex="-1"></a>            delta <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-350"><a href="mod-td-control.html#cb82-350" tabindex="-1"></a>            <span class="cf">for</span> (ss <span class="cf">in</span> states) {  <span class="co"># for episode with s as start</span></span>
<span id="cb82-351"><a href="mod-td-control.html#cb82-351" tabindex="-1"></a>               df <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getEpisodePi</span>(self, ss)  <span class="co"># an episode stored in a tibble with cols s, a, r (last col the terminal reward)</span></span>
<span id="cb82-352"><a href="mod-td-control.html#cb82-352" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">next</span></span>
<span id="cb82-353"><a href="mod-td-control.html#cb82-353" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">nS =</span> <span class="cn">NA</span>, <span class="at">g =</span> <span class="cn">NA</span>, <span class="at">oldV =</span> <span class="cn">NA</span>, <span class="at">v =</span> <span class="cn">NA</span>)</span>
<span id="cb82-354"><a href="mod-td-control.html#cb82-354" tabindex="-1"></a>               gain <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-355"><a href="mod-td-control.html#cb82-355" tabindex="-1"></a>               <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">nrow</span>(df)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb82-356"><a href="mod-td-control.html#cb82-356" tabindex="-1"></a>                  s <span class="ot">&lt;-</span> df<span class="sc">$</span>s[i]</span>
<span id="cb82-357"><a href="mod-td-control.html#cb82-357" tabindex="-1"></a>                  a <span class="ot">&lt;-</span> df<span class="sc">$</span>a[i]</span>
<span id="cb82-358"><a href="mod-td-control.html#cb82-358" tabindex="-1"></a>                  gain <span class="ot">&lt;-</span> df<span class="sc">$</span>r[i] <span class="sc">+</span> gamma <span class="sc">*</span> gain</span>
<span id="cb82-359"><a href="mod-td-control.html#cb82-359" tabindex="-1"></a>                  ctr <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n</span>
<span id="cb82-360"><a href="mod-td-control.html#cb82-360" tabindex="-1"></a>                  oldV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb82-361"><a href="mod-td-control.html#cb82-361" tabindex="-1"></a>                  stepSize <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>ctr)</span>
<span id="cb82-362"><a href="mod-td-control.html#cb82-362" tabindex="-1"></a>                  self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> oldV <span class="sc">+</span> stepSize <span class="sc">*</span> (gain <span class="sc">-</span> oldV)</span>
<span id="cb82-363"><a href="mod-td-control.html#cb82-363" tabindex="-1"></a>                  newV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb82-364"><a href="mod-td-control.html#cb82-364" tabindex="-1"></a>                  delta <span class="ot">&lt;-</span> <span class="fu">max</span>(delta, <span class="fu">abs</span>(oldV <span class="sc">-</span> newV))</span>
<span id="cb82-365"><a href="mod-td-control.html#cb82-365" tabindex="-1"></a>                  <span class="cf">if</span> (verbose) df<span class="sc">$</span>g[i] <span class="ot">&lt;-</span> gain; df<span class="sc">$</span>nS[i] <span class="ot">&lt;-</span> ctr; df<span class="sc">$</span>oldV[i] <span class="ot">&lt;-</span> oldV; df<span class="sc">$</span>v[i] <span class="ot">&lt;-</span> newV</span>
<span id="cb82-366"><a href="mod-td-control.html#cb82-366" tabindex="-1"></a>               }</span>
<span id="cb82-367"><a href="mod-td-control.html#cb82-367" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">print</span>(df)</span>
<span id="cb82-368"><a href="mod-td-control.html#cb82-368" tabindex="-1"></a>            }</span>
<span id="cb82-369"><a href="mod-td-control.html#cb82-369" tabindex="-1"></a>            <span class="cf">if</span> (delta <span class="sc">&lt;</span> theta <span class="sc">&amp;</span> ite <span class="sc">&gt;=</span> minIte) <span class="cf">break</span></span>
<span id="cb82-370"><a href="mod-td-control.html#cb82-370" tabindex="-1"></a>         }</span>
<span id="cb82-371"><a href="mod-td-control.html#cb82-371" tabindex="-1"></a>         <span class="cf">if</span> (ite <span class="sc">==</span> maxIte) <span class="fu">warning</span>(<span class="st">&quot;Polcy eval algorithm stopped at max iterations allowed: &quot;</span>, maxIte)</span>
<span id="cb82-372"><a href="mod-td-control.html#cb82-372" tabindex="-1"></a>         <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">&quot;Policy eval algorihm finished in &quot;</span>, ite, <span class="st">&quot; iterations.&quot;</span>))</span>
<span id="cb82-373"><a href="mod-td-control.html#cb82-373" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-374"><a href="mod-td-control.html#cb82-374" tabindex="-1"></a>      },</span>
<span id="cb82-375"><a href="mod-td-control.html#cb82-375" tabindex="-1"></a>      </span>
<span id="cb82-376"><a href="mod-td-control.html#cb82-376" tabindex="-1"></a>      <span class="co">#&#39; @description Generalized policy iteration using on policy every-visit Monte Carlo sampling.  </span></span>
<span id="cb82-377"><a href="mod-td-control.html#cb82-377" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getEpisode(agent, s, coeff)` that return an episode as a tibble with </span></span>
<span id="cb82-378"><a href="mod-td-control.html#cb82-378" tabindex="-1"></a>      <span class="co">#&#39;    cols s, a, r (last col the terminal reward). This method also must update the visit counters if needed! This is also </span></span>
<span id="cb82-379"><a href="mod-td-control.html#cb82-379" tabindex="-1"></a>      <span class="co">#&#39;    the method that decides which action selection method is used. </span></span>
<span id="cb82-380"><a href="mod-td-control.html#cb82-380" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-381"><a href="mod-td-control.html#cb82-381" tabindex="-1"></a>      <span class="co">#&#39; @param theta Threshold parameter.</span></span>
<span id="cb82-382"><a href="mod-td-control.html#cb82-382" tabindex="-1"></a>      <span class="co">#&#39; @param minIte Minimum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb82-383"><a href="mod-td-control.html#cb82-383" tabindex="-1"></a>      <span class="co">#&#39; @param maxIte Maximum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb82-384"><a href="mod-td-control.html#cb82-384" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all action-values to 0.</span></span>
<span id="cb82-385"><a href="mod-td-control.html#cb82-385" tabindex="-1"></a>      <span class="co">#&#39; @param states Start states in the episodes, which all are visited using a for loop.</span></span>
<span id="cb82-386"><a href="mod-td-control.html#cb82-386" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb82-387"><a href="mod-td-control.html#cb82-387" tabindex="-1"></a>      <span class="co">#&#39; @param verbose If true then print info for each episode.</span></span>
<span id="cb82-388"><a href="mod-td-control.html#cb82-388" tabindex="-1"></a>      <span class="at">gpiOnPolicyMC =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">theta =</span> <span class="fl">0.1</span>, <span class="at">minIte =</span> <span class="dv">100</span>, <span class="at">maxIte =</span> <span class="dv">1000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb82-389"><a href="mod-td-control.html#cb82-389" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb82-390"><a href="mod-td-control.html#cb82-390" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb82-391"><a href="mod-td-control.html#cb82-391" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb82-392"><a href="mod-td-control.html#cb82-392" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb82-393"><a href="mod-td-control.html#cb82-393" tabindex="-1"></a>         }</span>
<span id="cb82-394"><a href="mod-td-control.html#cb82-394" tabindex="-1"></a>         <span class="co"># self$setRandomEpsGreedyPolicy(epsilon)</span></span>
<span id="cb82-395"><a href="mod-td-control.html#cb82-395" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb82-396"><a href="mod-td-control.html#cb82-396" tabindex="-1"></a>         <span class="co"># self$setGreedyPolicy()</span></span>
<span id="cb82-397"><a href="mod-td-control.html#cb82-397" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxIte) {</span>
<span id="cb82-398"><a href="mod-td-control.html#cb82-398" tabindex="-1"></a>            delta <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-399"><a href="mod-td-control.html#cb82-399" tabindex="-1"></a>            <span class="co"># stable &lt;- TRUE</span></span>
<span id="cb82-400"><a href="mod-td-control.html#cb82-400" tabindex="-1"></a>            <span class="cf">for</span> (ss <span class="cf">in</span> states) {  <span class="co"># for episode with s as start</span></span>
<span id="cb82-401"><a href="mod-td-control.html#cb82-401" tabindex="-1"></a>               df <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getEpisode</span>(self, ss, eps)  <span class="co"># an episode stored in a tibble with cols s, a, r (last col the terminal reward)</span></span>
<span id="cb82-402"><a href="mod-td-control.html#cb82-402" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">next</span></span>
<span id="cb82-403"><a href="mod-td-control.html#cb82-403" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">nA =</span> <span class="cn">NA</span>, <span class="at">nS =</span> <span class="cn">NA</span>, <span class="at">oldQ =</span> <span class="cn">NA</span>, <span class="at">q =</span> <span class="cn">NA</span>, <span class="at">g =</span> <span class="cn">NA</span>, <span class="at">oldV =</span> <span class="cn">NA</span>, <span class="at">v =</span> <span class="cn">NA</span>)</span>
<span id="cb82-404"><a href="mod-td-control.html#cb82-404" tabindex="-1"></a>               gain <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb82-405"><a href="mod-td-control.html#cb82-405" tabindex="-1"></a>               <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">nrow</span>(df)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb82-406"><a href="mod-td-control.html#cb82-406" tabindex="-1"></a>                  s <span class="ot">&lt;-</span> df<span class="sc">$</span>s[i]</span>
<span id="cb82-407"><a href="mod-td-control.html#cb82-407" tabindex="-1"></a>                  a <span class="ot">&lt;-</span> df<span class="sc">$</span>a[i]</span>
<span id="cb82-408"><a href="mod-td-control.html#cb82-408" tabindex="-1"></a>                  gain <span class="ot">&lt;-</span> df<span class="sc">$</span>r[i] <span class="sc">+</span> gamma <span class="sc">*</span> gain</span>
<span id="cb82-409"><a href="mod-td-control.html#cb82-409" tabindex="-1"></a>                  ctr <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n</span>
<span id="cb82-410"><a href="mod-td-control.html#cb82-410" tabindex="-1"></a>                  oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb82-411"><a href="mod-td-control.html#cb82-411" tabindex="-1"></a>                  oldV <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getStateValueQ</span>(s)</span>
<span id="cb82-412"><a href="mod-td-control.html#cb82-412" tabindex="-1"></a>                  stepSize <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>ctr)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb82-413"><a href="mod-td-control.html#cb82-413" tabindex="-1"></a>                  self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> stepSize <span class="sc">*</span> (gain <span class="sc">-</span> oldQ)</span>
<span id="cb82-414"><a href="mod-td-control.html#cb82-414" tabindex="-1"></a>                  <span class="co"># self$model[[s]]$actions[[a]]$q &lt;- oldQ + 0.1 * (gain - oldQ)</span></span>
<span id="cb82-415"><a href="mod-td-control.html#cb82-415" tabindex="-1"></a>                  self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb82-416"><a href="mod-td-control.html#cb82-416" tabindex="-1"></a>                  newV <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getStateValueQ</span>(s)</span>
<span id="cb82-417"><a href="mod-td-control.html#cb82-417" tabindex="-1"></a>                  delta <span class="ot">&lt;-</span> <span class="fu">max</span>(delta, <span class="fu">abs</span>(oldV <span class="sc">-</span> newV))</span>
<span id="cb82-418"><a href="mod-td-control.html#cb82-418" tabindex="-1"></a>                  <span class="cf">if</span> (verbose) df<span class="sc">$</span>oldQ[i] <span class="ot">&lt;-</span> oldQ; df<span class="sc">$</span>q[i] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q; df<span class="sc">$</span>g[i] <span class="ot">&lt;-</span> gain; df<span class="sc">$</span>nA[i] <span class="ot">&lt;-</span> ctr; df<span class="sc">$</span>nS[i] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n; df<span class="sc">$</span>oldV[i] <span class="ot">&lt;-</span> oldV; df<span class="sc">$</span>v[i] <span class="ot">&lt;-</span> newV</span>
<span id="cb82-419"><a href="mod-td-control.html#cb82-419" tabindex="-1"></a>               }</span>
<span id="cb82-420"><a href="mod-td-control.html#cb82-420" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">print</span>(df)</span>
<span id="cb82-421"><a href="mod-td-control.html#cb82-421" tabindex="-1"></a>            }</span>
<span id="cb82-422"><a href="mod-td-control.html#cb82-422" tabindex="-1"></a>            <span class="cf">if</span> (delta <span class="sc">&lt;</span> theta <span class="sc">&amp;</span> ite <span class="sc">&gt;=</span> minIte) <span class="cf">break</span></span>
<span id="cb82-423"><a href="mod-td-control.html#cb82-423" tabindex="-1"></a>         }</span>
<span id="cb82-424"><a href="mod-td-control.html#cb82-424" tabindex="-1"></a>         <span class="cf">if</span> (ite <span class="sc">==</span> maxIte) <span class="fu">warning</span>(<span class="st">&quot;GPI algorithm stopped at max iterations allowed: &quot;</span>, maxIte)</span>
<span id="cb82-425"><a href="mod-td-control.html#cb82-425" tabindex="-1"></a>         <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">&quot;GPI algorihm finished in &quot;</span>, ite, <span class="st">&quot; iterations.&quot;</span>))</span>
<span id="cb82-426"><a href="mod-td-control.html#cb82-426" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-427"><a href="mod-td-control.html#cb82-427" tabindex="-1"></a>      },</span>
<span id="cb82-428"><a href="mod-td-control.html#cb82-428" tabindex="-1"></a>      </span>
<span id="cb82-429"><a href="mod-td-control.html#cb82-429" tabindex="-1"></a>      <span class="co">#&#39; @description Generalized policy iteration using on policy SARSA.  </span></span>
<span id="cb82-430"><a href="mod-td-control.html#cb82-430" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb82-431"><a href="mod-td-control.html#cb82-431" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-432"><a href="mod-td-control.html#cb82-432" tabindex="-1"></a>      <span class="co">#&#39; @param maxE Maximum number of episodes generated.</span></span>
<span id="cb82-433"><a href="mod-td-control.html#cb82-433" tabindex="-1"></a>      <span class="co">#&#39; @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb82-434"><a href="mod-td-control.html#cb82-434" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all action-values to 0.</span></span>
<span id="cb82-435"><a href="mod-td-control.html#cb82-435" tabindex="-1"></a>      <span class="co">#&#39; @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb82-436"><a href="mod-td-control.html#cb82-436" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb82-437"><a href="mod-td-control.html#cb82-437" tabindex="-1"></a>      <span class="co">#&#39; @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb82-438"><a href="mod-td-control.html#cb82-438" tabindex="-1"></a>      <span class="at">gpiOnPolicySARSA =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb82-439"><a href="mod-td-control.html#cb82-439" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb82-440"><a href="mod-td-control.html#cb82-440" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb82-441"><a href="mod-td-control.html#cb82-441" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb82-442"><a href="mod-td-control.html#cb82-442" tabindex="-1"></a>         }</span>
<span id="cb82-443"><a href="mod-td-control.html#cb82-443" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb82-444"><a href="mod-td-control.html#cb82-444" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb82-445"><a href="mod-td-control.html#cb82-445" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb82-446"><a href="mod-td-control.html#cb82-446" tabindex="-1"></a>            a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb82-447"><a href="mod-td-control.html#cb82-447" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb82-448"><a href="mod-td-control.html#cb82-448" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb82-449"><a href="mod-td-control.html#cb82-449" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb82-450"><a href="mod-td-control.html#cb82-450" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb82-451"><a href="mod-td-control.html#cb82-451" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb82-452"><a href="mod-td-control.html#cb82-452" tabindex="-1"></a>               aN <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(sN)</span>
<span id="cb82-453"><a href="mod-td-control.html#cb82-453" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb82-454"><a href="mod-td-control.html#cb82-454" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>actions[[aN]]<span class="sc">$</span>q <span class="sc">-</span> oldQ)</span>
<span id="cb82-455"><a href="mod-td-control.html#cb82-455" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">&quot;(s,a,r,s,a) = (&quot;</span>, s, <span class="st">&quot;,&quot;</span>, a, <span class="st">&quot;,&quot;</span>, r, <span class="st">&quot;,&quot;</span>, sN, <span class="st">&quot;,&quot;</span>, aN, <span class="st">&quot;), r = &quot;</span>, r, <span class="st">&quot; oldQ = &quot;</span>, oldQ, <span class="st">&quot; Q(sN, aN) = &quot;</span>, self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>actions[[aN]]<span class="sc">$</span>q, <span class="st">&quot; newQ = &quot;</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb82-456"><a href="mod-td-control.html#cb82-456" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb82-457"><a href="mod-td-control.html#cb82-457" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb82-458"><a href="mod-td-control.html#cb82-458" tabindex="-1"></a>               a <span class="ot">&lt;-</span> aN</span>
<span id="cb82-459"><a href="mod-td-control.html#cb82-459" tabindex="-1"></a>            }</span>
<span id="cb82-460"><a href="mod-td-control.html#cb82-460" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb82-461"><a href="mod-td-control.html#cb82-461" tabindex="-1"></a>         }</span>
<span id="cb82-462"><a href="mod-td-control.html#cb82-462" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with &quot;</span>, ite, <span class="st">&quot; episodes.&quot;</span>)</span>
<span id="cb82-463"><a href="mod-td-control.html#cb82-463" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with episode of length &quot;</span>, i, <span class="st">&quot;.&quot;</span>)</span>
<span id="cb82-464"><a href="mod-td-control.html#cb82-464" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-465"><a href="mod-td-control.html#cb82-465" tabindex="-1"></a>      },</span>
<span id="cb82-466"><a href="mod-td-control.html#cb82-466" tabindex="-1"></a>      </span>
<span id="cb82-467"><a href="mod-td-control.html#cb82-467" tabindex="-1"></a>      <span class="co">#&#39; @description Generalized policy iteration using off policy Q-learning.  </span></span>
<span id="cb82-468"><a href="mod-td-control.html#cb82-468" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb82-469"><a href="mod-td-control.html#cb82-469" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-470"><a href="mod-td-control.html#cb82-470" tabindex="-1"></a>      <span class="co">#&#39; @param maxE Maximum number of episodes generated.</span></span>
<span id="cb82-471"><a href="mod-td-control.html#cb82-471" tabindex="-1"></a>      <span class="co">#&#39; @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb82-472"><a href="mod-td-control.html#cb82-472" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all action-values to 0.</span></span>
<span id="cb82-473"><a href="mod-td-control.html#cb82-473" tabindex="-1"></a>      <span class="co">#&#39; @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb82-474"><a href="mod-td-control.html#cb82-474" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb82-475"><a href="mod-td-control.html#cb82-475" tabindex="-1"></a>      <span class="co">#&#39; @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb82-476"><a href="mod-td-control.html#cb82-476" tabindex="-1"></a>      <span class="at">gpiOffPolicyQLearning =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb82-477"><a href="mod-td-control.html#cb82-477" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb82-478"><a href="mod-td-control.html#cb82-478" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb82-479"><a href="mod-td-control.html#cb82-479" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb82-480"><a href="mod-td-control.html#cb82-480" tabindex="-1"></a>         }</span>
<span id="cb82-481"><a href="mod-td-control.html#cb82-481" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb82-482"><a href="mod-td-control.html#cb82-482" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb82-483"><a href="mod-td-control.html#cb82-483" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb82-484"><a href="mod-td-control.html#cb82-484" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb82-485"><a href="mod-td-control.html#cb82-485" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb82-486"><a href="mod-td-control.html#cb82-486" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb82-487"><a href="mod-td-control.html#cb82-487" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb82-488"><a href="mod-td-control.html#cb82-488" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb82-489"><a href="mod-td-control.html#cb82-489" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb82-490"><a href="mod-td-control.html#cb82-490" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb82-491"><a href="mod-td-control.html#cb82-491" tabindex="-1"></a>               maxQ <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getMaxActionValue</span>(sN)</span>
<span id="cb82-492"><a href="mod-td-control.html#cb82-492" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> maxQ <span class="sc">-</span> oldQ)</span>
<span id="cb82-493"><a href="mod-td-control.html#cb82-493" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">&quot;(s,a,r,s) = (&quot;</span>, s, <span class="st">&quot;,&quot;</span>, a, <span class="st">&quot;,&quot;</span>, r, <span class="st">&quot;,&quot;</span>, sN, <span class="st">&quot;), r = &quot;</span>, r, <span class="st">&quot; oldQ = &quot;</span>, oldQ, <span class="st">&quot; maxQ(sN) = &quot;</span>, maxQ, <span class="st">&quot; newQ = &quot;</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb82-494"><a href="mod-td-control.html#cb82-494" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb82-495"><a href="mod-td-control.html#cb82-495" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb82-496"><a href="mod-td-control.html#cb82-496" tabindex="-1"></a>            }</span>
<span id="cb82-497"><a href="mod-td-control.html#cb82-497" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb82-498"><a href="mod-td-control.html#cb82-498" tabindex="-1"></a>         }</span>
<span id="cb82-499"><a href="mod-td-control.html#cb82-499" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setGreedyPolicy</span>()</span>
<span id="cb82-500"><a href="mod-td-control.html#cb82-500" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with &quot;</span>, ite, <span class="st">&quot; episodes.&quot;</span>)</span>
<span id="cb82-501"><a href="mod-td-control.html#cb82-501" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with episode of length &quot;</span>, i, <span class="st">&quot;.&quot;</span>)</span>
<span id="cb82-502"><a href="mod-td-control.html#cb82-502" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-503"><a href="mod-td-control.html#cb82-503" tabindex="-1"></a>      },</span>
<span id="cb82-504"><a href="mod-td-control.html#cb82-504" tabindex="-1"></a></span>
<span id="cb82-505"><a href="mod-td-control.html#cb82-505" tabindex="-1"></a>      <span class="co">#&#39; @description Generalized policy iteration using off policy Q-learning.  </span></span>
<span id="cb82-506"><a href="mod-td-control.html#cb82-506" tabindex="-1"></a>      <span class="co">#&#39; @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb82-507"><a href="mod-td-control.html#cb82-507" tabindex="-1"></a>      <span class="co">#&#39; @param gamma Discount rate.</span></span>
<span id="cb82-508"><a href="mod-td-control.html#cb82-508" tabindex="-1"></a>      <span class="co">#&#39; @param maxE Maximum number of episodes generated.</span></span>
<span id="cb82-509"><a href="mod-td-control.html#cb82-509" tabindex="-1"></a>      <span class="co">#&#39; @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb82-510"><a href="mod-td-control.html#cb82-510" tabindex="-1"></a>      <span class="co">#&#39; @param reset If true initialize all action-values to 0.</span></span>
<span id="cb82-511"><a href="mod-td-control.html#cb82-511" tabindex="-1"></a>      <span class="co">#&#39; @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb82-512"><a href="mod-td-control.html#cb82-512" tabindex="-1"></a>      <span class="co">#&#39; @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb82-513"><a href="mod-td-control.html#cb82-513" tabindex="-1"></a>      <span class="co">#&#39; @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb82-514"><a href="mod-td-control.html#cb82-514" tabindex="-1"></a>      <span class="at">gpiOnPolicyExpSARSA =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb82-515"><a href="mod-td-control.html#cb82-515" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb82-516"><a href="mod-td-control.html#cb82-516" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb82-517"><a href="mod-td-control.html#cb82-517" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb82-518"><a href="mod-td-control.html#cb82-518" tabindex="-1"></a>         }</span>
<span id="cb82-519"><a href="mod-td-control.html#cb82-519" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb82-520"><a href="mod-td-control.html#cb82-520" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb82-521"><a href="mod-td-control.html#cb82-521" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb82-522"><a href="mod-td-control.html#cb82-522" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb82-523"><a href="mod-td-control.html#cb82-523" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb82-524"><a href="mod-td-control.html#cb82-524" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb82-525"><a href="mod-td-control.html#cb82-525" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb82-526"><a href="mod-td-control.html#cb82-526" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb82-527"><a href="mod-td-control.html#cb82-527" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb82-528"><a href="mod-td-control.html#cb82-528" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb82-529"><a href="mod-td-control.html#cb82-529" tabindex="-1"></a>               expQ <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getExpActionValue</span>(sN)</span>
<span id="cb82-530"><a href="mod-td-control.html#cb82-530" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> expQ <span class="sc">-</span> oldQ)</span>
<span id="cb82-531"><a href="mod-td-control.html#cb82-531" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">&quot;(s,a,r,s) = (&quot;</span>, s, <span class="st">&quot;,&quot;</span>, a, <span class="st">&quot;,&quot;</span>, r, <span class="st">&quot;,&quot;</span>, sN, <span class="st">&quot;), r = &quot;</span>, r, <span class="st">&quot; oldQ = &quot;</span>, oldQ, <span class="st">&quot; expQ(sN) = &quot;</span>, expQ, <span class="st">&quot; newQ = &quot;</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb82-532"><a href="mod-td-control.html#cb82-532" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb82-533"><a href="mod-td-control.html#cb82-533" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb82-534"><a href="mod-td-control.html#cb82-534" tabindex="-1"></a>            }</span>
<span id="cb82-535"><a href="mod-td-control.html#cb82-535" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb82-536"><a href="mod-td-control.html#cb82-536" tabindex="-1"></a>         }</span>
<span id="cb82-537"><a href="mod-td-control.html#cb82-537" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with &quot;</span>, ite, <span class="st">&quot; episodes.&quot;</span>)</span>
<span id="cb82-538"><a href="mod-td-control.html#cb82-538" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">&quot;GPI algorithm stopped with episode of length &quot;</span>, i, <span class="st">&quot;.&quot;</span>)</span>
<span id="cb82-539"><a href="mod-td-control.html#cb82-539" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb82-540"><a href="mod-td-control.html#cb82-540" tabindex="-1"></a>      }</span>
<span id="cb82-541"><a href="mod-td-control.html#cb82-541" tabindex="-1"></a>   )</span>
<span id="cb82-542"><a href="mod-td-control.html#cb82-542" tabindex="-1"></a>)</span></code></pre></div>
<!-- Q2 -->
<div id="ChY0pzlW7sZZcjxBMPpd" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="ChY0pzlW7sZZcjxBMPpd-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="ChY0pzlW7sZZcjxBMPpd-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
In general the algorithms use parameters <code>maxE</code> and <code>maxEL</code> to identify the number of iterations and the current policy is stored in <code>pi</code>. Moreover, <code>NA</code> is used to identify end of an episode (if returned from <code>getTimeStepData</code>).
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#ChY0pzlW7sZZcjxBMPpd">
Solution
</button>
<ol start="2" style="list-style-type: decimal">
<li>Consider the algorithms <code>gpiOnPolicySARSA</code>, <code>gpiOffPolicyQLearning</code> and <code>gpiOnPolicyExpSARSA</code> and try to identify the differences compared to the pseudo code descriptions. Why is expected SARSA here an on-policy algorithm?</li>
</ol>
<p>In the following let us try to approximate the optimal policy using a discount factor of 0.5. The state-values for the optimal deterministic policy can be seen in Example <a href="mod-dp.html#exe-dp-storage">5.8</a>.</p>
<p>We define the RL agent:</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb83-1"><a href="mod-td-control.html#cb83-1" tabindex="-1"></a>agent <span class="ot">&lt;-</span> RLAgent<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb83-2"><a href="mod-td-control.html#cb83-2" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">addStates</span>(env<span class="sc">$</span><span class="fu">getStates</span>())   <span class="co"># add states</span></span>
<span id="cb83-3"><a href="mod-td-control.html#cb83-3" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> agent<span class="sc">$</span><span class="fu">getStateKeys</span>()) {  <span class="co"># add actions</span></span>
<span id="cb83-4"><a href="mod-td-control.html#cb83-4" tabindex="-1"></a>   agent<span class="sc">$</span><span class="fu">addActions</span>(s, env<span class="sc">$</span><span class="fu">getActions</span>(s))</span>
<span id="cb83-5"><a href="mod-td-control.html#cb83-5" tabindex="-1"></a>} </span>
<span id="cb83-6"><a href="mod-td-control.html#cb83-6" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionInfo</span>(<span class="st">&quot;0&quot;</span>)</span>
<span id="cb83-7"><a href="mod-td-control.html#cb83-7" tabindex="-1"></a><span class="co">#&gt; $keep</span></span>
<span id="cb83-8"><a href="mod-td-control.html#cb83-8" tabindex="-1"></a><span class="co">#&gt; $keep$q</span></span>
<span id="cb83-9"><a href="mod-td-control.html#cb83-9" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb83-10"><a href="mod-td-control.html#cb83-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb83-11"><a href="mod-td-control.html#cb83-11" tabindex="-1"></a><span class="co">#&gt; $keep$n</span></span>
<span id="cb83-12"><a href="mod-td-control.html#cb83-12" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb83-13"><a href="mod-td-control.html#cb83-13" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionInfo</span>(<span class="st">&quot;4&quot;</span>)</span>
<span id="cb83-14"><a href="mod-td-control.html#cb83-14" tabindex="-1"></a><span class="co">#&gt; $keep</span></span>
<span id="cb83-15"><a href="mod-td-control.html#cb83-15" tabindex="-1"></a><span class="co">#&gt; $keep$q</span></span>
<span id="cb83-16"><a href="mod-td-control.html#cb83-16" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb83-17"><a href="mod-td-control.html#cb83-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb83-18"><a href="mod-td-control.html#cb83-18" tabindex="-1"></a><span class="co">#&gt; $keep$n</span></span>
<span id="cb83-19"><a href="mod-td-control.html#cb83-19" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb83-20"><a href="mod-td-control.html#cb83-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb83-21"><a href="mod-td-control.html#cb83-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb83-22"><a href="mod-td-control.html#cb83-22" tabindex="-1"></a><span class="co">#&gt; $empty</span></span>
<span id="cb83-23"><a href="mod-td-control.html#cb83-23" tabindex="-1"></a><span class="co">#&gt; $empty$q</span></span>
<span id="cb83-24"><a href="mod-td-control.html#cb83-24" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb83-25"><a href="mod-td-control.html#cb83-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb83-26"><a href="mod-td-control.html#cb83-26" tabindex="-1"></a><span class="co">#&gt; $empty$n</span></span>
<span id="cb83-27"><a href="mod-td-control.html#cb83-27" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span></code></pre></div>
<!-- Q3 -->
<div id="id_4vFWAwL9ZYPZpTiLVmPU" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="4vFWAwL9ZYPZpTiLVmPU-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="4vFWAwL9ZYPZpTiLVmPU-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
Each iteration generates the sequence <span class="math inline">\((s,a,r,s,a)\)</span> for SARSA and <span class="math inline">\((s,a,r,s)\)</span> for Q-learning and expected SARSA. Note SARSA and expected SARSA approximate an epsilon greed policy while Q-learning the deterministic policy.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#4vFWAwL9ZYPZpTiLVmPU">
Solution
</button>
<ol start="3" style="list-style-type: decimal">
<li>Run the algorithms <code>gpiOnPolicySARSA</code>, <code>gpiOffPolicyQLearning</code> and <code>gpiOnPolicyExpSARSA</code> using <code>maxEL = 5</code>, <code>alpha = 0.1</code> and <code>verbose = T</code> and explain the output:</li>
</ol>
<div class="sourceCode" id="cb84"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb84-1"><a href="mod-td-control.html#cb84-1" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicySARSA</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb84-2"><a href="mod-td-control.html#cb84-2" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (2,empty,-35,2,empty), r = -35 oldQ = 0 Q(sN, aN) = -3.5 newQ = -3.5</span></span>
<span id="cb84-3"><a href="mod-td-control.html#cb84-3" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (2,empty,-35,3,empty), r = -35 oldQ = -3.5 Q(sN, aN) = 0 newQ = -6.65</span></span>
<span id="cb84-4"><a href="mod-td-control.html#cb84-4" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (3,empty,-40,3,empty), r = -40 oldQ = 0 Q(sN, aN) = -4 newQ = -4</span></span>
<span id="cb84-5"><a href="mod-td-control.html#cb84-5" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (3,empty,-40,1,keep), r = -40 oldQ = -4 Q(sN, aN) = 0 newQ = -7.6</span></span>
<span id="cb84-6"><a href="mod-td-control.html#cb84-6" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (1,keep,0,2,keep), r = 0 oldQ = 0 Q(sN, aN) = 0 newQ = 0</span></span>
<span id="cb84-7"><a href="mod-td-control.html#cb84-7" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionValues</span>()</span>
<span id="cb84-8"><a href="mod-td-control.html#cb84-8" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 4</span></span>
<span id="cb84-9"><a href="mod-td-control.html#cb84-9" tabindex="-1"></a><span class="co">#&gt;   state action     q     n</span></span>
<span id="cb84-10"><a href="mod-td-control.html#cb84-10" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb84-11"><a href="mod-td-control.html#cb84-11" tabindex="-1"></a><span class="co">#&gt; 1 0     keep    0        0</span></span>
<span id="cb84-12"><a href="mod-td-control.html#cb84-12" tabindex="-1"></a><span class="co">#&gt; 2 1     empty   0        0</span></span>
<span id="cb84-13"><a href="mod-td-control.html#cb84-13" tabindex="-1"></a><span class="co">#&gt; 3 1     keep    0        1</span></span>
<span id="cb84-14"><a href="mod-td-control.html#cb84-14" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -6.65     2</span></span>
<span id="cb84-15"><a href="mod-td-control.html#cb84-15" tabindex="-1"></a><span class="co">#&gt; 5 2     keep    0        1</span></span>
<span id="cb84-16"><a href="mod-td-control.html#cb84-16" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -7.6      2</span></span>
<span id="cb84-17"><a href="mod-td-control.html#cb84-17" tabindex="-1"></a><span class="co">#&gt; 7 3     keep    0        0</span></span>
<span id="cb84-18"><a href="mod-td-control.html#cb84-18" tabindex="-1"></a><span class="co">#&gt; 8 4     empty   0        0</span></span>
<span id="cb84-19"><a href="mod-td-control.html#cb84-19" tabindex="-1"></a><span class="co">#&gt; 9 4     keep    0        0</span></span>
<span id="cb84-20"><a href="mod-td-control.html#cb84-20" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getPolicy</span>()</span>
<span id="cb84-21"><a href="mod-td-control.html#cb84-21" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 3</span></span>
<span id="cb84-22"><a href="mod-td-control.html#cb84-22" tabindex="-1"></a><span class="co">#&gt;   state action    pr</span></span>
<span id="cb84-23"><a href="mod-td-control.html#cb84-23" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb84-24"><a href="mod-td-control.html#cb84-24" tabindex="-1"></a><span class="co">#&gt; 1 0     keep    1   </span></span>
<span id="cb84-25"><a href="mod-td-control.html#cb84-25" tabindex="-1"></a><span class="co">#&gt; 2 1     empty   0.95</span></span>
<span id="cb84-26"><a href="mod-td-control.html#cb84-26" tabindex="-1"></a><span class="co">#&gt; 3 1     keep    0.05</span></span>
<span id="cb84-27"><a href="mod-td-control.html#cb84-27" tabindex="-1"></a><span class="co">#&gt; 4 2     empty   0.05</span></span>
<span id="cb84-28"><a href="mod-td-control.html#cb84-28" tabindex="-1"></a><span class="co">#&gt; 5 2     keep    0.95</span></span>
<span id="cb84-29"><a href="mod-td-control.html#cb84-29" tabindex="-1"></a><span class="co">#&gt; 6 3     empty   0.05</span></span>
<span id="cb84-30"><a href="mod-td-control.html#cb84-30" tabindex="-1"></a><span class="co">#&gt; 7 3     keep    0.95</span></span>
<span id="cb84-31"><a href="mod-td-control.html#cb84-31" tabindex="-1"></a><span class="co">#&gt; 8 4     empty   0.95</span></span>
<span id="cb84-32"><a href="mod-td-control.html#cb84-32" tabindex="-1"></a><span class="co">#&gt; 9 4     keep    0.05</span></span>
<span id="cb84-33"><a href="mod-td-control.html#cb84-33" tabindex="-1"></a></span>
<span id="cb84-34"><a href="mod-td-control.html#cb84-34" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb84-35"><a href="mod-td-control.html#cb84-35" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (2,keep,0,3), r = 0 oldQ = 0 maxQ(sN) = 0 newQ = 0</span></span>
<span id="cb84-36"><a href="mod-td-control.html#cb84-36" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,keep,0,4), r = 0 oldQ = 0 maxQ(sN) = 0 newQ = 0</span></span>
<span id="cb84-37"><a href="mod-td-control.html#cb84-37" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (4,empty,-45,2), r = -45 oldQ = 0 maxQ(sN) = 0 newQ = -4.5</span></span>
<span id="cb84-38"><a href="mod-td-control.html#cb84-38" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (2,empty,-35,3), r = -35 oldQ = 0 maxQ(sN) = 0 newQ = -3.5</span></span>
<span id="cb84-39"><a href="mod-td-control.html#cb84-39" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,empty,-40,1), r = -40 oldQ = 0 maxQ(sN) = 0 newQ = -4</span></span>
<span id="cb84-40"><a href="mod-td-control.html#cb84-40" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionValues</span>()</span>
<span id="cb84-41"><a href="mod-td-control.html#cb84-41" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 4</span></span>
<span id="cb84-42"><a href="mod-td-control.html#cb84-42" tabindex="-1"></a><span class="co">#&gt;   state action     q     n</span></span>
<span id="cb84-43"><a href="mod-td-control.html#cb84-43" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb84-44"><a href="mod-td-control.html#cb84-44" tabindex="-1"></a><span class="co">#&gt; 1 0     keep     0       0</span></span>
<span id="cb84-45"><a href="mod-td-control.html#cb84-45" tabindex="-1"></a><span class="co">#&gt; 2 1     empty    0       0</span></span>
<span id="cb84-46"><a href="mod-td-control.html#cb84-46" tabindex="-1"></a><span class="co">#&gt; 3 1     keep     0       0</span></span>
<span id="cb84-47"><a href="mod-td-control.html#cb84-47" tabindex="-1"></a><span class="co">#&gt; 4 2     empty   -3.5     1</span></span>
<span id="cb84-48"><a href="mod-td-control.html#cb84-48" tabindex="-1"></a><span class="co">#&gt; 5 2     keep     0       1</span></span>
<span id="cb84-49"><a href="mod-td-control.html#cb84-49" tabindex="-1"></a><span class="co">#&gt; 6 3     empty   -4       1</span></span>
<span id="cb84-50"><a href="mod-td-control.html#cb84-50" tabindex="-1"></a><span class="co">#&gt; 7 3     keep     0       1</span></span>
<span id="cb84-51"><a href="mod-td-control.html#cb84-51" tabindex="-1"></a><span class="co">#&gt; 8 4     empty   -4.5     1</span></span>
<span id="cb84-52"><a href="mod-td-control.html#cb84-52" tabindex="-1"></a><span class="co">#&gt; 9 4     keep     0       0</span></span>
<span id="cb84-53"><a href="mod-td-control.html#cb84-53" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getPolicy</span>()</span>
<span id="cb84-54"><a href="mod-td-control.html#cb84-54" tabindex="-1"></a><span class="co">#&gt; # A tibble: 5 × 3</span></span>
<span id="cb84-55"><a href="mod-td-control.html#cb84-55" tabindex="-1"></a><span class="co">#&gt;   state action    pr</span></span>
<span id="cb84-56"><a href="mod-td-control.html#cb84-56" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb84-57"><a href="mod-td-control.html#cb84-57" tabindex="-1"></a><span class="co">#&gt; 1 0     keep       1</span></span>
<span id="cb84-58"><a href="mod-td-control.html#cb84-58" tabindex="-1"></a><span class="co">#&gt; 2 1     empty      1</span></span>
<span id="cb84-59"><a href="mod-td-control.html#cb84-59" tabindex="-1"></a><span class="co">#&gt; 3 2     keep       1</span></span>
<span id="cb84-60"><a href="mod-td-control.html#cb84-60" tabindex="-1"></a><span class="co">#&gt; 4 3     keep       1</span></span>
<span id="cb84-61"><a href="mod-td-control.html#cb84-61" tabindex="-1"></a><span class="co">#&gt; 5 4     keep       1</span></span>
<span id="cb84-62"><a href="mod-td-control.html#cb84-62" tabindex="-1"></a></span>
<span id="cb84-63"><a href="mod-td-control.html#cb84-63" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyExpSARSA</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb84-64"><a href="mod-td-control.html#cb84-64" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,empty,-40,1), r = -40 oldQ = 0 expQ(sN) = 0 newQ = -4</span></span>
<span id="cb84-65"><a href="mod-td-control.html#cb84-65" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (1,keep,0,2), r = 0 oldQ = 0 expQ(sN) = 0 newQ = 0</span></span>
<span id="cb84-66"><a href="mod-td-control.html#cb84-66" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (2,keep,0,2), r = 0 oldQ = 0 expQ(sN) = 0 newQ = 0</span></span>
<span id="cb84-67"><a href="mod-td-control.html#cb84-67" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (2,keep,0,3), r = 0 oldQ = 0 expQ(sN) = -0.2 newQ = -0.01</span></span>
<span id="cb84-68"><a href="mod-td-control.html#cb84-68" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,keep,0,4), r = 0 oldQ = 0 expQ(sN) = 0 newQ = 0</span></span>
<span id="cb84-69"><a href="mod-td-control.html#cb84-69" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionValues</span>()</span>
<span id="cb84-70"><a href="mod-td-control.html#cb84-70" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 4</span></span>
<span id="cb84-71"><a href="mod-td-control.html#cb84-71" tabindex="-1"></a><span class="co">#&gt;   state action     q     n</span></span>
<span id="cb84-72"><a href="mod-td-control.html#cb84-72" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb84-73"><a href="mod-td-control.html#cb84-73" tabindex="-1"></a><span class="co">#&gt; 1 0     keep    0        0</span></span>
<span id="cb84-74"><a href="mod-td-control.html#cb84-74" tabindex="-1"></a><span class="co">#&gt; 2 1     empty   0        0</span></span>
<span id="cb84-75"><a href="mod-td-control.html#cb84-75" tabindex="-1"></a><span class="co">#&gt; 3 1     keep    0        1</span></span>
<span id="cb84-76"><a href="mod-td-control.html#cb84-76" tabindex="-1"></a><span class="co">#&gt; 4 2     empty   0        0</span></span>
<span id="cb84-77"><a href="mod-td-control.html#cb84-77" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -0.01     2</span></span>
<span id="cb84-78"><a href="mod-td-control.html#cb84-78" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -4        1</span></span>
<span id="cb84-79"><a href="mod-td-control.html#cb84-79" tabindex="-1"></a><span class="co">#&gt; 7 3     keep    0        1</span></span>
<span id="cb84-80"><a href="mod-td-control.html#cb84-80" tabindex="-1"></a><span class="co">#&gt; 8 4     empty   0        0</span></span>
<span id="cb84-81"><a href="mod-td-control.html#cb84-81" tabindex="-1"></a><span class="co">#&gt; 9 4     keep    0        0</span></span>
<span id="cb84-82"><a href="mod-td-control.html#cb84-82" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getPolicy</span>()</span>
<span id="cb84-83"><a href="mod-td-control.html#cb84-83" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 3</span></span>
<span id="cb84-84"><a href="mod-td-control.html#cb84-84" tabindex="-1"></a><span class="co">#&gt;   state action    pr</span></span>
<span id="cb84-85"><a href="mod-td-control.html#cb84-85" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb84-86"><a href="mod-td-control.html#cb84-86" tabindex="-1"></a><span class="co">#&gt; 1 0     keep    1   </span></span>
<span id="cb84-87"><a href="mod-td-control.html#cb84-87" tabindex="-1"></a><span class="co">#&gt; 2 1     empty   0.05</span></span>
<span id="cb84-88"><a href="mod-td-control.html#cb84-88" tabindex="-1"></a><span class="co">#&gt; 3 1     keep    0.95</span></span>
<span id="cb84-89"><a href="mod-td-control.html#cb84-89" tabindex="-1"></a><span class="co">#&gt; 4 2     empty   0.95</span></span>
<span id="cb84-90"><a href="mod-td-control.html#cb84-90" tabindex="-1"></a><span class="co">#&gt; 5 2     keep    0.05</span></span>
<span id="cb84-91"><a href="mod-td-control.html#cb84-91" tabindex="-1"></a><span class="co">#&gt; 6 3     empty   0.05</span></span>
<span id="cb84-92"><a href="mod-td-control.html#cb84-92" tabindex="-1"></a><span class="co">#&gt; 7 3     keep    0.95</span></span>
<span id="cb84-93"><a href="mod-td-control.html#cb84-93" tabindex="-1"></a><span class="co">#&gt; 8 4     empty   0.05</span></span>
<span id="cb84-94"><a href="mod-td-control.html#cb84-94" tabindex="-1"></a><span class="co">#&gt; 9 4     keep    0.95</span></span></code></pre></div>
<!-- Q4 -->
<!-- First solv MDP -->
<div id="id_0xMHzzBLpFZK3dpXKTi9" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="0xMHzzBLpFZK3dpXKTi9-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="0xMHzzBLpFZK3dpXKTi9-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb85"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb85-1"><a href="mod-td-control.html#cb85-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">43</span>)</span>
<span id="cb85-2"><a href="mod-td-control.html#cb85-2" tabindex="-1"></a>ite <span class="ot">&lt;-</span> <span class="dv">5000</span></span>
<span id="cb85-3"><a href="mod-td-control.html#cb85-3" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicySARSA</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb85-4"><a href="mod-td-control.html#cb85-4" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) </span>
<span id="cb85-5"><a href="mod-td-control.html#cb85-5" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb85-6"><a href="mod-td-control.html#cb85-6" tabindex="-1"></a><span class="co">#&gt;   state action     q     n    pr</span></span>
<span id="cb85-7"><a href="mod-td-control.html#cb85-7" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb85-8"><a href="mod-td-control.html#cb85-8" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -12.9   269  1   </span></span>
<span id="cb85-9"><a href="mod-td-control.html#cb85-9" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -43.7    58  0.05</span></span>
<span id="cb85-10"><a href="mod-td-control.html#cb85-10" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -15.2  1055  0.95</span></span>
<span id="cb85-11"><a href="mod-td-control.html#cb85-11" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -47.6    74  0.05</span></span>
<span id="cb85-12"><a href="mod-td-control.html#cb85-12" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -29.5  1088  0.95</span></span>
<span id="cb85-13"><a href="mod-td-control.html#cb85-13" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -52.7   403  0.05</span></span>
<span id="cb85-14"><a href="mod-td-control.html#cb85-14" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -40.7   730  0.95</span></span>
<span id="cb85-15"><a href="mod-td-control.html#cb85-15" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -57.2  1235  0.95</span></span>
<span id="cb85-16"><a href="mod-td-control.html#cb85-16" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -62.3    89  0.05</span></span>
<span id="cb85-17"><a href="mod-td-control.html#cb85-17" tabindex="-1"></a></span>
<span id="cb85-18"><a href="mod-td-control.html#cb85-18" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb85-19"><a href="mod-td-control.html#cb85-19" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>())</span>
<span id="cb85-20"><a href="mod-td-control.html#cb85-20" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb85-21"><a href="mod-td-control.html#cb85-21" tabindex="-1"></a><span class="co">#&gt;   state action     q     n    pr</span></span>
<span id="cb85-22"><a href="mod-td-control.html#cb85-22" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb85-23"><a href="mod-td-control.html#cb85-23" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -10.3   255     1</span></span>
<span id="cb85-24"><a href="mod-td-control.html#cb85-24" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -39.9    69    NA</span></span>
<span id="cb85-25"><a href="mod-td-control.html#cb85-25" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -15.2  1034     1</span></span>
<span id="cb85-26"><a href="mod-td-control.html#cb85-26" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -44.5    64    NA</span></span>
<span id="cb85-27"><a href="mod-td-control.html#cb85-27" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -24.9  1069     1</span></span>
<span id="cb85-28"><a href="mod-td-control.html#cb85-28" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -50.0   185    NA</span></span>
<span id="cb85-29"><a href="mod-td-control.html#cb85-29" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -33.5   920     1</span></span>
<span id="cb85-30"><a href="mod-td-control.html#cb85-30" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -54.8  1329     1</span></span>
<span id="cb85-31"><a href="mod-td-control.html#cb85-31" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -66.4    75    NA</span></span>
<span id="cb85-32"><a href="mod-td-control.html#cb85-32" tabindex="-1"></a></span>
<span id="cb85-33"><a href="mod-td-control.html#cb85-33" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyExpSARSA</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb85-34"><a href="mod-td-control.html#cb85-34" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>())</span>
<span id="cb85-35"><a href="mod-td-control.html#cb85-35" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb85-36"><a href="mod-td-control.html#cb85-36" tabindex="-1"></a><span class="co">#&gt;   state action     q     n    pr</span></span>
<span id="cb85-37"><a href="mod-td-control.html#cb85-37" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb85-38"><a href="mod-td-control.html#cb85-38" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -11.7   226  1   </span></span>
<span id="cb85-39"><a href="mod-td-control.html#cb85-39" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -42.5    46  0.05</span></span>
<span id="cb85-40"><a href="mod-td-control.html#cb85-40" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -14.6  1015  0.95</span></span>
<span id="cb85-41"><a href="mod-td-control.html#cb85-41" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -46.2    66  0.05</span></span>
<span id="cb85-42"><a href="mod-td-control.html#cb85-42" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -28.9  1045  0.95</span></span>
<span id="cb85-43"><a href="mod-td-control.html#cb85-43" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -52.2   161  0.05</span></span>
<span id="cb85-44"><a href="mod-td-control.html#cb85-44" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -49.0   979  0.95</span></span>
<span id="cb85-45"><a href="mod-td-control.html#cb85-45" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -57.7  1358  0.95</span></span>
<span id="cb85-46"><a href="mod-td-control.html#cb85-46" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -64.8   104  0.05</span></span></code></pre></div>
<p>
All algorithms seems to approximate the best action with highest probability. Estimates differ a bit but are quite close. Note the SARSA algorithms approximate the epsilon-greed optimal policy.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#0xMHzzBLpFZK3dpXKTi9">
Solution
</button>
<ol start="4" style="list-style-type: decimal">
<li>Run the algorithms <code>gpiOnPolicySARSA</code>, <code>gpiOffPolicyQLearning</code> and <code>gpiOnPolicyExpSARSA</code> using <code>maxEL = 5000</code> and <code>alpha = 0.1</code>. Compare the policy and action-values against the state-values for the optimal deterministic policy found in Example <a href="mod-dp.html#exe-dp-storage">5.8</a>:</li>
</ol>
<pre><code>#&gt; # A tibble: 5 × 4
#&gt;   state     v action    pr
#&gt;   &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
#&gt; 1 0     -10.7 keep       1
#&gt; 2 1     -16.3 keep       1
#&gt; 3 2     -26.3 keep       1
#&gt; 4 3     -42.0 keep       1
#&gt; 5 4     -55.7 empty      1</code></pre>
<!-- Q5 -->
<div id="OcUXwSUMHcMmjpzRRAbN" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="OcUXwSUMHcMmjpzRRAbN-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="OcUXwSUMHcMmjpzRRAbN-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb87"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb87-1"><a href="mod-td-control.html#cb87-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">4756</span>)</span>
<span id="cb87-2"><a href="mod-td-control.html#cb87-2" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> <span class="dv">5000</span>, <span class="at">gamma =</span> <span class="fl">0.99</span>)</span>
<span id="cb87-3"><a href="mod-td-control.html#cb87-3" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>())</span>
<span id="cb87-4"><a href="mod-td-control.html#cb87-4" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb87-5"><a href="mod-td-control.html#cb87-5" tabindex="-1"></a><span class="co">#&gt;   state action     q     n    pr</span></span>
<span id="cb87-6"><a href="mod-td-control.html#cb87-6" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb87-7"><a href="mod-td-control.html#cb87-7" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -858.   301     1</span></span>
<span id="cb87-8"><a href="mod-td-control.html#cb87-8" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -882.   326    NA</span></span>
<span id="cb87-9"><a href="mod-td-control.html#cb87-9" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -881.  1009     1</span></span>
<span id="cb87-10"><a href="mod-td-control.html#cb87-10" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -894.   430    NA</span></span>
<span id="cb87-11"><a href="mod-td-control.html#cb87-11" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -893.   811     1</span></span>
<span id="cb87-12"><a href="mod-td-control.html#cb87-12" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -904.   562    NA</span></span>
<span id="cb87-13"><a href="mod-td-control.html#cb87-13" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -903.   469     1</span></span>
<span id="cb87-14"><a href="mod-td-control.html#cb87-14" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -919.   833     1</span></span>
<span id="cb87-15"><a href="mod-td-control.html#cb87-15" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -921.   259    NA</span></span>
<span id="cb87-16"><a href="mod-td-control.html#cb87-16" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">gamma =</span> <span class="fl">0.99</span>)</span>
<span id="cb87-17"><a href="mod-td-control.html#cb87-17" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>())</span>
<span id="cb87-18"><a href="mod-td-control.html#cb87-18" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb87-19"><a href="mod-td-control.html#cb87-19" tabindex="-1"></a><span class="co">#&gt;   state action      q     n    pr</span></span>
<span id="cb87-20"><a href="mod-td-control.html#cb87-20" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb87-21"><a href="mod-td-control.html#cb87-21" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -1349.   628     1</span></span>
<span id="cb87-22"><a href="mod-td-control.html#cb87-22" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -1371.   573    NA</span></span>
<span id="cb87-23"><a href="mod-td-control.html#cb87-23" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -1370.  2059     1</span></span>
<span id="cb87-24"><a href="mod-td-control.html#cb87-24" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -1383.   769     1</span></span>
<span id="cb87-25"><a href="mod-td-control.html#cb87-25" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -1385.  1737    NA</span></span>
<span id="cb87-26"><a href="mod-td-control.html#cb87-26" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -1395.  1161     1</span></span>
<span id="cb87-27"><a href="mod-td-control.html#cb87-27" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -1399.   931    NA</span></span>
<span id="cb87-28"><a href="mod-td-control.html#cb87-28" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -1400.  1739     1</span></span>
<span id="cb87-29"><a href="mod-td-control.html#cb87-29" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -1401.   403    NA</span></span>
<span id="cb87-30"><a href="mod-td-control.html#cb87-30" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> <span class="dv">40000</span>, <span class="at">gamma =</span> <span class="fl">0.99</span>)</span>
<span id="cb87-31"><a href="mod-td-control.html#cb87-31" tabindex="-1"></a><span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>())</span>
<span id="cb87-32"><a href="mod-td-control.html#cb87-32" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 5</span></span>
<span id="cb87-33"><a href="mod-td-control.html#cb87-33" tabindex="-1"></a><span class="co">#&gt;   state action      q     n    pr</span></span>
<span id="cb87-34"><a href="mod-td-control.html#cb87-34" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb87-35"><a href="mod-td-control.html#cb87-35" tabindex="-1"></a><span class="co">#&gt; 1 0     keep   -1763.  2333     1</span></span>
<span id="cb87-36"><a href="mod-td-control.html#cb87-36" tabindex="-1"></a><span class="co">#&gt; 2 1     empty  -1786.  1050    NA</span></span>
<span id="cb87-37"><a href="mod-td-control.html#cb87-37" tabindex="-1"></a><span class="co">#&gt; 3 1     keep   -1777.  9291     1</span></span>
<span id="cb87-38"><a href="mod-td-control.html#cb87-38" tabindex="-1"></a><span class="co">#&gt; 4 2     empty  -1796.  1524    NA</span></span>
<span id="cb87-39"><a href="mod-td-control.html#cb87-39" tabindex="-1"></a><span class="co">#&gt; 5 2     keep   -1791.  8908     1</span></span>
<span id="cb87-40"><a href="mod-td-control.html#cb87-40" tabindex="-1"></a><span class="co">#&gt; 6 3     empty  -1799.  6824     1</span></span>
<span id="cb87-41"><a href="mod-td-control.html#cb87-41" tabindex="-1"></a><span class="co">#&gt; 7 3     keep   -1813.  2588    NA</span></span>
<span id="cb87-42"><a href="mod-td-control.html#cb87-42" tabindex="-1"></a><span class="co">#&gt; 8 4     empty  -1809.  6740     1</span></span>
<span id="cb87-43"><a href="mod-td-control.html#cb87-43" tabindex="-1"></a><span class="co">#&gt; 9 4     keep   -1833.   742    NA</span></span></code></pre></div>
<p>
More iterations are needed here to get a good estimate of the state-values due to that we take into account rewards further out into the future.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#OcUXwSUMHcMmjpzRRAbN">
Solution
</button>
<ol start="5" style="list-style-type: decimal">
<li>Run the algorithm <code>gpiOffPolicyQLearning</code> using <code>gamma = 0.99</code>, <code>maxEL = 5000, 10000 and 20000</code>. Compare the policy and action-values against the state-values for the optimal deterministic policy found in Example <a href="mod-dp.html#exe-dp-storage">5.8</a>:</li>
</ol>
<pre><code>#&gt; # A tibble: 5 × 4
#&gt;   state      v action    pr
#&gt;   &lt;chr&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
#&gt; 1 0     -1750. keep       1
#&gt; 2 1     -1762. keep       1
#&gt; 3 2     -1776. keep       1
#&gt; 4 3     -1790. empty      1
#&gt; 5 4     -1795. empty      1</code></pre>
<!-- Q6 -->
<div id="RCKHu15fFj9MaRo05Wmz" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="RCKHu15fFj9MaRo05Wmz-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="RCKHu15fFj9MaRo05Wmz-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
Small alpha resembles the sample average while a large alpha put a larger weight on the present observations. This may result in larger fluctations in action-value estimates.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#RCKHu15fFj9MaRo05Wmz">
Solution
</button>
<ol start="6" style="list-style-type: decimal">
<li>How will the alpha value affect the rate of convergence?</li>
</ol>
</div>
<div id="ex-td-control-car" class="section level3 hasAnchor" number="8.7.2">
<h3><span class="header-section-number">8.7.2</span> Exercise - Car Rental<a href="mod-td-control.html#ex-td-control-car" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Consider the car rental problem in Exercise <a href="mod-mdp-2.html#ex-mdp-2-car">4.8.2</a> and <a href="mod-dp.html#ex-dp-rental">5.10.3</a>. An MDP model was formulated in Exercise <a href="mod-dp.html#ex-dp-rental">5.10.3</a> and solved using policy iteration. Our goal here is to solve the same problem with GPI using TD.</p>
<!-- MDP model -->
<!-- Q1 -->
<div id="b1bMmuSjIDDN4qMLVeFx" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="b1bMmuSjIDDN4qMLVeFx-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="b1bMmuSjIDDN4qMLVeFx-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb89"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb89-1"><a href="mod-td-control.html#cb89-1" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb89-2"><a href="mod-td-control.html#cb89-2" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb89-3"><a href="mod-td-control.html#cb89-3" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb89-4"><a href="mod-td-control.html#cb89-4" tabindex="-1"></a></span>
<span id="cb89-5"><a href="mod-td-control.html#cb89-5" tabindex="-1"></a><span class="co">#&#39; R6 Class representing the RL environment for the problem</span></span>
<span id="cb89-6"><a href="mod-td-control.html#cb89-6" tabindex="-1"></a>RLEnvCar <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">&quot;RLEnvCar&quot;</span>,</span>
<span id="cb89-7"><a href="mod-td-control.html#cb89-7" tabindex="-1"></a>   <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb89-8"><a href="mod-td-control.html#cb89-8" tabindex="-1"></a></span>
<span id="cb89-9"><a href="mod-td-control.html#cb89-9" tabindex="-1"></a>      <span class="co">#&#39; @field pr Mean demand rate at location 1 and 2.</span></span>
<span id="cb89-10"><a href="mod-td-control.html#cb89-10" tabindex="-1"></a>      <span class="at">lD =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">4</span>),</span>
<span id="cb89-11"><a href="mod-td-control.html#cb89-11" tabindex="-1"></a>      </span>
<span id="cb89-12"><a href="mod-td-control.html#cb89-12" tabindex="-1"></a>      <span class="co">#&#39; @field pr Mean return rate at location 1 and 2.</span></span>
<span id="cb89-13"><a href="mod-td-control.html#cb89-13" tabindex="-1"></a>      <span class="at">lH =</span> <span class="fu">c</span>(<span class="dv">3</span>,<span class="dv">2</span>),</span>
<span id="cb89-14"><a href="mod-td-control.html#cb89-14" tabindex="-1"></a>      </span>
<span id="cb89-15"><a href="mod-td-control.html#cb89-15" tabindex="-1"></a>      <span class="co">#&#39; @description Return all states (keys).</span></span>
<span id="cb89-16"><a href="mod-td-control.html#cb89-16" tabindex="-1"></a>      <span class="at">getStates =</span> <span class="cf">function</span>() {</span>
<span id="cb89-17"><a href="mod-td-control.html#cb89-17" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">x =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>, <span class="at">y =</span> <span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb89-18"><a href="mod-td-control.html#cb89-18" tabindex="-1"></a>            <span class="fu">mutate</span> (<span class="at">state =</span> <span class="fu">str_c</span>(x,<span class="st">&quot;,&quot;</span>,y)) <span class="sc">%&gt;%</span> </span>
<span id="cb89-19"><a href="mod-td-control.html#cb89-19" tabindex="-1"></a>            <span class="fu">pull</span>(state)</span>
<span id="cb89-20"><a href="mod-td-control.html#cb89-20" tabindex="-1"></a>         <span class="fu">return</span>(states)</span>
<span id="cb89-21"><a href="mod-td-control.html#cb89-21" tabindex="-1"></a>      },</span>
<span id="cb89-22"><a href="mod-td-control.html#cb89-22" tabindex="-1"></a>      </span>
<span id="cb89-23"><a href="mod-td-control.html#cb89-23" tabindex="-1"></a>      <span class="co">#&#39; @description Return all actions (keys) for a state.</span></span>
<span id="cb89-24"><a href="mod-td-control.html#cb89-24" tabindex="-1"></a>      <span class="co">#&#39; @param s State considered.</span></span>
<span id="cb89-25"><a href="mod-td-control.html#cb89-25" tabindex="-1"></a>      <span class="at">getActions =</span> <span class="cf">function</span>(s) {</span>
<span id="cb89-26"><a href="mod-td-control.html#cb89-26" tabindex="-1"></a>         x <span class="ot">&lt;-</span> <span class="fu">str_split</span>(s, <span class="st">&quot;,&quot;</span>, <span class="at">simplify =</span> T)</span>
<span id="cb89-27"><a href="mod-td-control.html#cb89-27" tabindex="-1"></a>         y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x[<span class="dv">2</span>])</span>
<span id="cb89-28"><a href="mod-td-control.html#cb89-28" tabindex="-1"></a>         x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x[<span class="dv">1</span>])</span>
<span id="cb89-29"><a href="mod-td-control.html#cb89-29" tabindex="-1"></a>         a <span class="ot">&lt;-</span> (<span class="sc">-</span><span class="fu">min</span>(<span class="dv">5</span>, y, <span class="dv">20</span><span class="sc">-</span>x))<span class="sc">:</span>(<span class="fu">min</span>(<span class="dv">5</span>, x, <span class="dv">20</span><span class="sc">-</span>y))</span>
<span id="cb89-30"><a href="mod-td-control.html#cb89-30" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">as.character</span>(a))</span>
<span id="cb89-31"><a href="mod-td-control.html#cb89-31" tabindex="-1"></a>      },</span>
<span id="cb89-32"><a href="mod-td-control.html#cb89-32" tabindex="-1"></a>      </span>
<span id="cb89-33"><a href="mod-td-control.html#cb89-33" tabindex="-1"></a>      <span class="co">#&#39; @description Returns the next state and reward given current state and action as a list (with names `r` and `sN`).</span></span>
<span id="cb89-34"><a href="mod-td-control.html#cb89-34" tabindex="-1"></a>      <span class="co">#&#39; @param s Current state.</span></span>
<span id="cb89-35"><a href="mod-td-control.html#cb89-35" tabindex="-1"></a>      <span class="co">#&#39; @param a Current action.</span></span>
<span id="cb89-36"><a href="mod-td-control.html#cb89-36" tabindex="-1"></a>      <span class="at">getTimeStepData =</span> <span class="cf">function</span>(s, a) {</span>
<span id="cb89-37"><a href="mod-td-control.html#cb89-37" tabindex="-1"></a>         x <span class="ot">&lt;-</span> <span class="fu">str_split</span>(s, <span class="st">&quot;,&quot;</span>, <span class="at">simplify =</span> T)</span>
<span id="cb89-38"><a href="mod-td-control.html#cb89-38" tabindex="-1"></a>         y <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x[<span class="dv">2</span>])</span>
<span id="cb89-39"><a href="mod-td-control.html#cb89-39" tabindex="-1"></a>         x <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(x[<span class="dv">1</span>])</span>
<span id="cb89-40"><a href="mod-td-control.html#cb89-40" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(a)</span>
<span id="cb89-41"><a href="mod-td-control.html#cb89-41" tabindex="-1"></a>         xBar <span class="ot">&lt;-</span> x<span class="sc">-</span>a</span>
<span id="cb89-42"><a href="mod-td-control.html#cb89-42" tabindex="-1"></a>         yBar <span class="ot">&lt;-</span> y<span class="sc">+</span>a</span>
<span id="cb89-43"><a href="mod-td-control.html#cb89-43" tabindex="-1"></a>         dX <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, self<span class="sc">$</span>lD[<span class="dv">1</span>])</span>
<span id="cb89-44"><a href="mod-td-control.html#cb89-44" tabindex="-1"></a>         dY <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, self<span class="sc">$</span>lD[<span class="dv">2</span>])</span>
<span id="cb89-45"><a href="mod-td-control.html#cb89-45" tabindex="-1"></a>         hX <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, self<span class="sc">$</span>lH[<span class="dv">1</span>])</span>
<span id="cb89-46"><a href="mod-td-control.html#cb89-46" tabindex="-1"></a>         hY <span class="ot">&lt;-</span> <span class="fu">rpois</span>(<span class="dv">1</span>, self<span class="sc">$</span>lH[<span class="dv">2</span>])</span>
<span id="cb89-47"><a href="mod-td-control.html#cb89-47" tabindex="-1"></a>         xN <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">20</span>, xBar <span class="sc">-</span> <span class="fu">min</span>(dX, xBar) <span class="sc">+</span> hX)</span>
<span id="cb89-48"><a href="mod-td-control.html#cb89-48" tabindex="-1"></a>         yN <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">20</span>, yBar <span class="sc">-</span> <span class="fu">min</span>(dY, yBar) <span class="sc">+</span> hY)</span>
<span id="cb89-49"><a href="mod-td-control.html#cb89-49" tabindex="-1"></a>         sN <span class="ot">&lt;-</span> <span class="fu">str_c</span>(xN, <span class="st">&quot;,&quot;</span>, yN)</span>
<span id="cb89-50"><a href="mod-td-control.html#cb89-50" tabindex="-1"></a>         r <span class="ot">&lt;-</span> <span class="dv">10</span> <span class="sc">*</span> (<span class="fu">min</span>(dX, xBar) <span class="sc">+</span> <span class="fu">min</span>(dY, yBar)) <span class="sc">-</span> <span class="dv">2</span> <span class="sc">*</span> <span class="fu">abs</span>(a)</span>
<span id="cb89-51"><a href="mod-td-control.html#cb89-51" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">r =</span> r, <span class="at">sN =</span> sN))</span>
<span id="cb89-52"><a href="mod-td-control.html#cb89-52" tabindex="-1"></a>      }</span>
<span id="cb89-53"><a href="mod-td-control.html#cb89-53" tabindex="-1"></a>   )</span>
<span id="cb89-54"><a href="mod-td-control.html#cb89-54" tabindex="-1"></a>)</span>
<span id="cb89-55"><a href="mod-td-control.html#cb89-55" tabindex="-1"></a>env <span class="ot">&lt;-</span> RLEnvCar<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb89-56"><a href="mod-td-control.html#cb89-56" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;0,0&quot;</span>, <span class="st">&quot;0&quot;</span>)</span>
<span id="cb89-57"><a href="mod-td-control.html#cb89-57" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb89-58"><a href="mod-td-control.html#cb89-58" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb89-59"><a href="mod-td-control.html#cb89-59" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb89-60"><a href="mod-td-control.html#cb89-60" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb89-61"><a href="mod-td-control.html#cb89-61" tabindex="-1"></a><span class="co">#&gt; [1] &quot;6,3&quot;</span></span>
<span id="cb89-62"><a href="mod-td-control.html#cb89-62" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;4,20&quot;</span>, <span class="st">&quot;-5&quot;</span>)</span>
<span id="cb89-63"><a href="mod-td-control.html#cb89-63" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb89-64"><a href="mod-td-control.html#cb89-64" tabindex="-1"></a><span class="co">#&gt; [1] 30</span></span>
<span id="cb89-65"><a href="mod-td-control.html#cb89-65" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb89-66"><a href="mod-td-control.html#cb89-66" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb89-67"><a href="mod-td-control.html#cb89-67" tabindex="-1"></a><span class="co">#&gt; [1] &quot;10,16&quot;</span></span>
<span id="cb89-68"><a href="mod-td-control.html#cb89-68" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getTimeStepData</span>(<span class="st">&quot;20,20&quot;</span>, <span class="st">&quot;14&quot;</span>)</span>
<span id="cb89-69"><a href="mod-td-control.html#cb89-69" tabindex="-1"></a><span class="co">#&gt; $r</span></span>
<span id="cb89-70"><a href="mod-td-control.html#cb89-70" tabindex="-1"></a><span class="co">#&gt; [1] 12</span></span>
<span id="cb89-71"><a href="mod-td-control.html#cb89-71" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb89-72"><a href="mod-td-control.html#cb89-72" tabindex="-1"></a><span class="co">#&gt; $sN</span></span>
<span id="cb89-73"><a href="mod-td-control.html#cb89-73" tabindex="-1"></a><span class="co">#&gt; [1] &quot;9,20&quot;</span></span></code></pre></div>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#b1bMmuSjIDDN4qMLVeFx">
Solution
</button>
<ol style="list-style-type: decimal">
<li>Code an environment representing the problem and test your <code>getTimeStepData</code> method.</li>
</ol>
<!-- Q2 -->
<div id="nDjYnP1ZLxHY0BemFjZS" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="nDjYnP1ZLxHY0BemFjZS-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="nDjYnP1ZLxHY0BemFjZS-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb90"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb90-1"><a href="mod-td-control.html#cb90-1" tabindex="-1"></a>agent <span class="ot">&lt;-</span> RLAgent<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb90-2"><a href="mod-td-control.html#cb90-2" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">addStates</span>(env<span class="sc">$</span><span class="fu">getStates</span>())   <span class="co"># add states</span></span>
<span id="cb90-3"><a href="mod-td-control.html#cb90-3" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> agent<span class="sc">$</span><span class="fu">getStateKeys</span>()) {  <span class="co"># add actions</span></span>
<span id="cb90-4"><a href="mod-td-control.html#cb90-4" tabindex="-1"></a>   agent<span class="sc">$</span><span class="fu">addActions</span>(s, env<span class="sc">$</span><span class="fu">getActions</span>(s))</span>
<span id="cb90-5"><a href="mod-td-control.html#cb90-5" tabindex="-1"></a>} </span>
<span id="cb90-6"><a href="mod-td-control.html#cb90-6" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionInfo</span>(<span class="st">&quot;0,0&quot;</span>)</span>
<span id="cb90-7"><a href="mod-td-control.html#cb90-7" tabindex="-1"></a><span class="co">#&gt; $`0`</span></span>
<span id="cb90-8"><a href="mod-td-control.html#cb90-8" tabindex="-1"></a><span class="co">#&gt; $`0`$q</span></span>
<span id="cb90-9"><a href="mod-td-control.html#cb90-9" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-10"><a href="mod-td-control.html#cb90-10" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-11"><a href="mod-td-control.html#cb90-11" tabindex="-1"></a><span class="co">#&gt; $`0`$n</span></span>
<span id="cb90-12"><a href="mod-td-control.html#cb90-12" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-13"><a href="mod-td-control.html#cb90-13" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionInfo</span>(<span class="st">&quot;8,2&quot;</span>)</span>
<span id="cb90-14"><a href="mod-td-control.html#cb90-14" tabindex="-1"></a><span class="co">#&gt; $`-1`</span></span>
<span id="cb90-15"><a href="mod-td-control.html#cb90-15" tabindex="-1"></a><span class="co">#&gt; $`-1`$q</span></span>
<span id="cb90-16"><a href="mod-td-control.html#cb90-16" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-17"><a href="mod-td-control.html#cb90-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-18"><a href="mod-td-control.html#cb90-18" tabindex="-1"></a><span class="co">#&gt; $`-1`$n</span></span>
<span id="cb90-19"><a href="mod-td-control.html#cb90-19" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-20"><a href="mod-td-control.html#cb90-20" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-21"><a href="mod-td-control.html#cb90-21" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-22"><a href="mod-td-control.html#cb90-22" tabindex="-1"></a><span class="co">#&gt; $`-2`</span></span>
<span id="cb90-23"><a href="mod-td-control.html#cb90-23" tabindex="-1"></a><span class="co">#&gt; $`-2`$q</span></span>
<span id="cb90-24"><a href="mod-td-control.html#cb90-24" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-25"><a href="mod-td-control.html#cb90-25" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-26"><a href="mod-td-control.html#cb90-26" tabindex="-1"></a><span class="co">#&gt; $`-2`$n</span></span>
<span id="cb90-27"><a href="mod-td-control.html#cb90-27" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-28"><a href="mod-td-control.html#cb90-28" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-29"><a href="mod-td-control.html#cb90-29" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-30"><a href="mod-td-control.html#cb90-30" tabindex="-1"></a><span class="co">#&gt; $`0`</span></span>
<span id="cb90-31"><a href="mod-td-control.html#cb90-31" tabindex="-1"></a><span class="co">#&gt; $`0`$q</span></span>
<span id="cb90-32"><a href="mod-td-control.html#cb90-32" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-33"><a href="mod-td-control.html#cb90-33" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-34"><a href="mod-td-control.html#cb90-34" tabindex="-1"></a><span class="co">#&gt; $`0`$n</span></span>
<span id="cb90-35"><a href="mod-td-control.html#cb90-35" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-36"><a href="mod-td-control.html#cb90-36" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-37"><a href="mod-td-control.html#cb90-37" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-38"><a href="mod-td-control.html#cb90-38" tabindex="-1"></a><span class="co">#&gt; $`1`</span></span>
<span id="cb90-39"><a href="mod-td-control.html#cb90-39" tabindex="-1"></a><span class="co">#&gt; $`1`$q</span></span>
<span id="cb90-40"><a href="mod-td-control.html#cb90-40" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-41"><a href="mod-td-control.html#cb90-41" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-42"><a href="mod-td-control.html#cb90-42" tabindex="-1"></a><span class="co">#&gt; $`1`$n</span></span>
<span id="cb90-43"><a href="mod-td-control.html#cb90-43" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-44"><a href="mod-td-control.html#cb90-44" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-45"><a href="mod-td-control.html#cb90-45" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-46"><a href="mod-td-control.html#cb90-46" tabindex="-1"></a><span class="co">#&gt; $`2`</span></span>
<span id="cb90-47"><a href="mod-td-control.html#cb90-47" tabindex="-1"></a><span class="co">#&gt; $`2`$q</span></span>
<span id="cb90-48"><a href="mod-td-control.html#cb90-48" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-49"><a href="mod-td-control.html#cb90-49" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-50"><a href="mod-td-control.html#cb90-50" tabindex="-1"></a><span class="co">#&gt; $`2`$n</span></span>
<span id="cb90-51"><a href="mod-td-control.html#cb90-51" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-52"><a href="mod-td-control.html#cb90-52" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-53"><a href="mod-td-control.html#cb90-53" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-54"><a href="mod-td-control.html#cb90-54" tabindex="-1"></a><span class="co">#&gt; $`3`</span></span>
<span id="cb90-55"><a href="mod-td-control.html#cb90-55" tabindex="-1"></a><span class="co">#&gt; $`3`$q</span></span>
<span id="cb90-56"><a href="mod-td-control.html#cb90-56" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-57"><a href="mod-td-control.html#cb90-57" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-58"><a href="mod-td-control.html#cb90-58" tabindex="-1"></a><span class="co">#&gt; $`3`$n</span></span>
<span id="cb90-59"><a href="mod-td-control.html#cb90-59" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-60"><a href="mod-td-control.html#cb90-60" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-61"><a href="mod-td-control.html#cb90-61" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-62"><a href="mod-td-control.html#cb90-62" tabindex="-1"></a><span class="co">#&gt; $`4`</span></span>
<span id="cb90-63"><a href="mod-td-control.html#cb90-63" tabindex="-1"></a><span class="co">#&gt; $`4`$q</span></span>
<span id="cb90-64"><a href="mod-td-control.html#cb90-64" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-65"><a href="mod-td-control.html#cb90-65" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-66"><a href="mod-td-control.html#cb90-66" tabindex="-1"></a><span class="co">#&gt; $`4`$n</span></span>
<span id="cb90-67"><a href="mod-td-control.html#cb90-67" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-68"><a href="mod-td-control.html#cb90-68" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-69"><a href="mod-td-control.html#cb90-69" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-70"><a href="mod-td-control.html#cb90-70" tabindex="-1"></a><span class="co">#&gt; $`5`</span></span>
<span id="cb90-71"><a href="mod-td-control.html#cb90-71" tabindex="-1"></a><span class="co">#&gt; $`5`$q</span></span>
<span id="cb90-72"><a href="mod-td-control.html#cb90-72" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-73"><a href="mod-td-control.html#cb90-73" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb90-74"><a href="mod-td-control.html#cb90-74" tabindex="-1"></a><span class="co">#&gt; $`5`$n</span></span>
<span id="cb90-75"><a href="mod-td-control.html#cb90-75" tabindex="-1"></a><span class="co">#&gt; [1] 0</span></span>
<span id="cb90-76"><a href="mod-td-control.html#cb90-76" tabindex="-1"></a></span>
<span id="cb90-77"><a href="mod-td-control.html#cb90-77" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicySARSA</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb90-78"><a href="mod-td-control.html#cb90-78" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (6,6,-1,78,8,6,5), r = 78 oldQ = 0 Q(sN, aN) = 0 newQ = 7.8</span></span>
<span id="cb90-79"><a href="mod-td-control.html#cb90-79" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (8,6,5,50,3,10,2), r = 50 oldQ = 0 Q(sN, aN) = 0 newQ = 5</span></span>
<span id="cb90-80"><a href="mod-td-control.html#cb90-80" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (3,10,2,26,5,12,1), r = 26 oldQ = 0 Q(sN, aN) = 0 newQ = 2.6</span></span>
<span id="cb90-81"><a href="mod-td-control.html#cb90-81" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (5,12,1,28,4,15,4), r = 28 oldQ = 0 Q(sN, aN) = 0 newQ = 2.8</span></span>
<span id="cb90-82"><a href="mod-td-control.html#cb90-82" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s,a) = (4,15,4,32,4,16,1), r = 32 oldQ = 0 Q(sN, aN) = 0 newQ = 3.2</span></span>
<span id="cb90-83"><a href="mod-td-control.html#cb90-83" tabindex="-1"></a><span class="fu">right_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb90-84"><a href="mod-td-control.html#cb90-84" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(q))</span>
<span id="cb90-85"><a href="mod-td-control.html#cb90-85" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3,701 × 5</span></span>
<span id="cb90-86"><a href="mod-td-control.html#cb90-86" tabindex="-1"></a><span class="co">#&gt;    state action     q     n     pr</span></span>
<span id="cb90-87"><a href="mod-td-control.html#cb90-87" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb90-88"><a href="mod-td-control.html#cb90-88" tabindex="-1"></a><span class="co">#&gt;  1 6,6   -1       7.8     1 0.909 </span></span>
<span id="cb90-89"><a href="mod-td-control.html#cb90-89" tabindex="-1"></a><span class="co">#&gt;  2 8,6   5        5       1 0.909 </span></span>
<span id="cb90-90"><a href="mod-td-control.html#cb90-90" tabindex="-1"></a><span class="co">#&gt;  3 4,15  4        3.2     1 0.91  </span></span>
<span id="cb90-91"><a href="mod-td-control.html#cb90-91" tabindex="-1"></a><span class="co">#&gt;  4 5,12  1        2.8     1 0.909 </span></span>
<span id="cb90-92"><a href="mod-td-control.html#cb90-92" tabindex="-1"></a><span class="co">#&gt;  5 3,10  2        2.6     1 0.911 </span></span>
<span id="cb90-93"><a href="mod-td-control.html#cb90-93" tabindex="-1"></a><span class="co">#&gt;  6 0,0   0        0       0 1     </span></span>
<span id="cb90-94"><a href="mod-td-control.html#cb90-94" tabindex="-1"></a><span class="co">#&gt;  7 0,1   -1       0       0 0.05  </span></span>
<span id="cb90-95"><a href="mod-td-control.html#cb90-95" tabindex="-1"></a><span class="co">#&gt;  8 0,1   0        0       0 0.95  </span></span>
<span id="cb90-96"><a href="mod-td-control.html#cb90-96" tabindex="-1"></a><span class="co">#&gt;  9 0,10  -1       0       0 0.0167</span></span>
<span id="cb90-97"><a href="mod-td-control.html#cb90-97" tabindex="-1"></a><span class="co">#&gt; 10 0,10  -2       0       0 0.0167</span></span>
<span id="cb90-98"><a href="mod-td-control.html#cb90-98" tabindex="-1"></a><span class="co">#&gt; # ℹ 3,691 more rows</span></span>
<span id="cb90-99"><a href="mod-td-control.html#cb90-99" tabindex="-1"></a></span>
<span id="cb90-100"><a href="mod-td-control.html#cb90-100" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb90-101"><a href="mod-td-control.html#cb90-101" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (0,1,-1,8,3,0), r = 8 oldQ = 0 maxQ(sN) = 0 newQ = 0.8</span></span>
<span id="cb90-102"><a href="mod-td-control.html#cb90-102" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,0,2,26,7,1), r = 26 oldQ = 0 maxQ(sN) = 0 newQ = 2.6</span></span>
<span id="cb90-103"><a href="mod-td-control.html#cb90-103" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (7,1,1,58,9,1), r = 58 oldQ = 0 maxQ(sN) = 0 newQ = 5.8</span></span>
<span id="cb90-104"><a href="mod-td-control.html#cb90-104" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (9,1,0,30,10,0), r = 30 oldQ = 0 maxQ(sN) = 0 newQ = 3</span></span>
<span id="cb90-105"><a href="mod-td-control.html#cb90-105" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (10,0,1,38,8,2), r = 38 oldQ = 0 maxQ(sN) = 0 newQ = 3.8</span></span>
<span id="cb90-106"><a href="mod-td-control.html#cb90-106" tabindex="-1"></a><span class="fu">right_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb90-107"><a href="mod-td-control.html#cb90-107" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(q))</span>
<span id="cb90-108"><a href="mod-td-control.html#cb90-108" tabindex="-1"></a><span class="co">#&gt; # A tibble: 441 × 5</span></span>
<span id="cb90-109"><a href="mod-td-control.html#cb90-109" tabindex="-1"></a><span class="co">#&gt;    state action     q     n    pr</span></span>
<span id="cb90-110"><a href="mod-td-control.html#cb90-110" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb90-111"><a href="mod-td-control.html#cb90-111" tabindex="-1"></a><span class="co">#&gt;  1 7,1   1        5.8     1     1</span></span>
<span id="cb90-112"><a href="mod-td-control.html#cb90-112" tabindex="-1"></a><span class="co">#&gt;  2 10,0  1        3.8     1     1</span></span>
<span id="cb90-113"><a href="mod-td-control.html#cb90-113" tabindex="-1"></a><span class="co">#&gt;  3 9,1   0        3       1     1</span></span>
<span id="cb90-114"><a href="mod-td-control.html#cb90-114" tabindex="-1"></a><span class="co">#&gt;  4 3,0   2        2.6     1     1</span></span>
<span id="cb90-115"><a href="mod-td-control.html#cb90-115" tabindex="-1"></a><span class="co">#&gt;  5 0,1   -1       0.8     1     1</span></span>
<span id="cb90-116"><a href="mod-td-control.html#cb90-116" tabindex="-1"></a><span class="co">#&gt;  6 0,0   0        0       0     1</span></span>
<span id="cb90-117"><a href="mod-td-control.html#cb90-117" tabindex="-1"></a><span class="co">#&gt;  7 0,10  -1       0       0     1</span></span>
<span id="cb90-118"><a href="mod-td-control.html#cb90-118" tabindex="-1"></a><span class="co">#&gt;  8 0,11  -1       0       0     1</span></span>
<span id="cb90-119"><a href="mod-td-control.html#cb90-119" tabindex="-1"></a><span class="co">#&gt;  9 0,12  -1       0       0     1</span></span>
<span id="cb90-120"><a href="mod-td-control.html#cb90-120" tabindex="-1"></a><span class="co">#&gt; 10 0,13  -1       0       0     1</span></span>
<span id="cb90-121"><a href="mod-td-control.html#cb90-121" tabindex="-1"></a><span class="co">#&gt; # ℹ 431 more rows</span></span>
<span id="cb90-122"><a href="mod-td-control.html#cb90-122" tabindex="-1"></a></span>
<span id="cb90-123"><a href="mod-td-control.html#cb90-123" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyExpSARSA</span>(env, <span class="at">maxEL =</span> <span class="dv">5</span>, <span class="at">verbose =</span> T, <span class="at">gamma =</span> <span class="fl">0.5</span>)</span>
<span id="cb90-124"><a href="mod-td-control.html#cb90-124" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (1,6,1,28,5,6), r = 28 oldQ = 0 expQ(sN) = 0 newQ = 2.8</span></span>
<span id="cb90-125"><a href="mod-td-control.html#cb90-125" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (5,6,-2,76,3,1), r = 76 oldQ = 0 expQ(sN) = 0 newQ = 7.6</span></span>
<span id="cb90-126"><a href="mod-td-control.html#cb90-126" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,1,2,26,1,5), r = 26 oldQ = 0 expQ(sN) = 0 newQ = 2.6</span></span>
<span id="cb90-127"><a href="mod-td-control.html#cb90-127" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (1,5,-4,32,3,1), r = 32 oldQ = 0 expQ(sN) = 2.39 newQ = 3.32</span></span>
<span id="cb90-128"><a href="mod-td-control.html#cb90-128" tabindex="-1"></a><span class="co">#&gt; (s,a,r,s) = (3,1,2,36,2,4), r = 36 oldQ = 2.6 expQ(sN) = 0 newQ = 5.94</span></span>
<span id="cb90-129"><a href="mod-td-control.html#cb90-129" tabindex="-1"></a><span class="fu">right_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb90-130"><a href="mod-td-control.html#cb90-130" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(q))</span>
<span id="cb90-131"><a href="mod-td-control.html#cb90-131" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3,701 × 5</span></span>
<span id="cb90-132"><a href="mod-td-control.html#cb90-132" tabindex="-1"></a><span class="co">#&gt;    state action     q     n     pr</span></span>
<span id="cb90-133"><a href="mod-td-control.html#cb90-133" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span></span>
<span id="cb90-134"><a href="mod-td-control.html#cb90-134" tabindex="-1"></a><span class="co">#&gt;  1 5,6   -2      7.6      1 0.909 </span></span>
<span id="cb90-135"><a href="mod-td-control.html#cb90-135" tabindex="-1"></a><span class="co">#&gt;  2 3,1   2       5.94     2 0.92  </span></span>
<span id="cb90-136"><a href="mod-td-control.html#cb90-136" tabindex="-1"></a><span class="co">#&gt;  3 1,5   -4      3.32     1 0.914 </span></span>
<span id="cb90-137"><a href="mod-td-control.html#cb90-137" tabindex="-1"></a><span class="co">#&gt;  4 1,6   1       2.8      1 0.914 </span></span>
<span id="cb90-138"><a href="mod-td-control.html#cb90-138" tabindex="-1"></a><span class="co">#&gt;  5 0,0   0       0        0 1     </span></span>
<span id="cb90-139"><a href="mod-td-control.html#cb90-139" tabindex="-1"></a><span class="co">#&gt;  6 0,1   -1      0        0 0.05  </span></span>
<span id="cb90-140"><a href="mod-td-control.html#cb90-140" tabindex="-1"></a><span class="co">#&gt;  7 0,1   0       0        0 0.95  </span></span>
<span id="cb90-141"><a href="mod-td-control.html#cb90-141" tabindex="-1"></a><span class="co">#&gt;  8 0,10  -1      0        0 0.917 </span></span>
<span id="cb90-142"><a href="mod-td-control.html#cb90-142" tabindex="-1"></a><span class="co">#&gt;  9 0,10  -2      0        0 0.0167</span></span>
<span id="cb90-143"><a href="mod-td-control.html#cb90-143" tabindex="-1"></a><span class="co">#&gt; 10 0,10  -3      0        0 0.0167</span></span>
<span id="cb90-144"><a href="mod-td-control.html#cb90-144" tabindex="-1"></a><span class="co">#&gt; # ℹ 3,691 more rows</span></span></code></pre></div>
<p>
It can be seen that we estimate the state values a few places since the state space is high and we only have done a few iterations.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#nDjYnP1ZLxHY0BemFjZS">
Solution
</button>
<ol start="2" style="list-style-type: decimal">
<li>Run the algorithms <code>gpiOnPolicySARSA</code>, <code>gpiOffPolicyQLearning</code> and <code>gpiOnPolicyExpSARSA</code> using a few iterations with a discount rate <span class="math inline">\(\gamma = 0.5\)</span>, <code>verbose = T</code> and explain the output.</li>
</ol>
<!-- Q3 -->
<div id="W7CXfbQ0QbbsLQv9hR6B" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="W7CXfbQ0QbbsLQv9hR6B-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="W7CXfbQ0QbbsLQv9hR6B-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb91"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb91-1"><a href="mod-td-control.html#cb91-1" tabindex="-1"></a>dfMDP <span class="ot">&lt;-</span> dfMDP05 <span class="sc">%&gt;%</span> <span class="fu">mutate</span> (<span class="at">aStar =</span> action, <span class="at">vMDP =</span> v) <span class="sc">%&gt;%</span> <span class="fu">select</span>(<span class="sc">-</span>action, <span class="sc">-</span>a, <span class="sc">-</span>v)</span>
<span id="cb91-2"><a href="mod-td-control.html#cb91-2" tabindex="-1"></a></span>
<span id="cb91-3"><a href="mod-td-control.html#cb91-3" tabindex="-1"></a><span class="co"># Generic test function</span></span>
<span id="cb91-4"><a href="mod-td-control.html#cb91-4" tabindex="-1"></a>runAlg <span class="ot">&lt;-</span> <span class="cf">function</span>(maxEL, gamma, alpha, eps, <span class="at">SARSA =</span> T, <span class="at">ExpSARSA =</span> T, <span class="at">QLear =</span> T, ...) {</span>
<span id="cb91-5"><a href="mod-td-control.html#cb91-5" tabindex="-1"></a>   dfRL <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb91-6"><a href="mod-td-control.html#cb91-6" tabindex="-1"></a>   <span class="cf">for</span> (ite <span class="cf">in</span> maxEL) {</span>
<span id="cb91-7"><a href="mod-td-control.html#cb91-7" tabindex="-1"></a>      <span class="cf">for</span> (gam <span class="cf">in</span> gamma) {</span>
<span id="cb91-8"><a href="mod-td-control.html#cb91-8" tabindex="-1"></a>         <span class="cf">for</span> (alph <span class="cf">in</span> alpha) {</span>
<span id="cb91-9"><a href="mod-td-control.html#cb91-9" tabindex="-1"></a>            <span class="cf">for</span> (e <span class="cf">in</span> eps) {</span>
<span id="cb91-10"><a href="mod-td-control.html#cb91-10" tabindex="-1"></a>               <span class="cf">if</span> (SARSA) {</span>
<span id="cb91-11"><a href="mod-td-control.html#cb91-11" tabindex="-1"></a>                  agent<span class="sc">$</span><span class="fu">gpiOnPolicySARSA</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e, ...)</span>
<span id="cb91-12"><a href="mod-td-control.html#cb91-12" tabindex="-1"></a>                  res <span class="ot">&lt;-</span> <span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb91-13"><a href="mod-td-control.html#cb91-13" tabindex="-1"></a>                     <span class="fu">separate</span>(state, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">remove =</span> F, <span class="at">convert =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb91-14"><a href="mod-td-control.html#cb91-14" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">&quot;SARSA ite = &quot;</span>, ite, <span class="st">&quot; gam = &quot;</span>, gam, <span class="st">&quot; alpha = &quot;</span>, alph, <span class="st">&quot; eps = &quot;</span>, e),</span>
<span id="cb91-15"><a href="mod-td-control.html#cb91-15" tabindex="-1"></a>                            <span class="at">alg =</span> <span class="st">&quot;SARSA&quot;</span>, <span class="at">iterations  =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e) <span class="sc">%&gt;%</span> </span>
<span id="cb91-16"><a href="mod-td-control.html#cb91-16" tabindex="-1"></a>                     <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb91-17"><a href="mod-td-control.html#cb91-17" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">nS =</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-18"><a href="mod-td-control.html#cb91-18" tabindex="-1"></a>                     <span class="fu">slice_max</span>(q, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> F) </span>
<span id="cb91-19"><a href="mod-td-control.html#cb91-19" tabindex="-1"></a>                  dfRL <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfRL, res) </span>
<span id="cb91-20"><a href="mod-td-control.html#cb91-20" tabindex="-1"></a>               }</span>
<span id="cb91-21"><a href="mod-td-control.html#cb91-21" tabindex="-1"></a>               <span class="cf">if</span> (ExpSARSA) {</span>
<span id="cb91-22"><a href="mod-td-control.html#cb91-22" tabindex="-1"></a>                  agent<span class="sc">$</span><span class="fu">gpiOnPolicyExpSARSA</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e, ...)</span>
<span id="cb91-23"><a href="mod-td-control.html#cb91-23" tabindex="-1"></a>                  res <span class="ot">&lt;-</span> <span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb91-24"><a href="mod-td-control.html#cb91-24" tabindex="-1"></a>                     <span class="fu">separate</span>(state, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">remove =</span> F, <span class="at">convert =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb91-25"><a href="mod-td-control.html#cb91-25" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">&quot;ExpSARSA ite = &quot;</span>, ite, <span class="st">&quot; gam = &quot;</span>, gam, <span class="st">&quot; alpha = &quot;</span>, alph, <span class="st">&quot; eps = &quot;</span>, e),</span>
<span id="cb91-26"><a href="mod-td-control.html#cb91-26" tabindex="-1"></a>                            <span class="at">alg =</span> <span class="st">&quot;ExpSARSA&quot;</span>, <span class="at">iterations  =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e) <span class="sc">%&gt;%</span> </span>
<span id="cb91-27"><a href="mod-td-control.html#cb91-27" tabindex="-1"></a>                     <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb91-28"><a href="mod-td-control.html#cb91-28" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">nS =</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-29"><a href="mod-td-control.html#cb91-29" tabindex="-1"></a>                     <span class="fu">slice_max</span>(q, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> F) </span>
<span id="cb91-30"><a href="mod-td-control.html#cb91-30" tabindex="-1"></a>                  dfRL <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfRL, res) </span>
<span id="cb91-31"><a href="mod-td-control.html#cb91-31" tabindex="-1"></a>               }</span>
<span id="cb91-32"><a href="mod-td-control.html#cb91-32" tabindex="-1"></a>               <span class="cf">if</span> (QLear) {</span>
<span id="cb91-33"><a href="mod-td-control.html#cb91-33" tabindex="-1"></a>                  agent<span class="sc">$</span><span class="fu">gpiOffPolicyQLearning</span>(env, <span class="at">maxEL =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e, ...)</span>
<span id="cb91-34"><a href="mod-td-control.html#cb91-34" tabindex="-1"></a>                  res <span class="ot">&lt;-</span> <span class="fu">left_join</span>(agent<span class="sc">$</span><span class="fu">getActionValues</span>(), agent<span class="sc">$</span><span class="fu">getPolicy</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb91-35"><a href="mod-td-control.html#cb91-35" tabindex="-1"></a>                     <span class="fu">separate</span>(state, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>), <span class="at">sep =</span> <span class="st">&quot;,&quot;</span>, <span class="at">remove =</span> F, <span class="at">convert =</span> T) <span class="sc">%&gt;%</span> </span>
<span id="cb91-36"><a href="mod-td-control.html#cb91-36" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">label =</span> <span class="fu">str_c</span>(<span class="st">&quot;SARSA ite = &quot;</span>, ite, <span class="st">&quot; gam = &quot;</span>, gam, <span class="st">&quot; alpha = &quot;</span>, alph, <span class="st">&quot; eps = &quot;</span>, e),</span>
<span id="cb91-37"><a href="mod-td-control.html#cb91-37" tabindex="-1"></a>                            <span class="at">alg =</span> <span class="st">&quot;QLear&quot;</span>, <span class="at">iterations  =</span> ite, <span class="at">gamma =</span> gam, <span class="at">alpha =</span> alph, <span class="at">eps =</span> e) <span class="sc">%&gt;%</span> </span>
<span id="cb91-38"><a href="mod-td-control.html#cb91-38" tabindex="-1"></a>                     <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> </span>
<span id="cb91-39"><a href="mod-td-control.html#cb91-39" tabindex="-1"></a>                     <span class="fu">mutate</span>(<span class="at">nS =</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span> </span>
<span id="cb91-40"><a href="mod-td-control.html#cb91-40" tabindex="-1"></a>                     <span class="fu">slice_max</span>(q, <span class="at">n =</span> <span class="dv">1</span>, <span class="at">with_ties =</span> F) </span>
<span id="cb91-41"><a href="mod-td-control.html#cb91-41" tabindex="-1"></a>                  dfRL <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfRL, res) </span>
<span id="cb91-42"><a href="mod-td-control.html#cb91-42" tabindex="-1"></a>               }</span>
<span id="cb91-43"><a href="mod-td-control.html#cb91-43" tabindex="-1"></a>            }</span>
<span id="cb91-44"><a href="mod-td-control.html#cb91-44" tabindex="-1"></a>         }</span>
<span id="cb91-45"><a href="mod-td-control.html#cb91-45" tabindex="-1"></a>      }</span>
<span id="cb91-46"><a href="mod-td-control.html#cb91-46" tabindex="-1"></a>   }</span>
<span id="cb91-47"><a href="mod-td-control.html#cb91-47" tabindex="-1"></a>   dfRL <span class="ot">&lt;-</span> dfRL <span class="sc">%&gt;%</span> </span>
<span id="cb91-48"><a href="mod-td-control.html#cb91-48" tabindex="-1"></a>      <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb91-49"><a href="mod-td-control.html#cb91-49" tabindex="-1"></a>      <span class="fu">select</span>(x, y, <span class="at">a =</span> action, <span class="at">n =</span> nS, alg, q, iterations, gamma, alpha, eps) </span>
<span id="cb91-50"><a href="mod-td-control.html#cb91-50" tabindex="-1"></a>   <span class="do">## print rms</span></span>
<span id="cb91-51"><a href="mod-td-control.html#cb91-51" tabindex="-1"></a>   dfRMS <span class="ot">&lt;-</span> <span class="fu">left_join</span>(dfRL, dfMDP) <span class="sc">%&gt;%</span> </span>
<span id="cb91-52"><a href="mod-td-control.html#cb91-52" tabindex="-1"></a>      <span class="fu">group_by</span>(alg, iterations, gamma, alpha, eps) <span class="sc">%&gt;%</span> </span>
<span id="cb91-53"><a href="mod-td-control.html#cb91-53" tabindex="-1"></a>      <span class="fu">summarise</span>(<span class="at">rms =</span> <span class="fu">sqrt</span>(<span class="dv">1</span><span class="sc">/</span><span class="fu">n</span>() <span class="sc">*</span> <span class="fu">sum</span>(q<span class="sc">-</span>vMDP)<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">%&gt;%</span> print</span>
<span id="cb91-54"><a href="mod-td-control.html#cb91-54" tabindex="-1"></a>   <span class="fu">return</span>(dfRL <span class="sc">%&gt;%</span> <span class="fu">filter</span>(n <span class="sc">&gt;</span> <span class="dv">0</span>))</span>
<span id="cb91-55"><a href="mod-td-control.html#cb91-55" tabindex="-1"></a>}</span>
<span id="cb91-56"><a href="mod-td-control.html#cb91-56" tabindex="-1"></a></span>
<span id="cb91-57"><a href="mod-td-control.html#cb91-57" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">9833</span>)</span>
<span id="cb91-58"><a href="mod-td-control.html#cb91-58" tabindex="-1"></a>dfRL1 <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="fu">c</span>(<span class="dv">25000</span>, <span class="dv">50000</span>, <span class="dv">100000</span>), <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">eps =</span> <span class="fl">0.1</span>)</span>
<span id="cb91-59"><a href="mod-td-control.html#cb91-59" tabindex="-1"></a><span class="co">#&gt; # A tibble: 9 × 6</span></span>
<span id="cb91-60"><a href="mod-td-control.html#cb91-60" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [9]</span></span>
<span id="cb91-61"><a href="mod-td-control.html#cb91-61" tabindex="-1"></a><span class="co">#&gt;   alg      iterations gamma alpha   eps   rms</span></span>
<span id="cb91-62"><a href="mod-td-control.html#cb91-62" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;         &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb91-63"><a href="mod-td-control.html#cb91-63" tabindex="-1"></a><span class="co">#&gt; 1 ExpSARSA      25000   0.5   0.1   0.1 1724.</span></span>
<span id="cb91-64"><a href="mod-td-control.html#cb91-64" tabindex="-1"></a><span class="co">#&gt; 2 ExpSARSA      50000   0.5   0.1   0.1 1469.</span></span>
<span id="cb91-65"><a href="mod-td-control.html#cb91-65" tabindex="-1"></a><span class="co">#&gt; 3 ExpSARSA     100000   0.5   0.1   0.1 1265.</span></span>
<span id="cb91-66"><a href="mod-td-control.html#cb91-66" tabindex="-1"></a><span class="co">#&gt; 4 QLear         25000   0.5   0.1   0.1 1653.</span></span>
<span id="cb91-67"><a href="mod-td-control.html#cb91-67" tabindex="-1"></a><span class="co">#&gt; 5 QLear         50000   0.5   0.1   0.1 1461.</span></span>
<span id="cb91-68"><a href="mod-td-control.html#cb91-68" tabindex="-1"></a><span class="co">#&gt; 6 QLear        100000   0.5   0.1   0.1 1191.</span></span>
<span id="cb91-69"><a href="mod-td-control.html#cb91-69" tabindex="-1"></a><span class="co">#&gt; 7 SARSA         25000   0.5   0.1   0.1 1739.</span></span>
<span id="cb91-70"><a href="mod-td-control.html#cb91-70" tabindex="-1"></a><span class="co">#&gt; 8 SARSA         50000   0.5   0.1   0.1 1435.</span></span>
<span id="cb91-71"><a href="mod-td-control.html#cb91-71" tabindex="-1"></a><span class="co">#&gt; 9 SARSA        100000   0.5   0.1   0.1 1310.</span></span>
<span id="cb91-72"><a href="mod-td-control.html#cb91-72" tabindex="-1"></a></span>
<span id="cb91-73"><a href="mod-td-control.html#cb91-73" tabindex="-1"></a><span class="fu">ggplot</span>(dfRL1, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> x, <span class="at">col =</span> a, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb91-74"><a href="mod-td-control.html#cb91-74" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb91-75"><a href="mod-td-control.html#cb91-75" tabindex="-1"></a>      <span class="fu">facet_grid</span>(alg<span class="sc">~</span>iterations, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">alg =</span> <span class="fu">label_wrap_gen</span>(<span class="dv">30</span>))) <span class="sc">+</span></span>
<span id="cb91-76"><a href="mod-td-control.html#cb91-76" tabindex="-1"></a>      <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="sc">+</span> </span>
<span id="cb91-77"><a href="mod-td-control.html#cb91-77" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_c</span>(<span class="st">&quot;Run with q=0 ini values&quot;</span>)) <span class="sc">+</span></span>
<span id="cb91-78"><a href="mod-td-control.html#cb91-78" tabindex="-1"></a>      <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code></pre></div>
<p><img src="08_td-control_files/figure-html/unnamed-chunk-22-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#W7CXfbQ0QbbsLQv9hR6B">
Solution
</button>
<ol start="3" style="list-style-type: decimal">
<li>Run the algorithms <code>gpiOnPolicySARSA</code>, <code>gpiOffPolicyQLearning</code> and <code>gpiOnPolicyExpSARSA</code> with a discount rate <span class="math inline">\(\gamma = 0.5\)</span> using a high number of iterations, e.g. 25000, 50000 and 100000. Compare the policy with the optimal deterministic policy found in Exercise <a href="mod-dp.html#ex-dp-rental">5.10.3</a>, e.g. make a plot of the optimal policy with <span class="math inline">\(x\)</span> on the y-axis and <span class="math inline">\(y\)</span> on the x-axis, plotting the action:</li>
</ol>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb92-1"><a href="mod-td-control.html#cb92-1" tabindex="-1"></a><span class="fu">ggplot</span>(dfMDP05, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> x, <span class="at">col =</span> <span class="fu">factor</span>(a))) <span class="sc">+</span></span>
<span id="cb92-2"><a href="mod-td-control.html#cb92-2" tabindex="-1"></a>      <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb92-3"><a href="mod-td-control.html#cb92-3" tabindex="-1"></a>      <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="sc">+</span> </span>
<span id="cb92-4"><a href="mod-td-control.html#cb92-4" tabindex="-1"></a>      <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_c</span>(<span class="st">&quot;Optimal MDP policy&quot;</span>)) </span></code></pre></div>
<p><img src="08_td-control_files/figure-html/unnamed-chunk-23-1.png" width="672" style="display: block; margin: auto;" /></p>
<!-- Q4 -->
<div id="ShBZYSiiyTBofpBzevrj" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="ShBZYSiiyTBofpBzevrj-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="ShBZYSiiyTBofpBzevrj-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb93"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb93-1"><a href="mod-td-control.html#cb93-1" tabindex="-1"></a>dfRL1 <span class="sc">%&gt;%</span> </span>
<span id="cb93-2"><a href="mod-td-control.html#cb93-2" tabindex="-1"></a>   <span class="fu">filter</span>(((x <span class="sc">==</span> <span class="dv">5</span> <span class="sc">&amp;</span> y <span class="sc">==</span> <span class="dv">5</span>) <span class="sc">|</span> (x <span class="sc">==</span> <span class="dv">15</span> <span class="sc">&amp;</span> y <span class="sc">==</span> <span class="dv">18</span>)) <span class="sc">&amp;</span> iterations <span class="sc">==</span> <span class="dv">100000</span> <span class="sc">&amp;</span> alg <span class="sc">==</span> <span class="st">&quot;QLear&quot;</span>)</span>
<span id="cb93-3"><a href="mod-td-control.html#cb93-3" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 10</span></span>
<span id="cb93-4"><a href="mod-td-control.html#cb93-4" tabindex="-1"></a><span class="co">#&gt;       x     y a         n alg       q iterations gamma alpha   eps</span></span>
<span id="cb93-5"><a href="mod-td-control.html#cb93-5" tabindex="-1"></a><span class="co">#&gt;   &lt;int&gt; &lt;int&gt; &lt;chr&gt; &lt;dbl&gt; &lt;chr&gt; &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb93-6"><a href="mod-td-control.html#cb93-6" tabindex="-1"></a><span class="co">#&gt; 1    15    18 -5        1 QLear  10.1     100000   0.5   0.1   0.1</span></span>
<span id="cb93-7"><a href="mod-td-control.html#cb93-7" tabindex="-1"></a><span class="co">#&gt; 2     5     5 3       820 QLear 101.      100000   0.5   0.1   0.1</span></span></code></pre></div>
<p>
In state <span class="math inline">\((5,5)\)</span> and <span class="math inline">\((15,18)\)</span> the best action is 3 and -5, respectively. However, these actions have been approximated quite differently. In state <span class="math inline">\((5,5)\)</span> the best action-value is 101, i.e. the weighted average of the total discounted return. It is based on 820 samples of that state while for state <span class="math inline">\((15,18)\)</span> we only have estimated the best action-value using a single visit to that state.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#ShBZYSiiyTBofpBzevrj">
Solution
</button>
<ol start="4" style="list-style-type: decimal">
<li>Consider Q-learning with 100000 iterations. What is the optimal action in state <span class="math inline">\((5,5)\)</span>? What is the state-value in state <span class="math inline">\((5,5)\)</span> and <span class="math inline">\((15,18)\)</span> and its interpretation?</li>
</ol>
<!-- Q5 -->
<div id="id_36UK3GuKMpxgalatSXoV" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="36UK3GuKMpxgalatSXoV-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="36UK3GuKMpxgalatSXoV-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb94"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb94-1"><a href="mod-td-control.html#cb94-1" tabindex="-1"></a>setQToVStar <span class="ot">&lt;-</span> <span class="cf">function</span>(dfMDP) {</span>
<span id="cb94-2"><a href="mod-td-control.html#cb94-2" tabindex="-1"></a>   <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(dfMDP)) {</span>
<span id="cb94-3"><a href="mod-td-control.html#cb94-3" tabindex="-1"></a>      s <span class="ot">&lt;-</span> dfMDP<span class="sc">$</span>state[i]</span>
<span id="cb94-4"><a href="mod-td-control.html#cb94-4" tabindex="-1"></a>      q <span class="ot">&lt;-</span> dfMDP<span class="sc">$</span>v[i]</span>
<span id="cb94-5"><a href="mod-td-control.html#cb94-5" tabindex="-1"></a>      <span class="cf">for</span> (a <span class="cf">in</span> agent<span class="sc">$</span><span class="fu">getActionKeys</span>(s)) {</span>
<span id="cb94-6"><a href="mod-td-control.html#cb94-6" tabindex="-1"></a>         agent<span class="sc">$</span><span class="fu">setActionValueSingle</span>(q,<span class="dv">0</span>,s,a)</span>
<span id="cb94-7"><a href="mod-td-control.html#cb94-7" tabindex="-1"></a>      }</span>
<span id="cb94-8"><a href="mod-td-control.html#cb94-8" tabindex="-1"></a>   }</span>
<span id="cb94-9"><a href="mod-td-control.html#cb94-9" tabindex="-1"></a>}</span>
<span id="cb94-10"><a href="mod-td-control.html#cb94-10" tabindex="-1"></a><span class="fu">setQToVStar</span>(dfMDP05)</span>
<span id="cb94-11"><a href="mod-td-control.html#cb94-11" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="dv">25000</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">SARSA =</span> F, <span class="at">ExpSARSA =</span> F, <span class="at">reset =</span> F)</span>
<span id="cb94-12"><a href="mod-td-control.html#cb94-12" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span id="cb94-13"><a href="mod-td-control.html#cb94-13" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [1]</span></span>
<span id="cb94-14"><a href="mod-td-control.html#cb94-14" tabindex="-1"></a><span class="co">#&gt;   alg   iterations gamma alpha   eps   rms</span></span>
<span id="cb94-15"><a href="mod-td-control.html#cb94-15" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb94-16"><a href="mod-td-control.html#cb94-16" tabindex="-1"></a><span class="co">#&gt; 1 QLear      25000   0.5   0.1   0.1  18.7</span></span>
<span id="cb94-17"><a href="mod-td-control.html#cb94-17" tabindex="-1"></a><span class="fu">setQToVStar</span>(dfMDP05)</span>
<span id="cb94-18"><a href="mod-td-control.html#cb94-18" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="dv">50000</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">SARSA =</span> F, <span class="at">ExpSARSA =</span> F, <span class="at">reset =</span> F)</span>
<span id="cb94-19"><a href="mod-td-control.html#cb94-19" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span id="cb94-20"><a href="mod-td-control.html#cb94-20" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [1]</span></span>
<span id="cb94-21"><a href="mod-td-control.html#cb94-21" tabindex="-1"></a><span class="co">#&gt;   alg   iterations gamma alpha   eps   rms</span></span>
<span id="cb94-22"><a href="mod-td-control.html#cb94-22" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb94-23"><a href="mod-td-control.html#cb94-23" tabindex="-1"></a><span class="co">#&gt; 1 QLear      50000   0.5   0.1   0.1  25.6</span></span>
<span id="cb94-24"><a href="mod-td-control.html#cb94-24" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfRL, res)</span>
<span id="cb94-25"><a href="mod-td-control.html#cb94-25" tabindex="-1"></a><span class="fu">setQToVStar</span>(dfMDP05)</span>
<span id="cb94-26"><a href="mod-td-control.html#cb94-26" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="dv">100000</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">SARSA =</span> F, <span class="at">ExpSARSA =</span> F, <span class="at">reset =</span> F)</span>
<span id="cb94-27"><a href="mod-td-control.html#cb94-27" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 6</span></span>
<span id="cb94-28"><a href="mod-td-control.html#cb94-28" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [1]</span></span>
<span id="cb94-29"><a href="mod-td-control.html#cb94-29" tabindex="-1"></a><span class="co">#&gt;   alg   iterations gamma alpha   eps   rms</span></span>
<span id="cb94-30"><a href="mod-td-control.html#cb94-30" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb94-31"><a href="mod-td-control.html#cb94-31" tabindex="-1"></a><span class="co">#&gt; 1 QLear     100000   0.5   0.1   0.1  36.7</span></span>
<span id="cb94-32"><a href="mod-td-control.html#cb94-32" tabindex="-1"></a>dfRL2 <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(dfRL, res)</span>
<span id="cb94-33"><a href="mod-td-control.html#cb94-33" tabindex="-1"></a><span class="fu">ggplot</span>(dfRL2, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> x, <span class="at">col =</span> a, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb94-34"><a href="mod-td-control.html#cb94-34" tabindex="-1"></a>   <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb94-35"><a href="mod-td-control.html#cb94-35" tabindex="-1"></a>   <span class="fu">facet_grid</span>(alg<span class="sc">~</span>iterations, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">alg =</span> <span class="fu">label_wrap_gen</span>(<span class="dv">30</span>))) <span class="sc">+</span></span>
<span id="cb94-36"><a href="mod-td-control.html#cb94-36" tabindex="-1"></a>   <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="sc">+</span> </span>
<span id="cb94-37"><a href="mod-td-control.html#cb94-37" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_c</span>(<span class="st">&quot;Run with v* values&quot;</span>)) <span class="sc">+</span></span>
<span id="cb94-38"><a href="mod-td-control.html#cb94-38" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code></pre></div>
<p><img src="08_td-control_files/figure-html/unnamed-chunk-25-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#36UK3GuKMpxgalatSXoV">
Solution
</button>
<ol start="5" style="list-style-type: decimal">
<li>Run the algorithm <code>gpiOffPolicyQLearning</code> with a discount rate <span class="math inline">\(\gamma = 0.5\)</span> using a high number of iterations, e.g. 25000, 50000 and 100000. However set the start actions-values equal to the optimal state-value in a state found by the MDP. Compare the policy with the policies found in Question 3.</li>
</ol>
<!-- Q6 -->
<div id="id_55KAjeVowvw7akEShDgB" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="55KAjeVowvw7akEShDgB-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="55KAjeVowvw7akEShDgB-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb95"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb95-1"><a href="mod-td-control.html#cb95-1" tabindex="-1"></a>dfRL3 <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="dv">100000</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">eps =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.5</span>, <span class="dv">1</span>), <span class="at">SARSA =</span> F, <span class="at">ExpSARSA =</span> F)</span>
<span id="cb95-2"><a href="mod-td-control.html#cb95-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 6</span></span>
<span id="cb95-3"><a href="mod-td-control.html#cb95-3" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [1]</span></span>
<span id="cb95-4"><a href="mod-td-control.html#cb95-4" tabindex="-1"></a><span class="co">#&gt;   alg   iterations gamma alpha   eps   rms</span></span>
<span id="cb95-5"><a href="mod-td-control.html#cb95-5" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb95-6"><a href="mod-td-control.html#cb95-6" tabindex="-1"></a><span class="co">#&gt; 1 QLear     100000   0.5   0.1   0.2 1235.</span></span>
<span id="cb95-7"><a href="mod-td-control.html#cb95-7" tabindex="-1"></a><span class="co">#&gt; 2 QLear     100000   0.5   0.1   0.5 1358.</span></span>
<span id="cb95-8"><a href="mod-td-control.html#cb95-8" tabindex="-1"></a><span class="co">#&gt; 3 QLear     100000   0.5   0.1   1   1476.</span></span>
<span id="cb95-9"><a href="mod-td-control.html#cb95-9" tabindex="-1"></a><span class="fu">ggplot</span>(dfRL3, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> x, <span class="at">col =</span> a, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb95-10"><a href="mod-td-control.html#cb95-10" tabindex="-1"></a>   <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb95-11"><a href="mod-td-control.html#cb95-11" tabindex="-1"></a>   <span class="fu">facet_grid</span>(alg<span class="sc">~</span>eps, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">alg =</span> <span class="fu">label_wrap_gen</span>(<span class="dv">30</span>))) <span class="sc">+</span></span>
<span id="cb95-12"><a href="mod-td-control.html#cb95-12" tabindex="-1"></a>   <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="sc">+</span> </span>
<span id="cb95-13"><a href="mod-td-control.html#cb95-13" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_c</span>(<span class="st">&quot;Run with q=0 ini values&quot;</span>)) <span class="sc">+</span></span>
<span id="cb95-14"><a href="mod-td-control.html#cb95-14" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code></pre></div>
<p><img src="08_td-control_files/figure-html/unnamed-chunk-26-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#55KAjeVowvw7akEShDgB">
Solution
</button>
<ol start="6" style="list-style-type: decimal">
<li>Run the algorithm <code>gpiOffPolicyQLearning</code> with a discount rate <span class="math inline">\(\gamma = 0.5\)</span> and 100000 iterations. Test the effect of different epsilon-greedy behaviour policies, e.g. epsilon = 0.2, 0.5 and 1.</li>
</ol>
<!-- Q7 -->
<div id="DrcIlpdfpY2SW8oG0hpR" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="DrcIlpdfpY2SW8oG0hpR-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title" id="DrcIlpdfpY2SW8oG0hpR-title">
Solution
</h4>
</div>
<div class="modal-body">
<div class="sourceCode" id="cb96"><pre class="sourceCode r fold-show"><code class="sourceCode r"><span id="cb96-1"><a href="mod-td-control.html#cb96-1" tabindex="-1"></a>dfRL4 <span class="ot">&lt;-</span> <span class="fu">runAlg</span>(<span class="at">maxEL =</span> <span class="dv">100000</span>, <span class="at">gamma =</span> <span class="fl">0.5</span>, <span class="at">alpha =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.2</span>, <span class="fl">0.5</span>), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">SARSA =</span> F, <span class="at">ExpSARSA =</span> F)</span>
<span id="cb96-2"><a href="mod-td-control.html#cb96-2" tabindex="-1"></a><span class="co">#&gt; # A tibble: 3 × 6</span></span>
<span id="cb96-3"><a href="mod-td-control.html#cb96-3" tabindex="-1"></a><span class="co">#&gt; # Groups:   alg, iterations, gamma, alpha [3]</span></span>
<span id="cb96-4"><a href="mod-td-control.html#cb96-4" tabindex="-1"></a><span class="co">#&gt;   alg   iterations gamma alpha   eps   rms</span></span>
<span id="cb96-5"><a href="mod-td-control.html#cb96-5" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb96-6"><a href="mod-td-control.html#cb96-6" tabindex="-1"></a><span class="co">#&gt; 1 QLear     100000   0.5  0.05   0.1 1458.</span></span>
<span id="cb96-7"><a href="mod-td-control.html#cb96-7" tabindex="-1"></a><span class="co">#&gt; 2 QLear     100000   0.5  0.2    0.1 1068.</span></span>
<span id="cb96-8"><a href="mod-td-control.html#cb96-8" tabindex="-1"></a><span class="co">#&gt; 3 QLear     100000   0.5  0.5    0.1  836.</span></span>
<span id="cb96-9"><a href="mod-td-control.html#cb96-9" tabindex="-1"></a><span class="fu">ggplot</span>(dfRL4, <span class="fu">aes</span>(<span class="at">x =</span> y, <span class="at">y =</span> x, <span class="at">col =</span> a, <span class="at">size =</span> n)) <span class="sc">+</span></span>
<span id="cb96-10"><a href="mod-td-control.html#cb96-10" tabindex="-1"></a>   <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb96-11"><a href="mod-td-control.html#cb96-11" tabindex="-1"></a>   <span class="fu">facet_wrap</span>(alg<span class="sc">~</span>alpha, <span class="at">labeller =</span> <span class="fu">labeller</span>(<span class="at">alg =</span> <span class="fu">label_wrap_gen</span>(<span class="dv">30</span>))) <span class="sc">+</span></span>
<span id="cb96-12"><a href="mod-td-control.html#cb96-12" tabindex="-1"></a>   <span class="fu">scale_fill_brewer</span>(<span class="at">palette =</span> <span class="st">&quot;Set2&quot;</span>) <span class="sc">+</span> </span>
<span id="cb96-13"><a href="mod-td-control.html#cb96-13" tabindex="-1"></a>   <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">str_c</span>(<span class="st">&quot;Run with q=0 ini values&quot;</span>)) <span class="sc">+</span></span>
<span id="cb96-14"><a href="mod-td-control.html#cb96-14" tabindex="-1"></a>   <span class="fu">theme</span>(<span class="at">strip.text.x =</span> <span class="fu">element_text</span>(<span class="at">size =</span> <span class="dv">5</span>))</span></code></pre></div>
<p><img src="08_td-control_files/figure-html/unnamed-chunk-27-1.png" width="960" style="display: block; margin: auto;" /></p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#DrcIlpdfpY2SW8oG0hpR">
Solution
</button>
<ol start="7" style="list-style-type: decimal">
<li>Run the algorithm <code>gpiOffPolicyQLearning</code> with a discount rate <span class="math inline">\(\gamma = 0.5\)</span> and 100000 iterations. Test the effect of different step-sizes, e.g. alpha = 0.05, 0.2, 0.5.</li>
</ol>

</div>
</div>
</div>



<h3>References</h3>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Sutton18" class="csl-entry">
Sutton, R. S., and A. G. Barto. 2018. <em>Reinforcement Learning: An Introduction</em>. Second Edition. MIT Press. <a href="http://incompleteideas.net/book/the-book.html">http://incompleteideas.net/book/the-book.html</a>.
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="mod-td-pred.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="mod-r-setup.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": false,
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/bss-osca/rl/edit/master/book/08_td-control.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
