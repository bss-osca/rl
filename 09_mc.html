<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>9&nbsp; Monte Carlo methods for prediction and control – Reinforcement Learning for Business (RL)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./references.html" rel="next">
<link href="./08_dp.html" rel="prev">
<link href="./assets/favicon.ico" rel="icon">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-e8de9bd59ba156b9e4cb33cd6f01d621.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>html{ scroll-behavior: smooth; }</style>
<script async="" src="https://hypothes.is/embed.js"></script>
<script>
  window.document.addEventListener("DOMContentLoaded", function (_event) {
    document.body.classList.add('hypothesis-enabled');
  });
</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="assets/style.css">
<meta property="og:title" content="9&nbsp; Monte Carlo methods for prediction and control – Reinforcement Learning for Business (RL)">
<meta property="og:description" content="Course notes for the ‘Reinforcement Learning for Business’ course.">
<meta property="og:image" content="https://github.com/bss-osca/rl/raw/master/book/img/logo.png">
<meta property="og:site_name" content="Reinforcement Learning for Business (RL)">
</head>

<body class="nav-sidebar floating quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./09_mc.html"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Monte Carlo methods for prediction and control</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header sidebar-header-stacked">
      <a href="./index.html" class="sidebar-logo-link">
      <img src="./img/logo.png" alt="" class="sidebar-logo py-0 d-lg-inline d-none">
      </a>
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Reinforcement Learning for Business (RL)</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/bss-osca/rl/tree/master/book/" title="Source Code" class="quarto-navigation-tool px-1" aria-label="Source Code"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Introduction</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">About the course notes</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_rl-intro.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">An introduction to RL</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_rl-in-action.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">RL in action</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">An introduction to Python</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <span class="sidebar-item-text sidebar-link text-start">
 <span class="menu-text">Tabular methods</span></span>
  </li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_bandit.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Multi-armed bandits</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_mdp-1.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Markov decision processes (MDPs)</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_mdp-2.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Policies and value functions for MDPs</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_dp.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dynamic programming</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_mc.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Monte Carlo methods for prediction and control</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_1_appdx.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./99_2_appdx.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Getting help</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#learning-outcomes" id="toc-learning-outcomes" class="nav-link active" data-scroll-target="#learning-outcomes"><span class="header-section-number">9.1</span> Learning outcomes</a></li>
  <li><a href="#textbook-readings" id="toc-textbook-readings" class="nav-link" data-scroll-target="#textbook-readings"><span class="header-section-number">9.2</span> Textbook readings</a></li>
  <li><a href="#mc-prediction-evaluation" id="toc-mc-prediction-evaluation" class="nav-link" data-scroll-target="#mc-prediction-evaluation"><span class="header-section-number">9.3</span> MC prediction (evaluation)</a></li>
  <li><a href="#mc-control-improvement" id="toc-mc-control-improvement" class="nav-link" data-scroll-target="#mc-control-improvement"><span class="header-section-number">9.4</span> MC control (improvement)</a></li>
  <li><a href="#sec-mc-off-policy" id="toc-sec-mc-off-policy" class="nav-link" data-scroll-target="#sec-mc-off-policy"><span class="header-section-number">9.5</span> Off-policy MC prediction</a></li>
  <li><a href="#off-policy-control-improvement" id="toc-off-policy-control-improvement" class="nav-link" data-scroll-target="#off-policy-control-improvement"><span class="header-section-number">9.6</span> Off-policy control (improvement)</a></li>
  <li><a href="#summary" id="toc-summary" class="nav-link" data-scroll-target="#summary"><span class="header-section-number">9.7</span> Summary</a></li>
  <li><a href="#exercises" id="toc-exercises" class="nav-link" data-scroll-target="#exercises"><span class="header-section-number">9.8</span> Exercises</a></li>
  </ul>
<div class="toc-actions"><ul class="collapse"><li><a href="https://github.com/bss-osca/rl/edit/master/book/09_mc.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bss-osca/rl/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/bss-osca/rl/blob/master/book/09_mc.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-mc" class="quarto-section-identifier"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Monte Carlo methods for prediction and control</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- Various algorithms for the RL course -->
<p>The term “Monte Carlo” (MC) is often used for an estimation method which involves a random component. MC methods of RL learn state and action values by sampling and averaging returns. MC do not use dynamics where we estimate the value in the current state using the value in the next state (like in dynamic programming). Instead the MC methods estimate the values by considering different <em>sample-paths</em> (state, action and reward realizations). Compared to a Markov decision process, MC methods are model-free since they not require full knowledge of the transition probabilities and rewards (a model of the environment) instead MC methods learn the value function directly from experience. Often though, the sample-path is generated using simulation, i.e.&nbsp;some knowledge about the environment is given, but it is only used to generate sample transitions. For instance, consider an MDP model for the game Blackjack. Here calculating all the transition probabilities may be tedious and error-prone in terms of coding and numerical precision. Instead we can simulate a game (a sample-path) and use the simulations to evaluate/predict the value function of a policy and then use control to find a good policy. That is, we still use a generalised policy iteration framework, but instead of computing the value function using the MDP model a priori, we learn it from experience.</p>
<p>MC methods can be used for processes with episodes, i.e.&nbsp;where there is a terminal state. This reduces the length of the sample-path and the value of the states visited on the path can be updated based on the reward received.</p>
<section id="learning-outcomes" class="level2" data-number="9.1">
<h2 data-number="9.1" class="anchored" data-anchor-id="learning-outcomes"><span class="header-section-number">9.1</span> Learning outcomes</h2>
<p>By the end of this module, you are expected to:</p>
<ul>
<li>Identify the difference between model-based and model-free RL.</li>
<li>Identify problems that can be solved using Monte-Carlo methods.</li>
<li>Describe how MC methods can be used to estimate value functions from sample data.</li>
<li>Do MC prediction to estimate the value function for a given policy.</li>
<li>Explain why it is important to maintain exploration in MC algorithms.</li>
<li>Do policy improvement (control) using MC in a generalized policy improvement algorithm.</li>
<li>Compare different ways of exploring the state-action space.</li>
<li>Argue why off-policy learning can help deal with the exploration problem.</li>
<li>Use importance sampling to estimate the expected value of a target distribution using samples from a different distribution.</li>
<li>Use importance sampling in off-policy learning to predict the value-function of a target policy.</li>
<li>Explain how to modify the MC prediction and improvement algorithm for off-policy learning.</li>
</ul>
<p>The learning outcomes relate to the <a href="index.html#sec-lg-course">overall learning goals</a> number 3, 4, 9 and 12 of the course.</p>
<!-- SOLO increasing: identify · memorise · name · do simple procedure · collect data · -->
<!-- enumerate · describe · interpret · formulate · list · paraphrase · combine · do -->
<!-- algorithms · compare · contrast · explain causes · analyse · relate · derive · -->
<!-- evaluate · apply · argue · theorise · generalise · hypothesise · solve · reflect -->
</section>
<section id="textbook-readings" class="level2" data-number="9.2">
<h2 data-number="9.2" class="anchored" data-anchor-id="textbook-readings"><span class="header-section-number">9.2</span> Textbook readings</h2>
<p>For this week, you will need to read Chapter 5-5.7 in <span class="citation" data-cites="Sutton18">Sutton and Barto (<a href="references.html#ref-Sutton18" role="doc-biblioref">2018</a>)</span>. Read it before continuing this module. A summary of the book notation can be seen <a href="https://bss-osca.github.io/rl/misc/sutton-notation.pdf">here</a>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div>
Slides for this module can be seen
<a href="https://bss-osca.github.io/rl/slides/06_mc-slides.html" target="_blank">here.</a>
You do not have to look at them before the lecture!
</div>
</div>
</div>
</section>
<section id="mc-prediction-evaluation" class="level2" data-number="9.3">
<h2 data-number="9.3" class="anchored" data-anchor-id="mc-prediction-evaluation"><span class="header-section-number">9.3</span> MC prediction (evaluation)</h2>
<p>Given a policy <span class="math inline">\(\pi\)</span>, we want to estimate the state-value function. Recall that the state value function is [ v_(s) = <em>. ] where the return is [ G_t = R</em>{t+1} + R_{t+2} + ^2 R_{t+3} + = <em>{k=0}^{} ^k R</em>{t+k+1} = R_{t+1} + G_{t+1} ] Now given policy <span class="math inline">\(\pi\)</span> and a sample-path (episode) <span class="math inline">\(S_0, A_0, R_1, S_1, A_1, \ldots, S_{T-1}, A_{T-1}, R_T\)</span> ending in the terminal state at time <span class="math inline">\(T\)</span>, we can calculate the realized return for each state in the sample-path. Each time we have a new sample-path a new realized return for the states is given and the average for the returns in a state is an estimate of the state-value. With enough observations, the sample average converges to the true state-value under the policy <span class="math inline">\(\pi\)</span>.</p>
<p>Given a policy <span class="math inline">\(\pi\)</span> and a set of sample-paths, there are two ways to estimate the state values <span class="math inline">\(v_\pi(s)\)</span>:</p>
<ul>
<li>First visit MC: average returns from first visit to state <span class="math inline">\(s\)</span>.</li>
<li>Every visit MC: average returns following every visit to state <span class="math inline">\(s\)</span>.</li>
</ul>
<p>First visit MC generates iid estimates of <span class="math inline">\(v_\pi(s)\)</span> with finite variance, so the sequence of estimates converges to the expected value by the law of large numbers as the number of observations grow. Every visit MC does not generate independent estimates, but still converges.</p>
<p>An algorithm for first visit MC is given in Figure @ref(fig:mc-prediction-alg). The state-value estimate is stored in a vector <span class="math inline">\(V\)</span> and the returns for each state in a list. Given a sample-path we add the return to the states on the path by scanning the path backwards and updating <span class="math inline">\(G\)</span>. Note since the algorithm considers first visit MC, a check of occurrence of the state earlier in the path done. If this check is dropped, we have a every visit MC algorithm instead. Moreover, the computation needed to update the state-value does not depend on the size of the process/MDP but only of the length of the sample-path.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/mc-prediction.png" class="img-fluid figure-img" width="629"></p>
<figcaption>MC policy prediction <span class="citation" data-cites="Sutton18">(<a href="references.html#ref-Sutton18" role="doc-biblioref">Sutton and Barto 2018</a>)</span>.</figcaption>
</figure>
</div>
</div>
</div>
<p>The algorithm maintains a list of all returns for each state which may require a lot of memory. Instead as incremental update of <span class="math inline">\(V\)</span> can be done. Adapting Eq. @ref(eq:avg), we have that the sample average can be updated using:</p>
<p><span class="math display">\[
  V(s) \leftarrow V(s) + \frac{1}{n} \left[G - V(s)\right].
\]</span> where <span class="math inline">\(n\)</span> denote the number of realized returns found for state <span class="math inline">\(s\)</span> and <span class="math inline">\(G\)</span> the current realized return. The state-value vector must be initialized to zero and a vector counting the number of returns found for each state must be stored.</p>
<!-- ### Blackjack - MC prediction -->
<section id="mc-prediction-of-action-values" class="level3" data-number="9.3.1">
<h3 data-number="9.3.1" class="anchored" data-anchor-id="mc-prediction-of-action-values"><span class="header-section-number">9.3.1</span> MC prediction of action-values</h3>
<p>With a model of the environment we only need to estimate the state-value function, since it is easy to determine the policy from the state-values using the Bellman optimality equations @ref(eq:bell-opt-state-policy). However, if we do not know the expected reward and transition probabilities state values are not enough. In that case, it is useful to estimate action-values since the optimal policy can be found using <span class="math inline">\(q_*\)</span> (see Eq. @ref(eq:bell-opt-state-policy)). To find <span class="math inline">\(q_*\)</span>, we first need to predict action-values for a policy <span class="math inline">\(\pi\)</span>. This is essentially the same as for state-values, only we now talk about state-action pairs being visited, i.e.&nbsp;taking action <span class="math inline">\(a\)</span> in state <span class="math inline">\(s\)</span> instead.</p>
<p>If <span class="math inline">\(\pi\)</span> is deterministic, then we will only estimate the values of actions that <span class="math inline">\(\pi\)</span> dictates. Therefore some exploration are needed in order to have estimates for all action-values. Two possibilities are:</p>
<ol type="1">
<li>Make <span class="math inline">\(\pi\)</span> stochastic, e.g.&nbsp;<span class="math inline">\(\varepsilon\)</span>-soft that that have non-zero probability of selecting each state-action pair.</li>
<li>Use <em>exploring starts</em>, which specifies that ever state-action pair has non-zero probability of being selected as the starting state of an sample-path.</li>
</ol>
</section>
</section>
<section id="mc-control-improvement" class="level2" data-number="9.4">
<h2 data-number="9.4" class="anchored" data-anchor-id="mc-control-improvement"><span class="header-section-number">9.4</span> MC control (improvement)</h2>
<p>We are now ready to formulate a generalized policy iteration (GPI) algorithm using MC to predict the action-values <span class="math inline">\(q(s,a)\)</span>. Policy improvement is done by selecting the next policy greedy with respect to the action-value function: [ (s) = _a q(s, a). ] That is, we generate a sequence of policies and action-value functions <span class="math display">\[\pi_0 \xrightarrow[]{E} q_{\pi_0} \xrightarrow[]{I} \pi_1 \xrightarrow[]{E} q_{\pi_1} \xrightarrow[]{I} \pi_2 \xrightarrow[]{E} q_{\pi_2} \xrightarrow[]{I} \ldots \xrightarrow[]{I} \pi_* \xrightarrow[]{E} q_{*}.\]</span> Hence the policy improvement theorem applies for all <span class="math inline">\(s \in \mathcal{S}\)</span>:</p>
<p><span class="math display">\[\begin{align}
    q_{\pi_k}(s, a=\pi_{k+1}(s)) &amp;= q_{\pi_k}(s, \arg\max_a q_{\pi_k}(s, a)) \\
                    &amp;= \max_a q_{\pi_k}(s, a) \\
                    &amp;\geq q_{\pi_k}(s, \pi_k(s))\\
                    &amp;= v_{\pi_k}(s)
\end{align}\]</span></p>
<p>That is, <span class="math inline">\(\pi_{k+1}\)</span> is better than <span class="math inline">\(\pi_k\)</span> or optimal.</p>
<p>It is important to understand the major difference between model-based GPI (remember that a model means the transition probability matrix and reward distribution are known) and model-free GPI. We cannot simply use a 100% greedy strategy all the time, since all our action-values are estimates. As such, we now need to introduce an element of exploration into our algorithm to estimate the action-values. For convergence to the optimal policy a model-free GPI algorithm must satisfy:</p>
<ol type="1">
<li><em>Infinite exploration</em>: all state-action <span class="math inline">\((s,a)\)</span> pairs should be explored infinitely many times as the number of iterations go to infinity (in the limit), i.e.&nbsp;as the number of iterations <span class="math inline">\(k\)</span> goes to infinity the number of visits <span class="math inline">\(n_k\)</span> does too <span class="math display">\[\lim_{k\rightarrow\infty} n_k(s, a) = \infty.\]</span></li>
<li><em>Greedy in the limit</em>: while we maintain infinite exploration, we do eventually need to converge to the optimal policy: <span class="math display">\[\lim_{k\rightarrow\infty} \pi_k(a|s) = 1 \text{ for } a = \arg\max_a q(s, a).\]</span></li>
</ol>
<section id="gpi-with-exploring-starts" class="level3" data-number="9.4.1">
<h3 data-number="9.4.1" class="anchored" data-anchor-id="gpi-with-exploring-starts"><span class="header-section-number">9.4.1</span> GPI with exploring starts</h3>
<p>An algorithm using exploring starts and first visit MC is given in Figure @ref(fig:mc-gpi-es-alg). It satisfies the convergence properties and and incremental implementation can be used to update <span class="math inline">\(Q\)</span>. Note that to predict the action-values for a policy, we in general need a large number of sample-paths. However, much like we did with value iteration, we do not need to fully evaluate the value function for a given policy. Instead we can merely move the value toward the correct value and then switch to policy improvement thereafter. To stop the algorithm from having infinitely many sample-paths we may stop the algorithm once the <span class="math inline">\(q_{\pi_k}\)</span> stop moving within a certain error.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/mc-gpi-es.png" class="img-fluid figure-img" width="628"></p>
<figcaption>GPI using MC policy prediction with exploring starts <span class="citation" data-cites="Sutton18">(<a href="references.html#ref-Sutton18" role="doc-biblioref">Sutton and Barto 2018</a>)</span>.</figcaption>
</figure>
</div>
</div>
</div>
<!-- ### Blackjack - MC control -->
</section>
<section id="gpi-using-epsilon-soft-policies" class="level3" data-number="9.4.2">
<h3 data-number="9.4.2" class="anchored" data-anchor-id="gpi-using-epsilon-soft-policies"><span class="header-section-number">9.4.2</span> GPI using <span class="math inline">\(\epsilon\)</span>-soft policies</h3>
<p>Note by using exploring starts in Algorithm @ref(fig:mc-gpi-es-alg), the ‘infinite exploration’ convergence assumption is satisfied. However exploring starts may be hard to use in practice. Another approach to ensure infinite exploration is to use a soft policy, i.e.&nbsp;assign a non-zero probability to each possible action in a state. An on-policy algorithm using <span class="math inline">\(\epsilon\)</span>-greedy policies is given in Figure @ref(fig:mc-gpi-on-policy-alg). Here we put probability <span class="math inline">\(1 - \varepsilon + \frac{\varepsilon}{|\mathcal{A}(s)|}\)</span> on the maximal action and <span class="math inline">\(\frac{\varepsilon}{|\mathcal{A}(s)|}\)</span> on each of the others. Note using <span class="math inline">\(\epsilon\)</span>-greedy policy selection will improve the current policy; otherwise we have found best policy amongst the <span class="math inline">\(\epsilon\)</span>-soft policies. If we want to find the optimal policy we have to ensure the ‘greedy in the limit’ convergence assumption. This can be done by decreasing <span class="math inline">\(\epsilon\)</span> as the number of iterations increase (e.g.&nbsp;<span class="math inline">\(\epsilon = 1/k\)</span>).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/mc-gpi-on-policy.png" class="img-fluid figure-img" width="628"></p>
<figcaption>On-policy GPI using MC policy prediction <span class="citation" data-cites="Sutton18">(<a href="references.html#ref-Sutton18" role="doc-biblioref">Sutton and Barto 2018</a>)</span>.</figcaption>
</figure>
</div>
</div>
</div>
<p>An incremental approach for updating <span class="math inline">\(Q\)</span> can be used by storing the number of times <span class="math inline">\(n_a\)</span>, action <span class="math inline">\(a\)</span> has been visited in state <span class="math inline">\(s\)</span> and then update <span class="math inline">\(Q(s,a)\)</span> using <span class="math display">\[Q_{n+1} = Q_n + \frac{1}{n_a}(G-Q_n),\]</span> where <span class="math inline">\(Q_n\)</span> denote the previous value.</p>
<p>Finally, the algorithm in Figure @ref(fig:mc-gpi-on-policy-alg) do not mention how to find the start state of an episode. In general all states that we want to approximate must be used as start state.</p>
</section>
<section id="gpi-using-upper-confience-bound-action-selection" class="level3" data-number="9.4.3">
<h3 data-number="9.4.3" class="anchored" data-anchor-id="gpi-using-upper-confience-bound-action-selection"><span class="header-section-number">9.4.3</span> GPI using upper-confience bound action selection</h3>
<p>GPI using exploring starts or <span class="math inline">\(\epsilon\)</span>-soft policies may be slow. Often speed-ups can be done by using e.g.&nbsp;upper-confidence bounds (UCB) for action selection. Recall from Module @ref(mod-bandit) that UCB select actions according to their potential for actually being optimal, taking into account both how close their estimates are to being maximal and the uncertainty in those estimates. That is, the next action <span class="math inline">\(a'\)</span> given a state <span class="math inline">\(s\)</span> is selected using: <span class="math display">\[
    a' = \arg\max_a \left(Q(s,a) + c\sqrt{\frac{\ln n_s}{n_a}}\right),
\]</span> where <span class="math inline">\(n_s\)</span> denote the number of times state <span class="math inline">\(s\)</span> has been visited and <span class="math inline">\(n_a\)</span> denote the number of times action <span class="math inline">\(a\)</span> has been visited (both numbers must be stored). The parameter <span class="math inline">\(c&gt;0\)</span> controls the degree of exploration. Higher <span class="math inline">\(c\)</span> results in more weight on the uncertainty. However, one problem with UCB is that it is hard to decide on which value of <span class="math inline">\(c\)</span> to use in advance.<br>
<!-- Preliminary testing showed that using UCB instead of $\epsilon$-greedy policies worked better.  --></p>
</section>
<section id="mc-seasonal" class="level3" data-number="9.4.4">
<h3 data-number="9.4.4" class="anchored" data-anchor-id="mc-seasonal"><span class="header-section-number">9.4.4</span> Example - Seasonal inventory and sales planning</h3>
<p>In the following example we try to implement an algorithm that uses generalized policy iteration with every-visit estimation using epsilon-greedy action selection.</p>
<p>We consider seasonal product such as garden furnitures. Assume that the maximum inventory level is <span class="math inline">\(Q\)</span> items, i.e.&nbsp;we can buy at most <span class="math inline">\(Q\)</span> items at the start of the season for a price of $14. The product can be sold for at most <span class="math inline">\(T\)</span> weeks and at the end of the period (week <span class="math inline">\(T\)</span>), the remaining inventory is sold to an outlet store for $5 per item.</p>
<p>The demand depends on the sales price which based on historic observations is assumed in the interval <span class="math inline">\([10,25].\)</span> In general a higher sales price result in a lower demand. Moreover, in the first half part of the season the demand is on average 10% higher given a fixed sales price compared to the last half part of the season. Historic observed demands can be seen in Figure @ref(fig:demand).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="09_mc_files/figure-html/demand-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Observed demands given price (scaled based on number of observations).</figcaption>
</figure>
</div>
</div>
</div>
<p>Let <span class="math inline">\(s = (q,t)\)</span> denote the state of the system in the start of a week, where <span class="math inline">\(q\)</span> is the inventory and <span class="math inline">\(t\)</span> the week number. Then the state space is <span class="math display">\[\mathcal{S} = \{ s = (q,t) | 1 \leq q \leq Q, 1 \leq t \leq T \} \cup \{ 0 \},\]</span> where state <span class="math inline">\(s = 0\)</span> denote the terminal state (inventory empty). Let us limit us to actions <span class="math display">\[\mathcal{A}(q,t) = \{ 10,15,20,25 \}, \mathcal{A}(0) = \{ d \}, \]</span> where action <span class="math inline">\(a\)</span> denote the price and <span class="math inline">\(d\)</span> denote the dummy action with deterministic transition to state <span class="math inline">\(0\)</span>.</p>
<p>The inventory dynamics for transitions not to the terminal state are <span class="math display">\[t' = t + 1,\]</span> <span class="math display">\[q' = q - min(q, D),\]</span> where <span class="math inline">\(D\)</span> denote the demand. Moreover, if <span class="math inline">\(t = T\)</span> or <span class="math inline">\(q' = 0\)</span>, then a transition to the terminal state happens.</p>
<p>For <span class="math inline">\(t=1\)</span> the reward of an state <span class="math inline">\((q,t)\)</span> is sales price times the number of sold items minus the purchase cost. For <span class="math inline">\(1&lt;t&lt;T\)</span> the reward is sales price times the number of sold (we assume an inventory cost of zero), while for <span class="math inline">\(t=T\)</span> the reward is the scrap price times the inventory.</p>
<p>Let us define a R6 class representing the environment for this problem</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co">#' R6 Class representing the RL environment for the problem</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>RLEnvSeasonal <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"RLEnvSeasonal"</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field maxInv Max inventory level.</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxInv =</span> <span class="cn">NA</span>,  </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field maxT Max number of weeks to sell product.</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">maxT =</span> <span class="cn">NA</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field scrapPrice Scrap price per item in week maxT.</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>      <span class="at">scrapPrice =</span> <span class="cn">NA</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field purchasePrice Purchase price per item.</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>      <span class="at">purchasePrice =</span> <span class="cn">NA</span>,</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field prices Possible sales prices per item.</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">prices =</span> <span class="cn">NA</span>,</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Create an object (when call new).</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxInv Max inventory level.</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxT Max number of weeks to sell product.</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param scrapPrice Scrap price per item in week maxT.</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param purchasePrice Purchase price per item.</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @return The new object.</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">initialize =</span> <span class="cf">function</span>(maxInv, maxT, scrapPrice, purchasePrice, prices) {</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>maxInv <span class="ot">&lt;-</span> maxInv </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>maxT <span class="ot">&lt;-</span> maxT</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>scrapPrice <span class="ot">&lt;-</span> scrapPrice</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>purchasePrice <span class="ot">&lt;-</span> purchasePrice</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>prices <span class="ot">&lt;-</span> prices</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return all states (keys).</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>      <span class="at">getStates =</span> <span class="cf">function</span>() {</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">expand_grid</span>(<span class="at">l =</span> <span class="dv">1</span><span class="sc">:</span>env<span class="sc">$</span>maxInv, <span class="at">t =</span> <span class="dv">1</span><span class="sc">:</span>env<span class="sc">$</span>maxT) <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">s =</span> <span class="fu">str_c</span>(l, <span class="st">","</span>, t)) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(s)</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">c</span>(states, <span class="st">"0"</span>)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(states)</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return all actions (keys) for a state.</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s State considered.</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActions =</span> <span class="cf">function</span>(s) {</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (s <span class="sc">==</span> <span class="st">"0"</span>) <span class="fu">return</span>(<span class="st">"dummy"</span>)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">str_split</span>(s, <span class="st">","</span>, <span class="at">simplify =</span> T)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a>         t <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">2</span>])</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">1</span>])</span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (t <span class="sc">==</span> self<span class="sc">$</span>maxT) <span class="fu">return</span>(<span class="fu">str_c</span>(self<span class="sc">$</span>scrapPrice))</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">str_c</span>(self<span class="sc">$</span>prices))</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Stochastic demand sample. </span></span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param price Sales price.</span></span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param t Week.</span></span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">getDemand =</span> <span class="cf">function</span>(price, t) {</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a>         l1 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">20</span>, <span class="dv">12</span>,<span class="dv">12</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T)  <span class="co"># points (price, demand) for first line</span></span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a>         l2 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">12</span>,<span class="dv">12</span>, <span class="dv">15</span>,<span class="dv">10</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T)  </span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a>         l3 <span class="ot">=</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">15</span>,<span class="dv">10</span>), <span class="at">ncol =</span> <span class="dv">2</span>, <span class="at">byrow =</span> T)  </span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a>         </span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (price <span class="sc">&lt;=</span> <span class="fu">max</span>(l1[<span class="dv">1</span>,<span class="dv">1</span>],l1[<span class="dv">2</span>,<span class="dv">1</span>])) {</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> (l1[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">-</span>l1[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">/</span>(l1[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">-</span>l1[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a>            b <span class="ot">&lt;-</span> l1[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">-</span> a <span class="sc">*</span> l1[<span class="dv">1</span>,<span class="dv">1</span>] </span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a>            d <span class="ot">&lt;-</span> a <span class="sc">*</span> price <span class="sc">+</span> b </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a>            dS <span class="ot">&lt;-</span> d <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.75</span>, <span class="fl">1.25</span>)</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a>         } <span class="cf">else</span> <span class="cf">if</span> (price <span class="sc">&gt;=</span> <span class="fu">min</span>(l2[<span class="dv">1</span>,<span class="dv">1</span>],l2[<span class="dv">2</span>,<span class="dv">1</span>]) <span class="sc">&amp;</span> price <span class="sc">&lt;=</span> <span class="fu">max</span>(l2[<span class="dv">1</span>,<span class="dv">1</span>],l2[<span class="dv">2</span>,<span class="dv">1</span>])) {</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> (l2[<span class="dv">1</span>,<span class="dv">2</span>]<span class="sc">-</span>l2[<span class="dv">2</span>,<span class="dv">2</span>])<span class="sc">/</span>(l2[<span class="dv">1</span>,<span class="dv">1</span>]<span class="sc">-</span>l2[<span class="dv">2</span>,<span class="dv">1</span>])</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a>            b <span class="ot">&lt;-</span> l2[<span class="dv">1</span>,<span class="dv">2</span>] <span class="sc">-</span> a <span class="sc">*</span> l2[<span class="dv">1</span>,<span class="dv">1</span>] </span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a>            d <span class="ot">&lt;-</span> a <span class="sc">*</span> price <span class="sc">+</span> b </span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a>            dS <span class="ot">&lt;-</span> d <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="fl">0.75</span>, <span class="fl">1.25</span>)</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a>         } <span class="cf">else</span> <span class="cf">if</span> (price <span class="sc">&gt;=</span> l3[<span class="dv">1</span>,<span class="dv">1</span>]) {</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a>            d <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span><span class="sc">*</span><span class="fu">log</span>(price <span class="sc">-</span> l3[<span class="dv">1</span>,<span class="dv">1</span>] <span class="sc">+</span> <span class="dv">1</span>) <span class="sc">+</span> l3[<span class="dv">1</span>,<span class="dv">2</span>]</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a>            dS <span class="ot">&lt;-</span> d <span class="sc">*</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (t <span class="sc">&lt;=</span> self<span class="sc">$</span>maxT<span class="sc">/</span><span class="dv">2</span>) {</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a>            dS <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">1</span>, <span class="fl">1.2</span>) <span class="sc">*</span> dS</span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a>         <span class="co"># if (stochastic) return(round(dS)) else return(round(d))</span></span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">round</span>(dS))</span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Returns the simulated transition probabilities and reward. </span></span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">getTransPrR =</span> <span class="cf">function</span>(s, a, <span class="at">runs =</span> <span class="dv">10000</span>) {</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">str_split</span>(s, <span class="st">","</span>, <span class="at">simplify =</span> T)</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a>         t <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">2</span>])</span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">1</span>])</span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (q <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pr =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">r =</span> <span class="dv">0</span>))</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-94"><a href="#cb1-94" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (t <span class="sc">==</span> env<span class="sc">$</span>maxT) {</span>
<span id="cb1-95"><a href="#cb1-95" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pr =</span> <span class="fu">c</span>(<span class="st">"0"</span> <span class="ot">=</span> <span class="dv">1</span>), <span class="at">r =</span> env<span class="sc">$</span>scrapPrice <span class="sc">*</span> q))</span>
<span id="cb1-96"><a href="#cb1-96" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-97"><a href="#cb1-97" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(a)</span>
<span id="cb1-98"><a href="#cb1-98" aria-hidden="true" tabindex="-1"></a>         df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">sim =</span> <span class="dv">1</span><span class="sc">:</span>runs) <span class="sc">%&gt;%</span> </span>
<span id="cb1-99"><a href="#cb1-99" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-100"><a href="#cb1-100" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">demand =</span> self<span class="sc">$</span><span class="fu">getDemand</span>(a, t)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-101"><a href="#cb1-101" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb1-102"><a href="#cb1-102" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">qN =</span> q <span class="sc">-</span> <span class="fu">pmin</span>(q, demand), <span class="at">reward =</span> a <span class="sc">*</span> <span class="fu">pmin</span>(q, demand))</span>
<span id="cb1-103"><a href="#cb1-103" aria-hidden="true" tabindex="-1"></a>         reward <span class="ot">&lt;-</span> <span class="fu">mean</span>(df<span class="sc">$</span>reward)</span>
<span id="cb1-104"><a href="#cb1-104" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) reward <span class="ot">&lt;-</span> reward <span class="sc">-</span> q <span class="sc">*</span> self<span class="sc">$</span>purchasePrice</span>
<span id="cb1-105"><a href="#cb1-105" aria-hidden="true" tabindex="-1"></a>         df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> </span>
<span id="cb1-106"><a href="#cb1-106" aria-hidden="true" tabindex="-1"></a>            <span class="fu">count</span>(qN) <span class="sc">%&gt;%</span> </span>
<span id="cb1-107"><a href="#cb1-107" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">pr =</span> n<span class="sc">/</span><span class="fu">sum</span>(n), <span class="at">qN =</span> <span class="fu">if_else</span>(qN <span class="sc">==</span> <span class="dv">0</span>, <span class="st">"0"</span>, <span class="fu">str_c</span>(qN, <span class="st">","</span>, t<span class="sc">+</span><span class="dv">1</span>)))</span>
<span id="cb1-108"><a href="#cb1-108" aria-hidden="true" tabindex="-1"></a>         pr <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">pull</span>(pr, <span class="at">name =</span> qN)</span>
<span id="cb1-109"><a href="#cb1-109" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">list</span>(<span class="at">pr =</span> pr, <span class="at">r =</span> reward))</span>
<span id="cb1-110"><a href="#cb1-110" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-111"><a href="#cb1-111" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-112"><a href="#cb1-112" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Returns an episode as a tibble with cols s, a, r (last col the terminal reward).</span></span>
<span id="cb1-113"><a href="#cb1-113" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param agent The agent that holds the model with current policy stored in pi. </span></span>
<span id="cb1-114"><a href="#cb1-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">getEpisodePi =</span> <span class="cf">function</span>(agent, startState) {</span>
<span id="cb1-115"><a href="#cb1-115" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (startState <span class="sc">==</span> <span class="st">"0"</span>) {</span>
<span id="cb1-116"><a href="#cb1-116" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="sc">!!!</span><span class="fu">c</span>(<span class="st">"s"</span>, <span class="st">"a"</span>, <span class="st">"r"</span>), <span class="at">.rows =</span> <span class="dv">0</span>))  <span class="co"># empty tibble</span></span>
<span id="cb1-117"><a href="#cb1-117" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-118"><a href="#cb1-118" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">str_split</span>(startState, <span class="st">","</span>, <span class="at">simplify =</span> T)</span>
<span id="cb1-119"><a href="#cb1-119" aria-hidden="true" tabindex="-1"></a>         t <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">2</span>])</span>
<span id="cb1-120"><a href="#cb1-120" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">1</span>])</span>
<span id="cb1-121"><a href="#cb1-121" aria-hidden="true" tabindex="-1"></a>         df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">s =</span> <span class="fu">rep</span>(<span class="cn">NA_character_</span>, <span class="dv">100</span> <span class="sc">*</span> self<span class="sc">$</span>maxInv), <span class="at">a =</span> <span class="cn">NA_character_</span>, <span class="at">r =</span> <span class="cn">NA_real_</span>)  <span class="co"># a tibble with more rows than used</span></span>
<span id="cb1-122"><a href="#cb1-122" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb1-123"><a href="#cb1-123" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (q <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-124"><a href="#cb1-124" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>),]  <span class="co"># remove unused rows</span></span>
<span id="cb1-125"><a href="#cb1-125" aria-hidden="true" tabindex="-1"></a>               <span class="cf">break</span>  <span class="co"># have reached terminal state</span></span>
<span id="cb1-126"><a href="#cb1-126" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-127"><a href="#cb1-127" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">str_c</span>(q, <span class="st">","</span>, t)</span>
<span id="cb1-128"><a href="#cb1-128" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb1-129"><a href="#cb1-129" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (t <span class="sc">==</span> self<span class="sc">$</span>maxT) { <span class="co"># sell remaining</span></span>
<span id="cb1-130"><a href="#cb1-130" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> self<span class="sc">$</span>scrapPrice <span class="sc">*</span> q</span>
<span id="cb1-131"><a href="#cb1-131" aria-hidden="true" tabindex="-1"></a>               q <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># new q value</span></span>
<span id="cb1-132"><a href="#cb1-132" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb1-133"><a href="#cb1-133" aria-hidden="true" tabindex="-1"></a>               price <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(a)</span>
<span id="cb1-134"><a href="#cb1-134" aria-hidden="true" tabindex="-1"></a>               d <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getDemand</span>(price, t)</span>
<span id="cb1-135"><a href="#cb1-135" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb1-136"><a href="#cb1-136" aria-hidden="true" tabindex="-1"></a>                  r <span class="ot">&lt;-</span> price <span class="sc">*</span> <span class="fu">min</span>(q, d) <span class="sc">-</span> q <span class="sc">*</span> self<span class="sc">$</span>purchasePrice</span>
<span id="cb1-137"><a href="#cb1-137" aria-hidden="true" tabindex="-1"></a>               } <span class="cf">else</span> {</span>
<span id="cb1-138"><a href="#cb1-138" aria-hidden="true" tabindex="-1"></a>                  r <span class="ot">&lt;-</span> price <span class="sc">*</span> <span class="fu">min</span>(q, d)</span>
<span id="cb1-139"><a href="#cb1-139" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb1-140"><a href="#cb1-140" aria-hidden="true" tabindex="-1"></a>               q <span class="ot">&lt;-</span> q <span class="sc">-</span> <span class="fu">min</span>(q, d)  <span class="co"># new q value</span></span>
<span id="cb1-141"><a href="#cb1-141" aria-hidden="true" tabindex="-1"></a>               t <span class="ot">&lt;-</span> t <span class="sc">+</span> <span class="dv">1</span> <span class="co"># new t value</span></span>
<span id="cb1-142"><a href="#cb1-142" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-143"><a href="#cb1-143" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>s[i] <span class="ot">&lt;-</span> s</span>
<span id="cb1-144"><a href="#cb1-144" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>a[i] <span class="ot">&lt;-</span> a</span>
<span id="cb1-145"><a href="#cb1-145" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>r[i] <span class="ot">&lt;-</span> r</span>
<span id="cb1-146"><a href="#cb1-146" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-147"><a href="#cb1-147" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(df)</span>
<span id="cb1-148"><a href="#cb1-148" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb1-149"><a href="#cb1-149" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb1-150"><a href="#cb1-150" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Returns an episode as a tibble with cols s, a, r (last col the terminal reward).</span></span>
<span id="cb1-151"><a href="#cb1-151" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param agent The agent that holds the model with current policy. </span></span>
<span id="cb1-152"><a href="#cb1-152" aria-hidden="true" tabindex="-1"></a>      <span class="at">getEpisode =</span> <span class="cf">function</span>(agent, startState, <span class="at">coeff =</span> <span class="dv">1</span>, <span class="at">eps =</span> <span class="fl">0.1</span>) {</span>
<span id="cb1-153"><a href="#cb1-153" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (startState <span class="sc">==</span> <span class="st">"0"</span>) {</span>
<span id="cb1-154"><a href="#cb1-154" aria-hidden="true" tabindex="-1"></a>            <span class="fu">return</span>(tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="sc">!!!</span><span class="fu">c</span>(<span class="st">"s"</span>, <span class="st">"a"</span>, <span class="st">"r"</span>), <span class="at">.rows =</span> <span class="dv">0</span>))  <span class="co"># empty tibble</span></span>
<span id="cb1-155"><a href="#cb1-155" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-156"><a href="#cb1-156" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">str_split</span>(startState, <span class="st">","</span>, <span class="at">simplify =</span> T)</span>
<span id="cb1-157"><a href="#cb1-157" aria-hidden="true" tabindex="-1"></a>         t <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">2</span>])</span>
<span id="cb1-158"><a href="#cb1-158" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(q[<span class="dv">1</span>])</span>
<span id="cb1-159"><a href="#cb1-159" aria-hidden="true" tabindex="-1"></a>         df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">s =</span> <span class="fu">rep</span>(<span class="cn">NA_character_</span>, <span class="dv">100</span> <span class="sc">*</span> self<span class="sc">$</span>maxInv), <span class="at">a =</span> <span class="cn">NA_character_</span>, <span class="at">r =</span> <span class="cn">NA_real_</span>)  <span class="co"># a tibble with more rows than used</span></span>
<span id="cb1-160"><a href="#cb1-160" aria-hidden="true" tabindex="-1"></a>         <span class="co"># q &lt;- sample(1:self$maxInv, 1)  # pick start inventory random</span></span>
<span id="cb1-161"><a href="#cb1-161" aria-hidden="true" tabindex="-1"></a>         <span class="co"># q &lt;- 1</span></span>
<span id="cb1-162"><a href="#cb1-162" aria-hidden="true" tabindex="-1"></a>         <span class="co"># t &lt;- 1</span></span>
<span id="cb1-163"><a href="#cb1-163" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb1-164"><a href="#cb1-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (q <span class="sc">==</span> <span class="dv">0</span>) {</span>
<span id="cb1-165"><a href="#cb1-165" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df[<span class="dv">1</span><span class="sc">:</span>(i<span class="dv">-1</span>),]  <span class="co"># remove unused rows</span></span>
<span id="cb1-166"><a href="#cb1-166" aria-hidden="true" tabindex="-1"></a>               <span class="cf">break</span>  <span class="co"># have reached terminal state</span></span>
<span id="cb1-167"><a href="#cb1-167" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-168"><a href="#cb1-168" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">str_c</span>(q, <span class="st">","</span>, t)</span>
<span id="cb1-169"><a href="#cb1-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (t <span class="sc">==</span> self<span class="sc">$</span>maxT) { <span class="co"># sell remaining</span></span>
<span id="cb1-170"><a href="#cb1-170" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionUCB</span>(s, coeff)</span>
<span id="cb1-171"><a href="#cb1-171" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> self<span class="sc">$</span>scrapPrice <span class="sc">*</span> q</span>
<span id="cb1-172"><a href="#cb1-172" aria-hidden="true" tabindex="-1"></a>               q <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># new q value</span></span>
<span id="cb1-173"><a href="#cb1-173" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> {</span>
<span id="cb1-174"><a href="#cb1-174" aria-hidden="true" tabindex="-1"></a>               <span class="co"># actions &lt;- names(agent$model[[s]]$pi)</span></span>
<span id="cb1-175"><a href="#cb1-175" aria-hidden="true" tabindex="-1"></a>               <span class="co"># a &lt;- actions[sample(1:length(actions), 1, prob = agent$model[[s]]$pi)]</span></span>
<span id="cb1-176"><a href="#cb1-176" aria-hidden="true" tabindex="-1"></a>               <span class="co"># a &lt;- agent$getActionUCB(s, coeff)</span></span>
<span id="cb1-177"><a href="#cb1-177" aria-hidden="true" tabindex="-1"></a>               <span class="co"># epsN &lt;- eps * (1/(agent$model[[s]]$n+1))^0.28</span></span>
<span id="cb1-178"><a href="#cb1-178" aria-hidden="true" tabindex="-1"></a>               epsN <span class="ot">&lt;-</span> eps</span>
<span id="cb1-179"><a href="#cb1-179" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionEG</span>(s, epsN)</span>
<span id="cb1-180"><a href="#cb1-180" aria-hidden="true" tabindex="-1"></a>               <span class="co"># cat(a, " ")</span></span>
<span id="cb1-181"><a href="#cb1-181" aria-hidden="true" tabindex="-1"></a>               price <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(a)</span>
<span id="cb1-182"><a href="#cb1-182" aria-hidden="true" tabindex="-1"></a>               d <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getDemand</span>(price, t)</span>
<span id="cb1-183"><a href="#cb1-183" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (t <span class="sc">==</span> <span class="dv">1</span>) {</span>
<span id="cb1-184"><a href="#cb1-184" aria-hidden="true" tabindex="-1"></a>                  r <span class="ot">&lt;-</span> price <span class="sc">*</span> <span class="fu">min</span>(q, d) <span class="sc">-</span> q <span class="sc">*</span> self<span class="sc">$</span>purchasePrice</span>
<span id="cb1-185"><a href="#cb1-185" aria-hidden="true" tabindex="-1"></a>               } <span class="cf">else</span> {</span>
<span id="cb1-186"><a href="#cb1-186" aria-hidden="true" tabindex="-1"></a>                  r <span class="ot">&lt;-</span> price <span class="sc">*</span> <span class="fu">min</span>(q, d)</span>
<span id="cb1-187"><a href="#cb1-187" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb1-188"><a href="#cb1-188" aria-hidden="true" tabindex="-1"></a>               q <span class="ot">&lt;-</span> q <span class="sc">-</span> <span class="fu">min</span>(q, d)  <span class="co"># new q value</span></span>
<span id="cb1-189"><a href="#cb1-189" aria-hidden="true" tabindex="-1"></a>               t <span class="ot">&lt;-</span> t <span class="sc">+</span> <span class="dv">1</span> <span class="co"># new t value</span></span>
<span id="cb1-190"><a href="#cb1-190" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb1-191"><a href="#cb1-191" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>s[i] <span class="ot">&lt;-</span> s</span>
<span id="cb1-192"><a href="#cb1-192" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>a[i] <span class="ot">&lt;-</span> a</span>
<span id="cb1-193"><a href="#cb1-193" aria-hidden="true" tabindex="-1"></a>            df<span class="sc">$</span>r[i] <span class="ot">&lt;-</span> r</span>
<span id="cb1-194"><a href="#cb1-194" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb1-195"><a href="#cb1-195" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(df)</span>
<span id="cb1-196"><a href="#cb1-196" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb1-197"><a href="#cb1-197" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb1-198"><a href="#cb1-198" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we define methods for getting the state and actions, an episode and the demand. Moreover, for this problem we many also use simulation to get the transition probabilities and the expected reward of a state-action pair (see method <code>getTransPrR</code>). That is, we may solve the problem using an MDP first and compare. Let us define the environment:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">876</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>prices <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">25</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>env <span class="ot">&lt;-</span> RLEnvSeasonal<span class="sc">$</span><span class="fu">new</span>(<span class="at">maxInv =</span> <span class="dv">100</span>, <span class="at">maxT =</span> <span class="dv">15</span>, <span class="at">scrapPrice =</span> <span class="dv">5</span>, <span class="at">purchasePrice =</span> <span class="dv">14</span>, prices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let us try to find the optimal policy using an MDP:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Build the MDP</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>mdp <span class="ot">&lt;-</span> MDPClass<span class="sc">$</span><span class="fu">new</span>()                           <span class="co"># initialize mdp object</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>mdp<span class="sc">$</span><span class="fu">addStateSpace</span>(env<span class="sc">$</span><span class="fu">getStates</span>())              <span class="co"># add states</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> mdp<span class="sc">$</span><span class="fu">getStateKeys</span>()) {                 <span class="co"># add actions</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>   mdp<span class="sc">$</span><span class="fu">addActionSpace</span>(s, env<span class="sc">$</span><span class="fu">getActions</span>(s))</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> mdp<span class="sc">$</span><span class="fu">getStateKeys</span>()) {                 <span class="co"># add trans pr and reward (this will take some time!)</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>   <span class="cf">for</span> (a <span class="cf">in</span> mdp<span class="sc">$</span><span class="fu">getActionKeys</span>(s)) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>      lst <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTransPrR</span>(s, a, <span class="at">runs =</span> <span class="dv">1000</span>)</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      mdp<span class="sc">$</span><span class="fu">addAction</span>(s, a, <span class="at">r =</span> lst<span class="sc">$</span>r, <span class="at">pr =</span> lst<span class="sc">$</span>pr)</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>   }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="do">## Solve the MDP</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>mdp<span class="sc">$</span><span class="fu">policyIte</span>(<span class="at">gamma =</span> <span class="dv">1</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="co"># mdp$valueIte(gamma = 1)</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>dfMDP <span class="ot">&lt;-</span> <span class="fu">left_join</span>(mdp<span class="sc">$</span><span class="fu">getStateValues</span>(), mdp<span class="sc">$</span><span class="fu">getPolicy</span>(), <span class="at">by =</span> <span class="st">"state"</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>   <span class="fu">select</span>(<span class="sc">-</span>pr) <span class="sc">%&gt;%</span> </span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>   <span class="fu">separate</span>(state, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"inv"</span>, <span class="st">"t"</span>), <span class="at">remove =</span> F, <span class="at">convert =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us plot the optimal policy (see Figure @ref(fig:seasonal-mdp-plot)):</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>dfMDP <span class="sc">%&gt;%</span> <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(t)) <span class="sc">%&gt;%</span> </span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> inv, <span class="at">col =</span> action)) <span class="sc">+</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="09_mc_files/figure-html/seasonal-mdp-plot-1.png" class="img-fluid figure-img" width="672"></p>
<figcaption>Optimal policy for the MDP.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note in general we change the price based on a diagonal line running from upper-left to lower-right. Some time two prices oscillate given a time due to state-values close to each other.</p>
<p>The best inventory level to order can be found by searching among the state-values at time one.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> dfMDP <span class="sc">%&gt;%</span> </span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(t <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">arrange</span>(<span class="fu">desc</span>(v)) <span class="sc">%&gt;%</span> </span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">print</span>()</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 100 × 5</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    state   inv     t     v action</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; </span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 64,1     64     1  358. 20    </span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 62,1     62     1  358. 20    </span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 63,1     63     1  358. 20    </span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 61,1     61     1  357. 20    </span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 65,1     65     1  357. 20    </span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 66,1     66     1  355. 20    </span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 60,1     60     1  355. 20    </span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 67,1     67     1  353. 20    </span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 59,1     59     1  352. 20    </span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 68,1     68     1  351. 20    </span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 90 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This is approx around 64 items. If ordering 100 items we would loose:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>res<span class="sc">$</span>v[<span class="dv">1</span>] <span class="sc">-</span> dfMDP <span class="sc">%&gt;%</span> </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"100,1"</span>) <span class="sc">%&gt;%</span> <span class="fu">pull</span>(v)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 64,1.20 </span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    91.3</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us now try to use RL and MC to approximate the best policy. First, we define a generic RL agent:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(R6)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(hash)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="do">## Generic RL agent for tabular data (R6 class)</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>RLAgent <span class="ot">&lt;-</span> <span class="fu">R6Class</span>(<span class="st">"RLAgent"</span>,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>   <span class="at">public =</span> <span class="fu">list</span>(</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @field model The model is used to represent the information we have. The</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' model is represented using a hash list for the states. Each states contains </span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - A list with `actions` (a hash #' list with actions).</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - `pi` (a named vector with policy pr (only positive values).</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - `piG` the greedy action (a string). </span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - `n` a visit counter</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' The `actions` hash list contains </span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - The action-values `q`.</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    - `n` a visit counter.</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="cn">NULL</span>,  </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Create an object (when call new).</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">initialize =</span> <span class="cf">function</span>() {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model <span class="ot">&lt;-</span> <span class="fu">hash</span>()</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Add state and action to the hash (only if not already added)</span></span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s State key/string.</span></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param a Action key/string.</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">addStateAction =</span> <span class="cf">function</span>(s, a) {</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (<span class="sc">!</span><span class="fu">has.key</span>(s, self<span class="sc">$</span>model)) <span class="fu">addStates</span>(s)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (<span class="sc">!</span><span class="fu">has.key</span>(a, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">q =</span> <span class="dv">0</span>, <span class="at">n =</span> <span class="dv">0</span>)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Add the states (keys) and define void policy and empty action hash. </span></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states A vector of states (converted to strings).</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">addStates =</span> <span class="cf">function</span>(states) {</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>         keys <span class="ot">&lt;-</span> <span class="fu">make.keys</span>(states)</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[keys] <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">pi =</span> <span class="cn">NA</span>)   <span class="co"># don't use pi = NULL since then won't be defined </span></span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> keys) {</span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> <span class="cn">NA</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions <span class="ot">&lt;-</span> <span class="fu">hash</span>()</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># counter visited</span></span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Add the actions to a state</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s State (key).</span></span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param actions A vector of actions (converted to strings).</span></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">addActions =</span> <span class="cf">function</span>(s, actions) {</span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>         keys <span class="ot">&lt;-</span> <span class="fu">make.keys</span>(actions)</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (a <span class="cf">in</span> keys) {</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">addStateAction</span>(s, a)</span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Add states and actions to the hash with initial values. If already exists nothing happens. </span></span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param df A tibble with string columns `s` (states) and `a` (actions).</span></span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>      <span class="at">addStatesAndActions =</span> <span class="cf">function</span>(df) {</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">nrow</span>(df)) {</span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">addStateAction</span>(df<span class="sc">$</span>s[i], df<span class="sc">$</span>a[i])</span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the action-values for all actions.</span></span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param value The value.</span></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a>      <span class="at">setActionValue =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">0</span>) {</span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) {</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">=</span> value</span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the state-value of states</span></span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states A vector of states.</span></span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param value The value.</span></span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a>      <span class="at">setStateValue =</span> <span class="cf">function</span>(<span class="at">states =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model), <span class="at">value =</span> <span class="dv">0</span>) {</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> value</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-87"><a href="#cb7-87" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-88"><a href="#cb7-88" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the action visit counter values for all actions.</span></span>
<span id="cb7-89"><a href="#cb7-89" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param ctrValue Counter value.</span></span>
<span id="cb7-90"><a href="#cb7-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">setActionCtrValue =</span> <span class="cf">function</span>(<span class="at">ctrValue =</span> <span class="dv">0</span>) {</span>
<span id="cb7-91"><a href="#cb7-91" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb7-92"><a href="#cb7-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)) {</span>
<span id="cb7-93"><a href="#cb7-93" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb7-94"><a href="#cb7-94" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-95"><a href="#cb7-95" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-96"><a href="#cb7-96" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-97"><a href="#cb7-97" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-98"><a href="#cb7-98" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-99"><a href="#cb7-99" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the action-values for a single action (including the counter values).</span></span>
<span id="cb7-100"><a href="#cb7-100" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param value The value.</span></span>
<span id="cb7-101"><a href="#cb7-101" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param ctrValue Counter value.</span></span>
<span id="cb7-102"><a href="#cb7-102" aria-hidden="true" tabindex="-1"></a>      <span class="at">setActionValueSingle =</span> <span class="cf">function</span>(<span class="at">value =</span> <span class="dv">0</span>, <span class="at">ctrValue =</span> <span class="dv">0</span>, s, a) {</span>
<span id="cb7-103"><a href="#cb7-103" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">=</span> value</span>
<span id="cb7-104"><a href="#cb7-104" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the policy to a random epsilon-greedy policy.</span></span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used in epsilon-greedy policy.</span></span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>      <span class="at">setRandomEpsGreedyPolicy =</span> <span class="cf">function</span>(eps) {</span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(actions), <span class="fu">length</span>(actions))</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi) <span class="ot">&lt;-</span> actions</span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>            piG <span class="ot">&lt;-</span> <span class="fu">sample</span>(self<span class="sc">$</span><span class="fu">getActionKeys</span>(s), <span class="dv">1</span>)</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[piG] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[piG] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the policy to the optimal epsilon-greedy policy </span></span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used in epsilon-greedy policy.</span></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states States under consideration.</span></span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>      <span class="at">setEpsGreedyPolicy =</span> <span class="cf">function</span>(eps, states) {</span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb7-128"><a href="#cb7-128" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(actions), <span class="fu">length</span>(actions))</span>
<span id="cb7-129"><a href="#cb7-129" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi) <span class="ot">&lt;-</span> actions</span>
<span id="cb7-130"><a href="#cb7-130" aria-hidden="true" tabindex="-1"></a>            idx <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">which.is.max</span>(<span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,]))  <span class="co"># choose among max values at random</span></span>
<span id="cb7-131"><a href="#cb7-131" aria-hidden="true" tabindex="-1"></a>            <span class="co"># idx &lt;- which.max(unlist(values(self$model[[s]]$actions)["q",]))  # choose first max </span></span>
<span id="cb7-132"><a href="#cb7-132" aria-hidden="true" tabindex="-1"></a>            <span class="co"># self$model[[s]]$piG &lt;- actions[idx]</span></span>
<span id="cb7-133"><a href="#cb7-133" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[idx] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi[idx] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb7-134"><a href="#cb7-134" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-135"><a href="#cb7-135" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-136"><a href="#cb7-136" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-137"><a href="#cb7-137" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-138"><a href="#cb7-138" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the greedy policy based on action-values. </span></span>
<span id="cb7-139"><a href="#cb7-139" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states States under consideration.</span></span>
<span id="cb7-140"><a href="#cb7-140" aria-hidden="true" tabindex="-1"></a>      <span class="at">setGreedyPolicy =</span> <span class="cf">function</span>(<span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb7-141"><a href="#cb7-141" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-142"><a href="#cb7-142" aria-hidden="true" tabindex="-1"></a>            pi <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb7-143"><a href="#cb7-143" aria-hidden="true" tabindex="-1"></a>            actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb7-144"><a href="#cb7-144" aria-hidden="true" tabindex="-1"></a>            <span class="co"># idx &lt;- nnet::which.is.max(unlist(values(self$model[[s]]$actions)["q",]))  # choose among max values at random</span></span>
<span id="cb7-145"><a href="#cb7-145" aria-hidden="true" tabindex="-1"></a>            idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(<span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,]))  <span class="co"># choose first max</span></span>
<span id="cb7-146"><a href="#cb7-146" aria-hidden="true" tabindex="-1"></a>            <span class="fu">names</span>(pi) <span class="ot">&lt;-</span> actions[idx]</span>
<span id="cb7-147"><a href="#cb7-147" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> pi</span>
<span id="cb7-148"><a href="#cb7-148" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-149"><a href="#cb7-149" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-150"><a href="#cb7-150" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-151"><a href="#cb7-151" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-152"><a href="#cb7-152" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the policy to the named vector pi for a set of states</span></span>
<span id="cb7-153"><a href="#cb7-153" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states States under consideration.</span></span>
<span id="cb7-154"><a href="#cb7-154" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param pi A named vector with policy pr (only psitive values).</span></span>
<span id="cb7-155"><a href="#cb7-155" aria-hidden="true" tabindex="-1"></a>      <span class="at">setPolicy =</span> <span class="cf">function</span>(states, pi) {</span>
<span id="cb7-156"><a href="#cb7-156" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-157"><a href="#cb7-157" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi <span class="ot">&lt;-</span> pi</span>
<span id="cb7-158"><a href="#cb7-158" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-159"><a href="#cb7-159" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-160"><a href="#cb7-160" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-161"><a href="#cb7-161" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-162"><a href="#cb7-162" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Set the state visit counter values for all states.</span></span>
<span id="cb7-163"><a href="#cb7-163" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param ctrValue Counter value.</span></span>
<span id="cb7-164"><a href="#cb7-164" aria-hidden="true" tabindex="-1"></a>      <span class="at">setStateCtrValue =</span> <span class="cf">function</span>(<span class="at">ctrValue =</span> <span class="dv">0</span>) {</span>
<span id="cb7-165"><a href="#cb7-165" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb7-166"><a href="#cb7-166" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">=</span> ctrValue</span>
<span id="cb7-167"><a href="#cb7-167" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-168"><a href="#cb7-168" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-169"><a href="#cb7-169" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-170"><a href="#cb7-170" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-171"><a href="#cb7-171" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the state keys</span></span>
<span id="cb7-172"><a href="#cb7-172" aria-hidden="true" tabindex="-1"></a>      <span class="at">getStateKeys =</span> <span class="cf">function</span>() {</span>
<span id="cb7-173"><a href="#cb7-173" aria-hidden="true" tabindex="-1"></a>         <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb7-174"><a href="#cb7-174" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-175"><a href="#cb7-175" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-176"><a href="#cb7-176" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the state-value for a state and policy using the q/action-values </span></span>
<span id="cb7-177"><a href="#cb7-177" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s A state.</span></span>
<span id="cb7-178"><a href="#cb7-178" aria-hidden="true" tabindex="-1"></a>      <span class="at">getStateValueQ =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-179"><a href="#cb7-179" aria-hidden="true" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb7-180"><a href="#cb7-180" aria-hidden="true" tabindex="-1"></a>         <span class="co"># print(pi)</span></span>
<span id="cb7-181"><a href="#cb7-181" aria-hidden="true" tabindex="-1"></a>         val <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-182"><a href="#cb7-182" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (a <span class="cf">in</span> <span class="fu">names</span>(pi)) {</span>
<span id="cb7-183"><a href="#cb7-183" aria-hidden="true" tabindex="-1"></a>            val <span class="ot">&lt;-</span> val <span class="sc">+</span> pi[a] <span class="sc">*</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb7-184"><a href="#cb7-184" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(self$model[[s]]$actions[[a]]$q)</span></span>
<span id="cb7-185"><a href="#cb7-185" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-186"><a href="#cb7-186" aria-hidden="true" tabindex="-1"></a>         <span class="co"># print(val)</span></span>
<span id="cb7-187"><a href="#cb7-187" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(val)</span>
<span id="cb7-188"><a href="#cb7-188" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-189"><a href="#cb7-189" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-190"><a href="#cb7-190" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the state-values as a tibble</span></span>
<span id="cb7-191"><a href="#cb7-191" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s A vector of state keys.</span></span>
<span id="cb7-192"><a href="#cb7-192" aria-hidden="true" tabindex="-1"></a>      <span class="at">getStateValues =</span> <span class="cf">function</span>(<span class="at">s =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb7-193"><a href="#cb7-193" aria-hidden="true" tabindex="-1"></a>         <span class="fu">tibble</span>(<span class="at">state =</span> s) <span class="sc">%&gt;%</span> <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">v =</span> self<span class="sc">$</span>model[[state]]<span class="sc">$</span>v) </span>
<span id="cb7-194"><a href="#cb7-194" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-195"><a href="#cb7-195" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-196"><a href="#cb7-196" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the action keys</span></span>
<span id="cb7-197"><a href="#cb7-197" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s The state considered.</span></span>
<span id="cb7-198"><a href="#cb7-198" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionKeys =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-199"><a href="#cb7-199" aria-hidden="true" tabindex="-1"></a>         <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions) </span>
<span id="cb7-200"><a href="#cb7-200" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-201"><a href="#cb7-201" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-202"><a href="#cb7-202" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return information about actions stored in a state</span></span>
<span id="cb7-203"><a href="#cb7-203" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s The state considered.</span></span>
<span id="cb7-204"><a href="#cb7-204" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionInfo =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-205"><a href="#cb7-205" aria-hidden="true" tabindex="-1"></a>         <span class="fu">as.list</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions) </span>
<span id="cb7-206"><a href="#cb7-206" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-207"><a href="#cb7-207" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-208"><a href="#cb7-208" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the current policy as a tibble</span></span>
<span id="cb7-209"><a href="#cb7-209" aria-hidden="true" tabindex="-1"></a>      <span class="at">getPolicy =</span> <span class="cf">function</span>(<span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb7-210"><a href="#cb7-210" aria-hidden="true" tabindex="-1"></a>         <span class="fu">map_dfr</span>(states, <span class="at">.f =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-211"><a href="#cb7-211" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> s, <span class="at">action =</span> <span class="fu">names</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi), <span class="at">pr =</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi)</span>
<span id="cb7-212"><a href="#cb7-212" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb7-213"><a href="#cb7-213" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-214"><a href="#cb7-214" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-215"><a href="#cb7-215" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Returns all action-values in a matrix (cols: actions, rows: states)</span></span>
<span id="cb7-216"><a href="#cb7-216" aria-hidden="true" tabindex="-1"></a>      <span class="at">getStateActionQMat =</span> <span class="cf">function</span>() {</span>
<span id="cb7-217"><a href="#cb7-217" aria-hidden="true" tabindex="-1"></a>         states <span class="ot">&lt;-</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)</span>
<span id="cb7-218"><a href="#cb7-218" aria-hidden="true" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> <span class="fu">unique</span>(<span class="fu">unlist</span>(<span class="fu">sapply</span>(states, <span class="cf">function</span>(s) self<span class="sc">$</span><span class="fu">getActionKeys</span>(s))))</span>
<span id="cb7-219"><a href="#cb7-219" aria-hidden="true" tabindex="-1"></a>         m <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> <span class="fu">length</span>(states), <span class="at">ncol =</span> <span class="fu">length</span>(actions))</span>
<span id="cb7-220"><a href="#cb7-220" aria-hidden="true" tabindex="-1"></a>         <span class="fu">colnames</span>(m) <span class="ot">&lt;-</span> actions</span>
<span id="cb7-221"><a href="#cb7-221" aria-hidden="true" tabindex="-1"></a>         <span class="fu">rownames</span>(m) <span class="ot">&lt;-</span> states</span>
<span id="cb7-222"><a href="#cb7-222" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (s <span class="cf">in</span> states) {</span>
<span id="cb7-223"><a href="#cb7-223" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (a <span class="cf">in</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)) {</span>
<span id="cb7-224"><a href="#cb7-224" aria-hidden="true" tabindex="-1"></a>               m[s, a] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb7-225"><a href="#cb7-225" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-226"><a href="#cb7-226" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-227"><a href="#cb7-227" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(m)</span>
<span id="cb7-228"><a href="#cb7-228" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-229"><a href="#cb7-229" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-230"><a href="#cb7-230" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return the action-values as a tibble</span></span>
<span id="cb7-231"><a href="#cb7-231" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states A vector of state keys.</span></span>
<span id="cb7-232"><a href="#cb7-232" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionValues =</span> <span class="cf">function</span>(<span class="at">states =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model)) {</span>
<span id="cb7-233"><a href="#cb7-233" aria-hidden="true" tabindex="-1"></a>         <span class="fu">map_dfr</span>(states, <span class="at">.f =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-234"><a href="#cb7-234" aria-hidden="true" tabindex="-1"></a>               <span class="fu">list</span>(<span class="at">state =</span> s, <span class="at">action =</span> <span class="fu">keys</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions), <span class="at">q =</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,]), <span class="at">n =</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"n"</span>,]))</span>
<span id="cb7-235"><a href="#cb7-235" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb7-236"><a href="#cb7-236" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-237"><a href="#cb7-237" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-238"><a href="#cb7-238" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Select next action using upper-confidence bound. Also update the visit counters for both state and selected action.</span></span>
<span id="cb7-239"><a href="#cb7-239" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @return Action.</span></span>
<span id="cb7-240"><a href="#cb7-240" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionUCB =</span> <span class="cf">function</span>(s, <span class="at">coeff =</span> <span class="dv">1</span>) { </span>
<span id="cb7-241"><a href="#cb7-241" aria-hidden="true" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb7-242"><a href="#cb7-242" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb7-243"><a href="#cb7-243" aria-hidden="true" tabindex="-1"></a>         qV <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,])</span>
<span id="cb7-244"><a href="#cb7-244" aria-hidden="true" tabindex="-1"></a>         nA <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"n"</span>,])</span>
<span id="cb7-245"><a href="#cb7-245" aria-hidden="true" tabindex="-1"></a>         nS <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n</span>
<span id="cb7-246"><a href="#cb7-246" aria-hidden="true" tabindex="-1"></a>         val <span class="ot">&lt;-</span> qV <span class="sc">+</span> coeff <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">log</span>(nS <span class="sc">+</span> <span class="fl">0.0001</span>)<span class="sc">/</span>nA)</span>
<span id="cb7-247"><a href="#cb7-247" aria-hidden="true" tabindex="-1"></a>         idx <span class="ot">&lt;-</span> <span class="fu">which.max</span>(val)</span>
<span id="cb7-248"><a href="#cb7-248" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> actions[idx]</span>
<span id="cb7-249"><a href="#cb7-249" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb7-250"><a href="#cb7-250" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb7-251"><a href="#cb7-251" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-252"><a href="#cb7-252" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-253"><a href="#cb7-253" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Select next action using epsilon-greedy policy based on action-values. Also update the visit counters for both state and selected action.</span></span>
<span id="cb7-254"><a href="#cb7-254" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @return Action.</span></span>
<span id="cb7-255"><a href="#cb7-255" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionEG =</span> <span class="cf">function</span>(s, eps) {</span>
<span id="cb7-256"><a href="#cb7-256" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb7-257"><a href="#cb7-257" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,])</span>
<span id="cb7-258"><a href="#cb7-258" aria-hidden="true" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionKeys</span>(s)</span>
<span id="cb7-259"><a href="#cb7-259" aria-hidden="true" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> <span class="fu">rep</span>(eps<span class="sc">/</span><span class="fu">length</span>(q), <span class="fu">length</span>(q))</span>
<span id="cb7-260"><a href="#cb7-260" aria-hidden="true" tabindex="-1"></a>         idx <span class="ot">&lt;-</span> nnet<span class="sc">::</span><span class="fu">which.is.max</span>(q)  <span class="co"># choose among max values at random</span></span>
<span id="cb7-261"><a href="#cb7-261" aria-hidden="true" tabindex="-1"></a>         <span class="co"># idx &lt;- which.max(unlist(values(self$model[[s]]$actions)["q",]))  # choose first max </span></span>
<span id="cb7-262"><a href="#cb7-262" aria-hidden="true" tabindex="-1"></a>         pi[idx] <span class="ot">&lt;-</span> pi[idx] <span class="sc">+</span> <span class="dv">1</span> <span class="sc">-</span> eps</span>
<span id="cb7-263"><a href="#cb7-263" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> actions[<span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(actions), <span class="dv">1</span>, <span class="at">prob =</span> pi)]</span>
<span id="cb7-264"><a href="#cb7-264" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb7-265"><a href="#cb7-265" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb7-266"><a href="#cb7-266" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-267"><a href="#cb7-267" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-268"><a href="#cb7-268" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Find maximum action value in a state.</span></span>
<span id="cb7-269"><a href="#cb7-269" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @return Value.</span></span>
<span id="cb7-270"><a href="#cb7-270" aria-hidden="true" tabindex="-1"></a>      <span class="at">getMaxActionValue =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-271"><a href="#cb7-271" aria-hidden="true" tabindex="-1"></a>         q <span class="ot">&lt;-</span> <span class="fu">unlist</span>(<span class="fu">values</span>(self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions)[<span class="st">"q"</span>,])</span>
<span id="cb7-272"><a href="#cb7-272" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">max</span>(q))</span>
<span id="cb7-273"><a href="#cb7-273" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-274"><a href="#cb7-274" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-275"><a href="#cb7-275" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Find expected action value in a state based on current policy</span></span>
<span id="cb7-276"><a href="#cb7-276" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @return Value.</span></span>
<span id="cb7-277"><a href="#cb7-277" aria-hidden="true" tabindex="-1"></a>      <span class="at">getExpActionValue =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-278"><a href="#cb7-278" aria-hidden="true" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb7-279"><a href="#cb7-279" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">names</span>(pi)</span>
<span id="cb7-280"><a href="#cb7-280" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(pi)) {</span>
<span id="cb7-281"><a href="#cb7-281" aria-hidden="true" tabindex="-1"></a>            pi[i] <span class="ot">&lt;-</span> pi[i] <span class="sc">*</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a[i]]]<span class="sc">$</span>q</span>
<span id="cb7-282"><a href="#cb7-282" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-283"><a href="#cb7-283" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">sum</span>(pi))</span>
<span id="cb7-284"><a href="#cb7-284" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-285"><a href="#cb7-285" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-286"><a href="#cb7-286" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Return and action sampled from the current policy pi. Also update the visit counters for both state and selected action.</span></span>
<span id="cb7-287"><a href="#cb7-287" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param s The state considered.</span></span>
<span id="cb7-288"><a href="#cb7-288" aria-hidden="true" tabindex="-1"></a>      <span class="at">getActionPi =</span> <span class="cf">function</span>(s) {</span>
<span id="cb7-289"><a href="#cb7-289" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># visit s</span></span>
<span id="cb7-290"><a href="#cb7-290" aria-hidden="true" tabindex="-1"></a>         pi <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>pi</span>
<span id="cb7-291"><a href="#cb7-291" aria-hidden="true" tabindex="-1"></a>         actions <span class="ot">&lt;-</span> <span class="fu">names</span>(pi)</span>
<span id="cb7-292"><a href="#cb7-292" aria-hidden="true" tabindex="-1"></a>         a <span class="ot">&lt;-</span> <span class="fu">sample</span>(actions, <span class="dv">1</span>, <span class="at">prob =</span> pi)</span>
<span id="cb7-293"><a href="#cb7-293" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n <span class="sc">+</span> <span class="dv">1</span>  <span class="co"># note there is a risk here if use every-visit for an episode then will update more than once implying slower convergence. </span></span>
<span id="cb7-294"><a href="#cb7-294" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(a)</span>
<span id="cb7-295"><a href="#cb7-295" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-296"><a href="#cb7-296" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-297"><a href="#cb7-297" aria-hidden="true" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb7-298"><a href="#cb7-298" aria-hidden="true" tabindex="-1"></a><span class="co">#       getActionPi = function(s) {</span></span>
<span id="cb7-299"><a href="#cb7-299" aria-hidden="true" tabindex="-1"></a><span class="co">#          pi &lt;- self$model[[s]]$pi</span></span>
<span id="cb7-300"><a href="#cb7-300" aria-hidden="true" tabindex="-1"></a><span class="co">#          return(sample(names(pi), 1, prob = pi))</span></span>
<span id="cb7-301"><a href="#cb7-301" aria-hidden="true" tabindex="-1"></a><span class="co">#       },</span></span>
<span id="cb7-302"><a href="#cb7-302" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-303"><a href="#cb7-303" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Policy evaluation using TD(0)</span></span>
<span id="cb7-304"><a href="#cb7-304" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb7-305"><a href="#cb7-305" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-306"><a href="#cb7-306" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb7-307"><a href="#cb7-307" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxE Maximum number of episodes generated.  </span></span>
<span id="cb7-308"><a href="#cb7-308" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxEL Maximum episode length.</span></span>
<span id="cb7-309"><a href="#cb7-309" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all state-values to 0.</span></span>
<span id="cb7-310"><a href="#cb7-310" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Possible start states of each episode (one picked at random).</span></span>
<span id="cb7-311"><a href="#cb7-311" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param ... Further arguments passed to `getEpisode` e.g the coefficient used for upper-confidence bound action selection. </span></span>
<span id="cb7-312"><a href="#cb7-312" aria-hidden="true" tabindex="-1"></a>      <span class="at">policyEvalTD0 =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>()) {</span>
<span id="cb7-313"><a href="#cb7-313" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) self<span class="sc">$</span><span class="fu">setStateValue</span>(self<span class="sc">$</span><span class="fu">getStateKeys</span>())      <span class="co"># set to 0</span></span>
<span id="cb7-314"><a href="#cb7-314" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb7-315"><a href="#cb7-315" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among states</span></span>
<span id="cb7-316"><a href="#cb7-316" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with ss as start (max length 100000)</span></span>
<span id="cb7-317"><a href="#cb7-317" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb7-318"><a href="#cb7-318" aria-hidden="true" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb7-319"><a href="#cb7-319" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb7-320"><a href="#cb7-320" aria-hidden="true" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb7-321"><a href="#cb7-321" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb7-322"><a href="#cb7-322" aria-hidden="true" tabindex="-1"></a>               oldV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb7-323"><a href="#cb7-323" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> oldV <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>v <span class="sc">-</span> oldV)</span>
<span id="cb7-324"><a href="#cb7-324" aria-hidden="true" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb7-325"><a href="#cb7-325" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-326"><a href="#cb7-326" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb7-327"><a href="#cb7-327" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-328"><a href="#cb7-328" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-329"><a href="#cb7-329" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-330"><a href="#cb7-330" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-331"><a href="#cb7-331" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Policy evaluation using every-visit Monte Carlo sampling.  </span></span>
<span id="cb7-332"><a href="#cb7-332" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getEpisode(agent, s, coeff)` that return an episode as a tibble with </span></span>
<span id="cb7-333"><a href="#cb7-333" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    cols s, a, r (last col the terminal reward). This method also must update the visit counters if needed! This is also </span></span>
<span id="cb7-334"><a href="#cb7-334" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    the method that decides which action selection method is used. </span></span>
<span id="cb7-335"><a href="#cb7-335" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-336"><a href="#cb7-336" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param theta Threshold parameter.</span></span>
<span id="cb7-337"><a href="#cb7-337" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param minIte Minimum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb7-338"><a href="#cb7-338" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxIte Maximum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb7-339"><a href="#cb7-339" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all state-values to 0.</span></span>
<span id="cb7-340"><a href="#cb7-340" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Start states in the episodes, which all are visited using a for loop.</span></span>
<span id="cb7-341"><a href="#cb7-341" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param verbose If true then print info for each episode.</span></span>
<span id="cb7-342"><a href="#cb7-342" aria-hidden="true" tabindex="-1"></a>      <span class="at">policyEvalMC =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">theta =</span> <span class="fl">0.1</span>, <span class="at">minIte =</span> <span class="dv">100</span>, <span class="at">maxIte =</span> <span class="dv">1000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-343"><a href="#cb7-343" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb7-344"><a href="#cb7-344" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb7-345"><a href="#cb7-345" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb7-346"><a href="#cb7-346" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb7-347"><a href="#cb7-347" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-348"><a href="#cb7-348" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxIte) {</span>
<span id="cb7-349"><a href="#cb7-349" aria-hidden="true" tabindex="-1"></a>            delta <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-350"><a href="#cb7-350" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (ss <span class="cf">in</span> states) {  <span class="co"># for episode with s as start</span></span>
<span id="cb7-351"><a href="#cb7-351" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getEpisodePi</span>(self, ss)  <span class="co"># an episode stored in a tibble with cols s, a, r (last col the terminal reward)</span></span>
<span id="cb7-352"><a href="#cb7-352" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">next</span></span>
<span id="cb7-353"><a href="#cb7-353" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">nS =</span> <span class="cn">NA</span>, <span class="at">g =</span> <span class="cn">NA</span>, <span class="at">oldV =</span> <span class="cn">NA</span>, <span class="at">v =</span> <span class="cn">NA</span>)</span>
<span id="cb7-354"><a href="#cb7-354" aria-hidden="true" tabindex="-1"></a>               gain <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-355"><a href="#cb7-355" aria-hidden="true" tabindex="-1"></a>               <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">nrow</span>(df)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb7-356"><a href="#cb7-356" aria-hidden="true" tabindex="-1"></a>                  s <span class="ot">&lt;-</span> df<span class="sc">$</span>s[i]</span>
<span id="cb7-357"><a href="#cb7-357" aria-hidden="true" tabindex="-1"></a>                  a <span class="ot">&lt;-</span> df<span class="sc">$</span>a[i]</span>
<span id="cb7-358"><a href="#cb7-358" aria-hidden="true" tabindex="-1"></a>                  gain <span class="ot">&lt;-</span> df<span class="sc">$</span>r[i] <span class="sc">+</span> gamma <span class="sc">*</span> gain</span>
<span id="cb7-359"><a href="#cb7-359" aria-hidden="true" tabindex="-1"></a>                  ctr <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n</span>
<span id="cb7-360"><a href="#cb7-360" aria-hidden="true" tabindex="-1"></a>                  oldV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb7-361"><a href="#cb7-361" aria-hidden="true" tabindex="-1"></a>                  stepSize <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>ctr)</span>
<span id="cb7-362"><a href="#cb7-362" aria-hidden="true" tabindex="-1"></a>                  self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v <span class="ot">&lt;-</span> oldV <span class="sc">+</span> stepSize <span class="sc">*</span> (gain <span class="sc">-</span> oldV)</span>
<span id="cb7-363"><a href="#cb7-363" aria-hidden="true" tabindex="-1"></a>                  newV <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>v</span>
<span id="cb7-364"><a href="#cb7-364" aria-hidden="true" tabindex="-1"></a>                  delta <span class="ot">&lt;-</span> <span class="fu">max</span>(delta, <span class="fu">abs</span>(oldV <span class="sc">-</span> newV))</span>
<span id="cb7-365"><a href="#cb7-365" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> (verbose) df<span class="sc">$</span>g[i] <span class="ot">&lt;-</span> gain; df<span class="sc">$</span>nS[i] <span class="ot">&lt;-</span> ctr; df<span class="sc">$</span>oldV[i] <span class="ot">&lt;-</span> oldV; df<span class="sc">$</span>v[i] <span class="ot">&lt;-</span> newV</span>
<span id="cb7-366"><a href="#cb7-366" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb7-367"><a href="#cb7-367" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">print</span>(df)</span>
<span id="cb7-368"><a href="#cb7-368" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-369"><a href="#cb7-369" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (delta <span class="sc">&lt;</span> theta <span class="sc">&amp;</span> ite <span class="sc">&gt;=</span> minIte) <span class="cf">break</span></span>
<span id="cb7-370"><a href="#cb7-370" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-371"><a href="#cb7-371" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (ite <span class="sc">==</span> maxIte) <span class="fu">warning</span>(<span class="st">"Polcy eval algorithm stopped at max iterations allowed: "</span>, maxIte)</span>
<span id="cb7-372"><a href="#cb7-372" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"Policy eval algorihm finished in "</span>, ite, <span class="st">" iterations."</span>))</span>
<span id="cb7-373"><a href="#cb7-373" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-374"><a href="#cb7-374" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-375"><a href="#cb7-375" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-376"><a href="#cb7-376" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Generalized policy iteration using on policy every-visit Monte Carlo sampling.  </span></span>
<span id="cb7-377"><a href="#cb7-377" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getEpisode(agent, s, coeff)` that return an episode as a tibble with </span></span>
<span id="cb7-378"><a href="#cb7-378" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    cols s, a, r (last col the terminal reward). This method also must update the visit counters if needed! This is also </span></span>
<span id="cb7-379"><a href="#cb7-379" aria-hidden="true" tabindex="-1"></a>      <span class="co">#'    the method that decides which action selection method is used. </span></span>
<span id="cb7-380"><a href="#cb7-380" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-381"><a href="#cb7-381" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param theta Threshold parameter.</span></span>
<span id="cb7-382"><a href="#cb7-382" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param minIte Minimum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb7-383"><a href="#cb7-383" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxIte Maximum number of iterations for each start state (all `states` are used a start state in one iteration).</span></span>
<span id="cb7-384"><a href="#cb7-384" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all action-values to 0.</span></span>
<span id="cb7-385"><a href="#cb7-385" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Start states in the episodes, which all are visited using a for loop.</span></span>
<span id="cb7-386"><a href="#cb7-386" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb7-387"><a href="#cb7-387" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param verbose If true then print info for each episode.</span></span>
<span id="cb7-388"><a href="#cb7-388" aria-hidden="true" tabindex="-1"></a>      <span class="at">gpiOnPolicyMC =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">theta =</span> <span class="fl">0.1</span>, <span class="at">minIte =</span> <span class="dv">100</span>, <span class="at">maxIte =</span> <span class="dv">1000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-389"><a href="#cb7-389" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb7-390"><a href="#cb7-390" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb7-391"><a href="#cb7-391" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb7-392"><a href="#cb7-392" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb7-393"><a href="#cb7-393" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-394"><a href="#cb7-394" aria-hidden="true" tabindex="-1"></a>         <span class="co"># self$setRandomEpsGreedyPolicy(epsilon)</span></span>
<span id="cb7-395"><a href="#cb7-395" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb7-396"><a href="#cb7-396" aria-hidden="true" tabindex="-1"></a>         <span class="co"># self$setGreedyPolicy()</span></span>
<span id="cb7-397"><a href="#cb7-397" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxIte) {</span>
<span id="cb7-398"><a href="#cb7-398" aria-hidden="true" tabindex="-1"></a>            delta <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-399"><a href="#cb7-399" aria-hidden="true" tabindex="-1"></a>            <span class="co"># stable &lt;- TRUE</span></span>
<span id="cb7-400"><a href="#cb7-400" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (ss <span class="cf">in</span> states) {  <span class="co"># for episode with s as start</span></span>
<span id="cb7-401"><a href="#cb7-401" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getEpisode</span>(self, ss, eps)  <span class="co"># an episode stored in a tibble with cols s, a, r (last col the terminal reward)</span></span>
<span id="cb7-402"><a href="#cb7-402" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">nrow</span>(df) <span class="sc">==</span> <span class="dv">0</span>) <span class="cf">next</span></span>
<span id="cb7-403"><a href="#cb7-403" aria-hidden="true" tabindex="-1"></a>               df <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span> <span class="fu">mutate</span>(<span class="at">nA =</span> <span class="cn">NA</span>, <span class="at">nS =</span> <span class="cn">NA</span>, <span class="at">oldQ =</span> <span class="cn">NA</span>, <span class="at">q =</span> <span class="cn">NA</span>, <span class="at">g =</span> <span class="cn">NA</span>, <span class="at">oldV =</span> <span class="cn">NA</span>, <span class="at">v =</span> <span class="cn">NA</span>)</span>
<span id="cb7-404"><a href="#cb7-404" aria-hidden="true" tabindex="-1"></a>               gain <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb7-405"><a href="#cb7-405" aria-hidden="true" tabindex="-1"></a>               <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">nrow</span>(df)<span class="sc">:</span><span class="dv">1</span>) {</span>
<span id="cb7-406"><a href="#cb7-406" aria-hidden="true" tabindex="-1"></a>                  s <span class="ot">&lt;-</span> df<span class="sc">$</span>s[i]</span>
<span id="cb7-407"><a href="#cb7-407" aria-hidden="true" tabindex="-1"></a>                  a <span class="ot">&lt;-</span> df<span class="sc">$</span>a[i]</span>
<span id="cb7-408"><a href="#cb7-408" aria-hidden="true" tabindex="-1"></a>                  gain <span class="ot">&lt;-</span> df<span class="sc">$</span>r[i] <span class="sc">+</span> gamma <span class="sc">*</span> gain</span>
<span id="cb7-409"><a href="#cb7-409" aria-hidden="true" tabindex="-1"></a>                  ctr <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>n</span>
<span id="cb7-410"><a href="#cb7-410" aria-hidden="true" tabindex="-1"></a>                  oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q</span>
<span id="cb7-411"><a href="#cb7-411" aria-hidden="true" tabindex="-1"></a>                  oldV <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getStateValueQ</span>(s)</span>
<span id="cb7-412"><a href="#cb7-412" aria-hidden="true" tabindex="-1"></a>                  stepSize <span class="ot">&lt;-</span> (<span class="dv">1</span><span class="sc">/</span>ctr)<span class="sc">^</span><span class="fl">0.5</span></span>
<span id="cb7-413"><a href="#cb7-413" aria-hidden="true" tabindex="-1"></a>                  self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> stepSize <span class="sc">*</span> (gain <span class="sc">-</span> oldQ)</span>
<span id="cb7-414"><a href="#cb7-414" aria-hidden="true" tabindex="-1"></a>                  <span class="co"># self$model[[s]]$actions[[a]]$q &lt;- oldQ + 0.1 * (gain - oldQ)</span></span>
<span id="cb7-415"><a href="#cb7-415" aria-hidden="true" tabindex="-1"></a>                  self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb7-416"><a href="#cb7-416" aria-hidden="true" tabindex="-1"></a>                  newV <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getStateValueQ</span>(s)</span>
<span id="cb7-417"><a href="#cb7-417" aria-hidden="true" tabindex="-1"></a>                  delta <span class="ot">&lt;-</span> <span class="fu">max</span>(delta, <span class="fu">abs</span>(oldV <span class="sc">-</span> newV))</span>
<span id="cb7-418"><a href="#cb7-418" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">if</span> (verbose) df<span class="sc">$</span>oldQ[i] <span class="ot">&lt;-</span> oldQ; df<span class="sc">$</span>q[i] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q; df<span class="sc">$</span>g[i] <span class="ot">&lt;-</span> gain; df<span class="sc">$</span>nA[i] <span class="ot">&lt;-</span> ctr; df<span class="sc">$</span>nS[i] <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>n; df<span class="sc">$</span>oldV[i] <span class="ot">&lt;-</span> oldV; df<span class="sc">$</span>v[i] <span class="ot">&lt;-</span> newV</span>
<span id="cb7-419"><a href="#cb7-419" aria-hidden="true" tabindex="-1"></a>               }</span>
<span id="cb7-420"><a href="#cb7-420" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">print</span>(df)</span>
<span id="cb7-421"><a href="#cb7-421" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-422"><a href="#cb7-422" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (delta <span class="sc">&lt;</span> theta <span class="sc">&amp;</span> ite <span class="sc">&gt;=</span> minIte) <span class="cf">break</span></span>
<span id="cb7-423"><a href="#cb7-423" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-424"><a href="#cb7-424" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (ite <span class="sc">==</span> maxIte) <span class="fu">warning</span>(<span class="st">"GPI algorithm stopped at max iterations allowed: "</span>, maxIte)</span>
<span id="cb7-425"><a href="#cb7-425" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="fu">str_c</span>(<span class="st">"GPI algorihm finished in "</span>, ite, <span class="st">" iterations."</span>))</span>
<span id="cb7-426"><a href="#cb7-426" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-427"><a href="#cb7-427" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-428"><a href="#cb7-428" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-429"><a href="#cb7-429" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Generalized policy iteration using on policy SARSA.  </span></span>
<span id="cb7-430"><a href="#cb7-430" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb7-431"><a href="#cb7-431" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-432"><a href="#cb7-432" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxE Maximum number of episodes generated.</span></span>
<span id="cb7-433"><a href="#cb7-433" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb7-434"><a href="#cb7-434" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all action-values to 0.</span></span>
<span id="cb7-435"><a href="#cb7-435" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb7-436"><a href="#cb7-436" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb7-437"><a href="#cb7-437" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb7-438"><a href="#cb7-438" aria-hidden="true" tabindex="-1"></a>      <span class="at">gpiOnPolicySARSA =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-439"><a href="#cb7-439" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb7-440"><a href="#cb7-440" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb7-441"><a href="#cb7-441" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb7-442"><a href="#cb7-442" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-443"><a href="#cb7-443" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb7-444"><a href="#cb7-444" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb7-445"><a href="#cb7-445" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb7-446"><a href="#cb7-446" aria-hidden="true" tabindex="-1"></a>            a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb7-447"><a href="#cb7-447" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb7-448"><a href="#cb7-448" aria-hidden="true" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb7-449"><a href="#cb7-449" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb7-450"><a href="#cb7-450" aria-hidden="true" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb7-451"><a href="#cb7-451" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb7-452"><a href="#cb7-452" aria-hidden="true" tabindex="-1"></a>               aN <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(sN)</span>
<span id="cb7-453"><a href="#cb7-453" aria-hidden="true" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb7-454"><a href="#cb7-454" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>actions[[aN]]<span class="sc">$</span>q <span class="sc">-</span> oldQ)</span>
<span id="cb7-455"><a href="#cb7-455" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">"(s,a,r,s,a) = ("</span>, s, <span class="st">","</span>, a, <span class="st">","</span>, r, <span class="st">","</span>, sN, <span class="st">","</span>, aN, <span class="st">"), r = "</span>, r, <span class="st">" oldQ = "</span>, oldQ, <span class="st">" Q(sN, aN) = "</span>, self<span class="sc">$</span>model[[sN]]<span class="sc">$</span>actions[[aN]]<span class="sc">$</span>q, <span class="st">" newQ = "</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb7-456"><a href="#cb7-456" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb7-457"><a href="#cb7-457" aria-hidden="true" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb7-458"><a href="#cb7-458" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> aN</span>
<span id="cb7-459"><a href="#cb7-459" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-460"><a href="#cb7-460" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb7-461"><a href="#cb7-461" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-462"><a href="#cb7-462" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with "</span>, ite, <span class="st">" episodes."</span>)</span>
<span id="cb7-463"><a href="#cb7-463" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with episode of length "</span>, i, <span class="st">"."</span>)</span>
<span id="cb7-464"><a href="#cb7-464" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-465"><a href="#cb7-465" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-466"><a href="#cb7-466" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb7-467"><a href="#cb7-467" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Generalized policy iteration using off policy Q-learning.  </span></span>
<span id="cb7-468"><a href="#cb7-468" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb7-469"><a href="#cb7-469" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-470"><a href="#cb7-470" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxE Maximum number of episodes generated.</span></span>
<span id="cb7-471"><a href="#cb7-471" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb7-472"><a href="#cb7-472" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all action-values to 0.</span></span>
<span id="cb7-473"><a href="#cb7-473" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb7-474"><a href="#cb7-474" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb7-475"><a href="#cb7-475" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb7-476"><a href="#cb7-476" aria-hidden="true" tabindex="-1"></a>      <span class="at">gpiOffPolicyQLearning =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-477"><a href="#cb7-477" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb7-478"><a href="#cb7-478" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb7-479"><a href="#cb7-479" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb7-480"><a href="#cb7-480" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-481"><a href="#cb7-481" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb7-482"><a href="#cb7-482" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb7-483"><a href="#cb7-483" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb7-484"><a href="#cb7-484" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb7-485"><a href="#cb7-485" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb7-486"><a href="#cb7-486" aria-hidden="true" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb7-487"><a href="#cb7-487" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb7-488"><a href="#cb7-488" aria-hidden="true" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb7-489"><a href="#cb7-489" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb7-490"><a href="#cb7-490" aria-hidden="true" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb7-491"><a href="#cb7-491" aria-hidden="true" tabindex="-1"></a>               maxQ <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getMaxActionValue</span>(sN)</span>
<span id="cb7-492"><a href="#cb7-492" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> maxQ <span class="sc">-</span> oldQ)</span>
<span id="cb7-493"><a href="#cb7-493" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">"(s,a,r,s) = ("</span>, s, <span class="st">","</span>, a, <span class="st">","</span>, r, <span class="st">","</span>, sN, <span class="st">"), r = "</span>, r, <span class="st">" oldQ = "</span>, oldQ, <span class="st">" maxQ(sN) = "</span>, maxQ, <span class="st">" newQ = "</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb7-494"><a href="#cb7-494" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb7-495"><a href="#cb7-495" aria-hidden="true" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb7-496"><a href="#cb7-496" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-497"><a href="#cb7-497" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb7-498"><a href="#cb7-498" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-499"><a href="#cb7-499" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setGreedyPolicy</span>()</span>
<span id="cb7-500"><a href="#cb7-500" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with "</span>, ite, <span class="st">" episodes."</span>)</span>
<span id="cb7-501"><a href="#cb7-501" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with episode of length "</span>, i, <span class="st">"."</span>)</span>
<span id="cb7-502"><a href="#cb7-502" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-503"><a href="#cb7-503" aria-hidden="true" tabindex="-1"></a>      },</span>
<span id="cb7-504"><a href="#cb7-504" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-505"><a href="#cb7-505" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @description Generalized policy iteration using off policy Q-learning.  </span></span>
<span id="cb7-506"><a href="#cb7-506" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param env The environment which must have a method `getTimeStepData(s,a)` that return a list with elements `r` (reward) and `sN` (next state). </span></span>
<span id="cb7-507"><a href="#cb7-507" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param gamma Discount rate.</span></span>
<span id="cb7-508"><a href="#cb7-508" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxE Maximum number of episodes generated.</span></span>
<span id="cb7-509"><a href="#cb7-509" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param maxEL Maximum length of episode. If model with continuing tasks use this to set the length of training.</span></span>
<span id="cb7-510"><a href="#cb7-510" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param reset If true initialize all action-values to 0.</span></span>
<span id="cb7-511"><a href="#cb7-511" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param states Possible start states of an episode. One selected randomly.</span></span>
<span id="cb7-512"><a href="#cb7-512" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param eps Epsilon used for the epsilon-greedy policy.</span></span>
<span id="cb7-513"><a href="#cb7-513" aria-hidden="true" tabindex="-1"></a>      <span class="co">#' @param alpha Step-size (use a fixed step-size).</span></span>
<span id="cb7-514"><a href="#cb7-514" aria-hidden="true" tabindex="-1"></a>      <span class="at">gpiOnPolicyExpSARSA =</span> <span class="cf">function</span>(env, <span class="at">gamma =</span> <span class="dv">1</span>, <span class="at">maxE =</span> <span class="dv">1000</span>, <span class="at">maxEL =</span> <span class="dv">10000</span>, <span class="at">reset =</span> <span class="cn">TRUE</span>, <span class="at">states =</span> self<span class="sc">$</span><span class="fu">getStateKeys</span>(), <span class="at">eps =</span> <span class="fl">0.1</span>, <span class="at">alpha =</span> <span class="fl">0.1</span>, <span class="at">verbose =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb7-515"><a href="#cb7-515" aria-hidden="true" tabindex="-1"></a>         <span class="cf">if</span> (reset) {</span>
<span id="cb7-516"><a href="#cb7-516" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionValue</span>()      <span class="co"># set to 0</span></span>
<span id="cb7-517"><a href="#cb7-517" aria-hidden="true" tabindex="-1"></a>            self<span class="sc">$</span><span class="fu">setActionCtrValue</span>()</span>
<span id="cb7-518"><a href="#cb7-518" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-519"><a href="#cb7-519" aria-hidden="true" tabindex="-1"></a>         self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, self<span class="sc">$</span><span class="fu">getStateKeys</span>())</span>
<span id="cb7-520"><a href="#cb7-520" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> (ite <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxE) {</span>
<span id="cb7-521"><a href="#cb7-521" aria-hidden="true" tabindex="-1"></a>            s <span class="ot">&lt;-</span> <span class="fu">sample</span>(states, <span class="dv">1</span>)  <span class="co"># pick start state among possible start states</span></span>
<span id="cb7-522"><a href="#cb7-522" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>maxEL) {  <span class="co"># for episode with s as start (max length 100000)</span></span>
<span id="cb7-523"><a href="#cb7-523" aria-hidden="true" tabindex="-1"></a>               a <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getActionPi</span>(s)</span>
<span id="cb7-524"><a href="#cb7-524" aria-hidden="true" tabindex="-1"></a>               dat <span class="ot">&lt;-</span> env<span class="sc">$</span><span class="fu">getTimeStepData</span>(s,a)  <span class="co"># get next state and reward</span></span>
<span id="cb7-525"><a href="#cb7-525" aria-hidden="true" tabindex="-1"></a>               r <span class="ot">&lt;-</span> dat<span class="sc">$</span>r</span>
<span id="cb7-526"><a href="#cb7-526" aria-hidden="true" tabindex="-1"></a>               sN <span class="ot">&lt;-</span> dat<span class="sc">$</span>sN</span>
<span id="cb7-527"><a href="#cb7-527" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (<span class="fu">is.na</span>(sN) <span class="sc">|</span> <span class="fu">is.na</span>(a)) <span class="cf">break</span>  <span class="co"># start generating new episode</span></span>
<span id="cb7-528"><a href="#cb7-528" aria-hidden="true" tabindex="-1"></a>               oldQ <span class="ot">&lt;-</span> self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q  </span>
<span id="cb7-529"><a href="#cb7-529" aria-hidden="true" tabindex="-1"></a>               expQ <span class="ot">&lt;-</span> self<span class="sc">$</span><span class="fu">getExpActionValue</span>(sN)</span>
<span id="cb7-530"><a href="#cb7-530" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q <span class="ot">&lt;-</span> oldQ <span class="sc">+</span> alpha <span class="sc">*</span> (r <span class="sc">+</span> gamma <span class="sc">*</span> expQ <span class="sc">-</span> oldQ)</span>
<span id="cb7-531"><a href="#cb7-531" aria-hidden="true" tabindex="-1"></a>               <span class="cf">if</span> (verbose) <span class="fu">cat</span>(<span class="st">"(s,a,r,s) = ("</span>, s, <span class="st">","</span>, a, <span class="st">","</span>, r, <span class="st">","</span>, sN, <span class="st">"), r = "</span>, r, <span class="st">" oldQ = "</span>, oldQ, <span class="st">" expQ(sN) = "</span>, expQ, <span class="st">" newQ = "</span>, self<span class="sc">$</span>model[[s]]<span class="sc">$</span>actions[[a]]<span class="sc">$</span>q, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>, <span class="at">sep =</span> <span class="st">""</span>)</span>
<span id="cb7-532"><a href="#cb7-532" aria-hidden="true" tabindex="-1"></a>               self<span class="sc">$</span><span class="fu">setEpsGreedyPolicy</span>(eps, s)</span>
<span id="cb7-533"><a href="#cb7-533" aria-hidden="true" tabindex="-1"></a>               s <span class="ot">&lt;-</span> sN</span>
<span id="cb7-534"><a href="#cb7-534" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb7-535"><a href="#cb7-535" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (i <span class="sc">==</span> maxEL) <span class="cf">break</span></span>
<span id="cb7-536"><a href="#cb7-536" aria-hidden="true" tabindex="-1"></a>         }</span>
<span id="cb7-537"><a href="#cb7-537" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with "</span>, ite, <span class="st">" episodes."</span>)</span>
<span id="cb7-538"><a href="#cb7-538" aria-hidden="true" tabindex="-1"></a>         <span class="fu">message</span>(<span class="st">"GPI algorithm stopped with episode of length "</span>, i, <span class="st">"."</span>)</span>
<span id="cb7-539"><a href="#cb7-539" aria-hidden="true" tabindex="-1"></a>         <span class="fu">return</span>(<span class="fu">invisible</span>(<span class="cn">NULL</span>))</span>
<span id="cb7-540"><a href="#cb7-540" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb7-541"><a href="#cb7-541" aria-hidden="true" tabindex="-1"></a>   )</span>
<span id="cb7-542"><a href="#cb7-542" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Pay attention to the <code>gpiOnPolicyMC</code> method which uses generalized policy iteration with every-visit estimation using on-policy sampling and an epsilon greedy policy for action selection. Note that <code>gpiOnPolicyMC</code> also takes a set of states as input which are the starting states of the episodes generated (all used in each iteration). Moreover, we do not use a step size equal <span class="math inline">\(1/n_a\)</span> but <span class="math inline">\((1/n_a)^{0.5}\)</span> which decrease slower. Finally, the stopping criteria is added by comparing the the differences in the state-values for each state in an episode. Note the value of <span class="math inline">\(\theta\)</span> gives no guarantee that the action-values will be close to the optimal ones, since we not sample episodes. For instance if two similar episodes are generated early in run then they may be so alike that that the state-values are almost equal and hence the algorithm stops.</p>
<p>We define the RL agent:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>agent <span class="ot">&lt;-</span> RLAgent<span class="sc">$</span><span class="fu">new</span>()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">addStates</span>(env<span class="sc">$</span><span class="fu">getStates</span>())   <span class="co"># add states</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (s <span class="cf">in</span> agent<span class="sc">$</span><span class="fu">getStateKeys</span>()) {  <span class="co"># add actions</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>   agent<span class="sc">$</span><span class="fu">addActions</span>(s, env<span class="sc">$</span><span class="fu">getActions</span>(s))</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>} </span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionKeys</span>(<span class="st">"2,5"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; [1] "10" "15" "20" "25"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given the current policy an episode can be extracted using:</p>
<p>Each row contains the state, action and reward for a time-step. Let us try to approximate the optimal state-value and action in state <span class="math inline">\((50,1)\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">232</span>)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">50</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>state <span class="ot">=</span> <span class="fu">str_c</span>(i, <span class="st">","</span>, time)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">2000</span>, <span class="at">maxIte =</span> <span class="dv">50000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> T, <span class="at">eps =</span> <span class="fl">0.2</span>, <span class="at">theta =</span> <span class="fl">0.2</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionValues</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>   <span class="fu">separate</span>(state, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"inv"</span>, <span class="st">"t"</span>), <span class="at">remove =</span> F, <span class="at">convert =</span> T)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us consider the action-values at state <span class="math inline">\((50,1)\)</span></p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>dfRL <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inv <span class="sc">==</span> i, t <span class="sc">==</span> time) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dfMDP)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 7</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state   inv     t action     q     n     v</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 50,1     50     1 10      51.1   356   NA </span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 50,1     50     1 15     192.    346   NA </span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 50,1     50     1 20     244.  13156  311.</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 50,1     50     1 25     222.    378   NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that actions in state <span class="math inline">\((50,1)\)</span> are sampled differently (based on the epsilon-greedy policy). The best action found (the one with the highest action-value) also seems to be the optimal action w.r.t. the MDP.</p>
<p>Let us make a plot of the greedy action for the visited states:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>visits <span class="ot">&lt;-</span> dfRL <span class="sc">%&gt;%</span> <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span> <span class="fu">summarise</span>(<span class="at">nS =</span> <span class="fu">sum</span>(n)) </span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>df1 <span class="ot">&lt;-</span> dfRL <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>   <span class="fu">group_by</span>(state) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>   <span class="fu">slice_max</span>(q, <span class="at">with_ties =</span> F) <span class="sc">%&gt;%</span> </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(visits) <span class="sc">%&gt;%</span> </span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(n <span class="sc">!=</span> <span class="dv">0</span>)  </span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>df1 <span class="sc">%&gt;%</span> </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>   <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> t, <span class="at">y =</span> inv, <span class="at">size =</span> nS, <span class="at">col =</span> action)) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>   <span class="fu">geom_point</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="09_mc_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid quarto-figure quarto-figure-center figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Observe that the states are now sampled differently. Some states are visited many times (many episodes visit that state) while others are not visited often. For the states visited often we have a better approximation of best action compared to states which are visited rarely. Here the action is more or less random, e.g.&nbsp;the action in state <span class="math inline">\((5,3)\)</span> should not set the price to 10 (setting the price to 25 would be better since we only have 5 items left).</p>
</section>
</section>
<section id="sec-mc-off-policy" class="level2" data-number="9.5">
<h2 data-number="9.5" class="anchored" data-anchor-id="sec-mc-off-policy"><span class="header-section-number">9.5</span> Off-policy MC prediction</h2>
<p>Until now we have only considered what is denoted <em>on-policy</em> algorithms for finding the optimal policy. Here we both evaluate or improve the policy that is used to make decisions. To ensure infinite exploration we use for instance exploring starts or <span class="math inline">\(\epsilon\)</span>-soft policies. <em>Off-policy</em> methods use a different approach by considering two policies: a policy <span class="math inline">\(b\)</span> used to generate the sample-path (behaviour policy) and a policy <span class="math inline">\(\pi\)</span> that is learned for control (target policy). We update the target policy using the sample-paths from the behaviour policy. The behaviour policy explores the environment for us during training and must ensure infinite exploration. Moreover, the <em>coverage</em> assumption must be satisfied: <span class="math display">\[\pi(a|s) &gt; 0 \rightarrow b(a|s) &gt; 0\]</span> That is, every action in <span class="math inline">\(\pi\)</span> must also be taken, at least occasionally, by <span class="math inline">\(b\)</span>. Put differently, to learn <span class="math inline">\(\pi\)</span> we must sample paths that occur when using <span class="math inline">\(\pi\)</span>. Note target policy <span class="math inline">\(\pi\)</span> may be deterministic by using greedy selection with respect to action-value estimates (greedy in the limit satisfied).</p>
<p>Off-policy learning methods are powerful and more general than on-policy methods (on-policy methods being a special case of off-policy where target and behaviour policies are the same). They can be used to learn from data generated by a conventional non-learning controller or from a human expert.</p>
<p>But how do we estimate the expected return using the target policy when we only have sample-paths from the behaviour policy? For this we need to introduce <em>importance sampling</em>, a general technique for estimating expected values under one distribution given samples from another. Let us first explain it using two distributions <span class="math inline">\(a\)</span> and <span class="math inline">\(b\)</span> where we want to estimated the mean of <span class="math inline">\(a\)</span> given data/samples from <span class="math inline">\(b\)</span>, then <span class="math display">\[
\begin{align}
  \mathbb{E}_{a}[X] &amp;= \sum_{x\in X} a(x)x \\
  &amp;= \sum_{x\in X} a(x)\frac{b(x)}{b(x)}x \\
  &amp;= \sum_{x\in X} b(x)\frac{a(x)}{b(x)}x \\
  &amp;= \sum_{x\in X} b(x)\rho(x)x \\
  &amp;= \mathbb{E}_{b}\left[\rho(X)X\right].
\end{align}
\]</span> Hence to the mean of <span class="math inline">\(a\)</span> can be found by finding the mean of <span class="math inline">\(\rho(X)X\)</span> where <span class="math inline">\(X\)</span> is has a <span class="math inline">\(b\)</span> distribution and <span class="math inline">\(\rho(x) = a(x)/b(x)\)</span> denote the <em>importance sampling ratio</em>. Note given samples <span class="math inline">\((x_1,\ldots,x_n)\)</span> from <span class="math inline">\(b\)</span> we then can calculate the sample average using <span class="math display">\[
\begin{align}
  \mathbb{E}_{a}[X] &amp;= \mathbb{E}_{b}\left[\rho(X)X\right] \\
  &amp;\approx \frac{1}{n}\sum_{i = 1}^n \rho(x_i)x_i \\
\end{align}
(\#eq:is-approx)
\]</span></p>
<!-- Example with two distributions -->
<p>Now let us use importance sampling on the target policy <span class="math inline">\(\pi\)</span> and behaviour policy <span class="math inline">\(b\)</span>. Given state <span class="math inline">\(S_t\)</span> and sample path, we want to find <span class="math display">\[v_\pi(s) = \mathbb{E}_{\pi}[G_t|S_t = s] = \mathbb{E}_{b}[\rho(G_t)G_t|S_t = s],\]</span> or since we base our estimates on sample-paths, we are in fact interested in estimating the action-values <span class="math display">\[q_\pi(s,a) = \mathbb{E}_{\pi}[G_t|S_t = s, A_t = a] = \mathbb{E}_{b}[\rho(G_t)G_t|S_t = s, A_t = a].\]</span> For this we need the importance sampling ratio given a certain sample-path <span class="math inline">\(S_t, A_t, R_{t+1}, \ldots, R_T, S_T\)</span> with return <span class="math inline">\(G_t\)</span>: <span class="math display">\[
\begin{align}
    \rho(G_t) &amp;= \frac{\Pr{}(S_t, A_t, \dots S_T| S_t = s, A_t = a, \pi)}{\Pr{}(S_t, A_t, \dots, S_T)| S_t = s, A_t = a, b)} \\
                 &amp;= \frac{\prod_{k=t}^{T-1}\pi(A_k|S_k)\Pr{}(S_{k+1}|S_k, A_k)}{\prod_{k=t}^{T-1}b(A_k|S_k)\Pr{}(S_{k+1}|S_k, A_k)}\\
                 &amp;=\prod_{k=t}^{T-1}\frac{\pi(A_k|S_k)}{b(A_k|S_k)}.
\end{align}
(\#eq:isr)
\]</span> Note the transition probabilities cancel out, i.e.&nbsp;the ratio does not depend on the MDP dynamics by only the policies. Moreover, importance sampling ratios are only non-zero for sample-paths where the target-policy has non-zero probability of acting exactly like the behaviour policy <span class="math inline">\(b\)</span>. So, if the behaviour policy takes 10 steps in an sample-path, each of these 10 steps have to have been possible by the target policy, else <span class="math inline">\(\pi(a|s) = 0\)</span> and <span class="math inline">\(\rho_{t:T-1} = 0\)</span>.</p>
<p>We can now approx. <span class="math inline">\(q_\pi(s,a)\)</span> by rewriting Eq. @ref(eq:is-approx) for <span class="math inline">\(\pi\)</span> given returns from <span class="math inline">\(b\)</span> to <span class="math display">\[
    q_\pi(s,a) = \mathbb{E}_{\pi}[G_t|S_t = s, A_t = a] \approx \frac{1}{n} \sum_{i = 1}^n \rho_iG_i,
    (\#eq:ois)
\]</span> where we assume that given the sample-paths (episodes), have <span class="math inline">\(n\)</span> observations of the return <span class="math inline">\((G_1, \ldots, G_n)\)</span> in state <span class="math inline">\(s\)</span> taking action <span class="math inline">\(a\)</span> with the importance sampling ratio <span class="math inline">\(\rho_i\)</span> calculated using Eq. @ref(eq:isr). As a result if we consider the prediction algorithm in Figure @ref(fig:mc-prediction-alg) it must be modified by:</p>
<ul>
<li>Generate an sample-path using policy <span class="math inline">\(b\)</span> instead of <span class="math inline">\(\pi\)</span>.</li>
<li>Add a variable W representing the importance sampling ratio which must be set to 1 on line containing <span class="math inline">\(G \leftarrow 0\)</span>.</li>
<li>Modify line <span class="math inline">\(G \leftarrow \gamma G + R_{t+1}\)</span> to <span class="math inline">\(G \leftarrow \gamma WG + R_{t+1}\)</span> since we now need to multiply with the importance sampling ratio.</li>
<li>Add a line after the last with <span class="math inline">\(W \leftarrow W \pi(A_t|S_t)/b(A_t|S_t)\)</span>, i.e.&nbsp;we update the importance sampling ratio.</li>
<li>Note if <span class="math inline">\(\pi(A_t|S_t) = 0\)</span> then we may stop the inner loop earlier (<span class="math inline">\(W=0\)</span> for the remaining <span class="math inline">\(t\)</span>).</li>
<li>Finally, an incremental update of <span class="math inline">\(V\)</span> can be done having a vector counting the number of of returns found for each state. Then the incremental update is <span class="math display">\[
V(s) \leftarrow V(s) + \frac{1}{n} \left[WG - V(s)\right].
(\#eq:upd)
\]</span> where <span class="math inline">\(n\)</span> denote the number of realized returns found for state <span class="math inline">\(s\)</span> and <span class="math inline">\(G\)</span> the current realized return.</li>
</ul>
<section id="weighted-importance-sampling" class="level3" data-number="9.5.1">
<h3 data-number="9.5.1" class="anchored" data-anchor-id="weighted-importance-sampling"><span class="header-section-number">9.5.1</span> Weighted importance sampling</h3>
<p>When using a sample average the importance sampling method is called <em>ordinary importance sampling</em>. Ordinary importance sampling may result in a high variance which is not good. As a result we may use other weights and instead of Eq. @ref(eq:ois) use the estimate (<em>weighted importance sampling</em>): <span class="math display">\[
    q_\pi(s,a) = \mathbb{E}_{\pi}[G_t|S_t = s, A_t = a] \approx \frac{1}{\sum_{i = 1}^n \rho_i} \sum_{i = 1}^n \rho_iG_i.
\]</span> An incremental update then becomes:</p>
<p><span class="math display">\[
\begin{align}
    q_\pi(s,a) &amp;\approx V_{n+1} \\
    &amp;= \frac{1}{\sum_{i = 1}^n \rho_i} \sum_{i = 1}^n \rho_iG_i \\
    &amp;= \frac{1}{C_n} \sum_{i = 1}^n W_iG_i \\
    &amp;= \frac{1}{C_n} (W_nG_n + C_{n-1}\frac{1}{C_{n-1}} \sum_{i = 1}^{n-1} W_iG_i) \\
    &amp;= \frac{1}{C_n} (W_nG_n + C_{n-1}V_n) \\
    &amp;= \frac{1}{C_n} (W_nG_n + (C_{n} - W_{n}) V_n) \\
    &amp;= \frac{1}{C_n} (W_nG_n + C_{n}V_n - W_{n} V_n) \\
    &amp;= V_n + \frac{W_n}{C_n} (G_n  - V_n),
\end{align}
(\#eq:wpd)
\]</span> where <span class="math inline">\(C_n = \sum_{i = 1}^n \rho_i\)</span> is the sum of the ratios and and <span class="math inline">\(W_n\)</span> the ratio for the n’th return. Using weighted importance sampling gives a smaller variance and hence faster convergence. An off-policy prediction algorithm using weighted importance sampling and incremental updates is given in Figure @ref(fig:mc-pred-off-policy-alg).</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/mc-off-policy-prediction.png" class="img-fluid figure-img" width="630"></p>
<figcaption>Off-policy MC prediction <span class="citation" data-cites="Sutton18">(<a href="references.html#ref-Sutton18" role="doc-biblioref">Sutton and Barto 2018</a>)</span>.</figcaption>
</figure>
</div>
</div>
</div>
<p>Note both Eq. @ref(eq:upd) and Eq. @ref(eq:wpd) follows the general incremental formula: <span class="math display">\[\begin{equation}
New Estimate \leftarrow Old Estimate + Step Size \left[Observation - Old Estimate \right].
\end{equation}\]</span> For ordinary importance sampling the step-size is <span class="math inline">\(1/n\)</span> and for weighted importance sampling the step-size is <span class="math inline">\(W_n/C_n\)</span>.</p>
</section>
</section>
<section id="off-policy-control-improvement" class="level2" data-number="9.6">
<h2 data-number="9.6" class="anchored" data-anchor-id="off-policy-control-improvement"><span class="header-section-number">9.6</span> Off-policy control (improvement)</h2>
<p>Having discussed a framework for off-policy MC prediction, we can now give a GPI algorithm for off-policy MC control that estimate <span class="math inline">\(\pi_*\)</span> and <span class="math inline">\(q_*\)</span> by using rewards obtained through behaviour policy <span class="math inline">\(b\)</span>. We will focus on using weighted importance sampling with incremental updates. The algorithm is given in Figure @ref(fig:mc-gpi-off-policy-alg). The target policy <span class="math inline">\(\pi\)</span> is the greedy policy with respect to <span class="math inline">\(Q\)</span>, which is an estimate of <span class="math inline">\(q_\pi\)</span>. This algorithm converges to <span class="math inline">\(q_\pi\)</span> as long as an infinite number of returns are observed for each state-action pair. This can be achieved by making <span class="math inline">\(b\)</span> <span class="math inline">\(\varepsilon\)</span>-soft. The policy <span class="math inline">\(\pi\)</span> converges to <span class="math inline">\(\pi_*\)</span> at all encountered states even if <span class="math inline">\(b\)</span> changes (to another <span class="math inline">\(\varepsilon\)</span>-soft policy) between or within sample-paths. Note we exit the inner loop if <span class="math inline">\(A_t \neq \pi(S_t)\)</span> which implies <span class="math inline">\(W=0\)</span>.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="img/mc-off-policy-gpi.png" class="img-fluid figure-img" width="629"></p>
<figcaption>Off-policy GPI <span class="citation" data-cites="Sutton18">(<a href="references.html#ref-Sutton18" role="doc-biblioref">Sutton and Barto 2018</a>)</span>.</figcaption>
</figure>
</div>
</div>
</div>
<p>Notice that this policy only learns from sample-paths in which <span class="math inline">\(b\)</span> selects only greedy actions after some timestep. This can greatly slow learning.</p>
</section>
<section id="summary" class="level2" data-number="9.7">
<h2 data-number="9.7" class="anchored" data-anchor-id="summary"><span class="header-section-number">9.7</span> Summary</h2>
<p>Read Chapter 5.10 in <span class="citation" data-cites="Sutton18">Sutton and Barto (<a href="references.html#ref-Sutton18" role="doc-biblioref">2018</a>)</span>.</p>
</section>
<section id="exercises" class="level2" data-number="9.8">
<h2 data-number="9.8" class="anchored" data-anchor-id="exercises"><span class="header-section-number">9.8</span> Exercises</h2>
<p>Below you will find a set of exercises. Always have a look at the exercises before you meet in your study group and try to solve them yourself. Are you stuck, see the <a href="99_2_appdx.html">help page</a>. Sometimes hints and solutions can be revealed. Beware, you will not learn by giving up too early. Put some effort into finding a solution!</p>
<section id="sec-mc-seasonal" class="level3" data-number="9.8.1">
<h3 data-number="9.8.1" class="anchored" data-anchor-id="sec-mc-seasonal"><span class="header-section-number">9.8.1</span> Exercise - Seasonal inventory and sales planning</h3>
<p>Consider the seasonal product in Example @ref(mc-seasonal).</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">876</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>prices <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">25</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>env <span class="ot">&lt;-</span> RLEnvSeasonal<span class="sc">$</span><span class="fu">new</span>(<span class="at">maxInv =</span> <span class="dv">100</span>, <span class="at">maxT =</span> <span class="dv">15</span>, <span class="at">scrapPrice =</span> <span class="dv">5</span>, <span class="at">purchasePrice =</span> <span class="dv">14</span>, prices)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!-- Q1 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="With a low inventory level, there is a high probability of selling everything even for the highest price. This effect is more dominant if the number of time-steps left is high and decrease as we approach week 15. Contrary with a high inventory level there is a low probability of selling everything (if the price is set to high) and therefore we have to use a lower price. This effect is more dominant if the number of time-steps left is low." data-str_id="nsd3QCYiHPGPH3UKIUYD">
<div id="nsd3QCYiHPGPH3UKIUYD" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="nsd3QCYiHPGPH3UKIUYD-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="nsd3QCYiHPGPH3UKIUYD-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
With a low inventory level, there is a high probability of selling everything even for the highest price. This effect is more dominant if the number of time-steps left is high and decrease as we approach week 15. Contrary with a high inventory level there is a low probability of selling everything (if the price is set to high) and therefore we have to use a lower price. This effect is more dominant if the number of time-steps left is low.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#nsd3QCYiHPGPH3UKIUYD">
Solution
</button>
</div>
<ol type="1">
<li>Consider the optimal policy for the MDP modelling the problem in Figure @ref(fig:seasonal-mdp-plot). Here the optimal price is high at the lower-left and decrease as we approach the upper-right. Explain why this from an intuitive point of view seems correct.</li>
</ol>
<!-- Q2 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="The optimal policy is found using a threshold value, i.e the MDP finds an optimal policy with state-values within the threshold. Hence small differences in state-value may produce different optimal prices. Another reason could be that we have multiple optimal policies." data-str_id="BqbuGwrGhbEJMHpaXfpP">
<div id="BqbuGwrGhbEJMHpaXfpP" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="BqbuGwrGhbEJMHpaXfpP-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="BqbuGwrGhbEJMHpaXfpP-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
The optimal policy is found using a threshold value, i.e the MDP finds an optimal policy with state-values within the threshold. Hence small differences in state-value may produce different optimal prices. Another reason could be that we have multiple optimal policies.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#BqbuGwrGhbEJMHpaXfpP">
Solution
</button>
</div>
<ol start="2" type="1">
<li>Consider the optimal policy for the MDP modelling the problem in Figure @ref(fig:seasonal-mdp-plot). For a fixed time <span class="math inline">\(t\)</span> the optimal price does not always decrease as the inventory level increase. Some time two prices oscillate (e.g.&nbsp;first green, then red and then green again). Give possible reasons for this happening.</li>
</ol>
<!-- Q3 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="In state $(1,1)$ the optimal price is 25 (we only have one item left to sell over 15 weeks) and in state $(100,15)$ the optimal price is 10 (we can not sell all items in one week so set price low)." data-str_id="LSEmyzXPhW8qUIm7pChX">
<div id="LSEmyzXPhW8qUIm7pChX" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="LSEmyzXPhW8qUIm7pChX-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="LSEmyzXPhW8qUIm7pChX-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
In state ((1,1)) the optimal price is 25 (we only have one item left to sell over 15 weeks) and in state ((100,15)) the optimal price is 10 (we can not sell all items in one week so set price low).
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#LSEmyzXPhW8qUIm7pChX">
Solution
</button>
</div>
<ol start="3" type="1">
<li>Let us consider two extreme states <span class="math inline">\((1,1)\)</span> and <span class="math inline">\((100,15)\)</span>. From an intuitively point of view, what is the optimal action/price to do in these states?</li>
</ol>
<!-- Q4 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="Since the epsilon-greedy policy selects $a=20$ (at random) first, $a=20$ becomes the greedy action that is selected with highest probability. In this run, when selecting the next action, 20 is always selected and hence only $q$ for $a=20$ is updated 10 times (minimum number of iterations). Afterwards differences in state-values of states in the current episode are compared (`oldV` and `v` column). Since they are the same the algorithm stop. That is, we never get a chance to have a view on action $a=25$ or put differently, the stopping criteria may not work well for episodes with small length." data-str_id="mPHpcDkqrfLL4ce5cbps">
<div id="mPHpcDkqrfLL4ce5cbps" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="mPHpcDkqrfLL4ce5cbps-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="mPHpcDkqrfLL4ce5cbps-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
Since the epsilon-greedy policy selects (a=20) (at random) first, (a=20) becomes the greedy action that is selected with highest probability. In this run, when selecting the next action, 20 is always selected and hence only (q) for (a=20) is updated 10 times (minimum number of iterations). Afterwards differences in state-values of states in the current episode are compared (<code>oldV</code> and <code>v</code> column). Since they are the same the algorithm stop. That is, we never get a chance to have a view on action (a=25) or put differently, the stopping criteria may not work well for episodes with small length.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#mPHpcDkqrfLL4ce5cbps">
Solution
</button>
</div>
<ol start="4" type="1">
<li>Consider state <span class="math inline">\((1,1)\)</span> and let us try approximating best epsilon-greedy policy using MC with the verbose option so it prints out info about each episode:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">79</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>state <span class="ot">=</span> <span class="fu">str_c</span>(i, <span class="st">","</span>, time)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">10</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> T, <span class="at">eps =</span> <span class="fl">0.2</span>, <span class="at">verbose =</span> T)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     1     1     0     6     6     0   5.1</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     2     2     6     6     6   5.1   5.1</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     3     3     6     6     6   5.1   5.1</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     4     4     6     6     6   5.1   5.1</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     5     5     6     6     6   5.1   5.1</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     6     6     6     6     6   5.1   5.1</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     7     7     6     6     6   5.1   5.1</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     8     8     6     6     6   5.1   5.1</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     9     9     6     6     6   5.1   5.1</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6    10    10     6     6     6   5.1   5.1</span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionValues</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>   <span class="fu">separate</span>(state, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"inv"</span>, <span class="st">"t"</span>), <span class="at">remove =</span> F, <span class="at">convert =</span> T)</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>dfRL <span class="sc">%&gt;%</span></span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inv <span class="sc">==</span> i, t <span class="sc">==</span> time) <span class="sc">%&gt;%</span> </span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dfMDP)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 7</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state   inv     t action     q     n     v</span></span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1       1     1 10         0     0  NA  </span></span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1,1       1     1 15         0     0  NA  </span></span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 1,1       1     1 20         6    10  NA  </span></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 1,1       1     1 25         0     0  11.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Why do we not estimate the optimal action here and why do the algorithm stop. Hint: You may have a look at method <code>gpiOnPolicyMC</code> in the RLAgent class.</p>
<!-- Q5 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="Since the initial action-value is high, all actions will be explored with high probability first. This may help the algorithm to get a good start." data-str_id="E1UWYwFVTUG6TatvgDC4">
<div id="E1UWYwFVTUG6TatvgDC4" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="E1UWYwFVTUG6TatvgDC4-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="E1UWYwFVTUG6TatvgDC4-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
Since the initial action-value is high, all actions will be explored with high probability first. This may help the algorithm to get a good start.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#E1UWYwFVTUG6TatvgDC4">
Solution
</button>
</div>
<ol start="5" type="1">
<li>Let us try to set the action-value high initially:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">105</span>)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setActionValue</span>(<span class="dv">1000</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getActionValues</span>(<span class="st">"1,1"</span>)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state action     q     n</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   10      1000     0</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1,1   15      1000     0</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 1,1   20      1000     0</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 1,1   25      1000     0</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">5</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> F, <span class="at">eps =</span> <span class="fl">0.2</span>, <span class="at">verbose =</span> T)</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   15        1     1     1  1000     1     1  1000  950.</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 10</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   25      -14     1     2  1000    11    11  950.  901.</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1,2   25       25     1     1  1000    25    25 1000   951.</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   10       -4     1     3  1000    -4    -4  901.  850.</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 10</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   20        6     1     4  1000     6     6  850.   9.5</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 2 × 10</span></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r    nA    nS  oldQ     q     g  oldV     v</span></span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1   25      -14     2     5    11    11    11   9.5   9.5</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1,2   25       25     2     2    25    25    25 951.  951.</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionValues</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>   <span class="fu">separate</span>(state, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"inv"</span>, <span class="st">"t"</span>), <span class="at">remove =</span> F, <span class="at">convert =</span> T)</span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a>dfRL <span class="sc">%&gt;%</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inv <span class="sc">==</span> i, t <span class="sc">==</span> time) <span class="sc">%&gt;%</span> </span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dfMDP)</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 7</span></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state   inv     t action     q     n     v</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 1,1       1     1 10        -4     1  NA  </span></span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 1,1       1     1 15         1     1  NA  </span></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 1,1       1     1 20         6     1  NA  </span></span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 1,1       1     1 25        11     2  11.0</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>What happens with the sequence of episodes?</p>
<!-- Q6 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="Since we do simulations (we here do 3) each simulation may produce different results depending on how the algorithm starts. That is, we need more iterations for converging to the correct state-value." data-str_id="H1htBI4rrFF4QyQbhqTQ">
<div id="H1htBI4rrFF4QyQbhqTQ" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="H1htBI4rrFF4QyQbhqTQ-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="H1htBI4rrFF4QyQbhqTQ-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
Since we do simulations (we here do 3) each simulation may produce different results depending on how the algorithm starts. That is, we need more iterations for converging to the correct state-value.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#H1htBI4rrFF4QyQbhqTQ">
Solution
</button>
</div>
<ol start="6" type="1">
<li>Consider state <span class="math inline">\((1,1)\)</span> and let us try approximating best epsilon-greedy policy using MC using more episodes:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">749</span>)</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">100</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> T, <span class="at">eps =</span> <span class="fl">0.2</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getStateValueQ</span>(state)  <span class="co"># get the state-value v(s) of the epsilon-greedy policy</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   10 </span></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9.34</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">1000</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> T, <span class="at">eps =</span> <span class="fl">0.2</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getStateValueQ</span>(state)  <span class="co"># get the state-value v(s) of the epsilon-greedy policy</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   10 </span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9.03</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">2000</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> T, <span class="at">eps =</span> <span class="fl">0.2</span>)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getStateValueQ</span>(state)  <span class="co"># get the state-value v(s) of the epsilon-greedy policy</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   10 </span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 9.49</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Why is the state-value not increasing monotone as number of iterations increase?</p>
<!-- Q7 -->
<div class="cell" data-layout-align="center" data-solution="true" data-text="No, the q-values are the averages over all the generated episodes (also those generated using bad policies). With enough simulations these numbers will converge against the action-values for the best epsilon-greedy policy ($\epsilon = 0.5$ here), not the optimal greedy policy." data-str_id="nTZymV5TdwF3iCGuz0Kj">
<div id="nTZymV5TdwF3iCGuz0Kj" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="nTZymV5TdwF3iCGuz0Kj-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="nTZymV5TdwF3iCGuz0Kj-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
No, the q-values are the averages over all the generated episodes (also those generated using bad policies). With enough simulations these numbers will converge against the action-values for the best epsilon-greedy policy ((= 0.5) here), not the optimal greedy policy.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#nTZymV5TdwF3iCGuz0Kj">
Solution
</button>
</div>
<ol start="7" type="1">
<li>Consider state <span class="math inline">\((25,8)\)</span> and let us approximate the best epsilon-greedy policy:</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">281</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>i <span class="ot">&lt;-</span> <span class="dv">25</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>state <span class="ot">=</span> <span class="fu">str_c</span>(i, <span class="st">","</span>, time)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setActionValue</span>(<span class="dv">1000</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setActionCtrValue</span>()   <span class="co"># reset counter</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setStateCtrValue</span>()    <span class="co"># reset counter</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">gpiOnPolicyMC</span>(env, <span class="at">minIte =</span> <span class="dv">5000</span>, <span class="at">maxIte =</span> <span class="dv">100000</span>, <span class="at">states =</span> state, <span class="at">reset =</span> F, <span class="at">eps =</span> <span class="fl">0.5</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>dfRL <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getActionValues</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>   <span class="fu">separate</span>(state, <span class="at">sep =</span> <span class="st">","</span>, <span class="at">into =</span> <span class="fu">c</span>(<span class="st">"inv"</span>, <span class="st">"t"</span>), <span class="at">remove =</span> F, <span class="at">convert =</span> T)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>dfRL <span class="sc">%&gt;%</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>   <span class="fu">filter</span>(inv <span class="sc">==</span> i, t <span class="sc">==</span> time) <span class="sc">%&gt;%</span> </span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>   <span class="fu">left_join</span>(dfMDP)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 7</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state   inv     t action     q     n     v</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 25,8     25     8 10      295.   148   NA </span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 25,8     25     8 15      436.  1491   NA </span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 25,8     25     8 20      480.  3566  502.</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 25,8     25     8 25      438.   135   NA</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As can be seen the the optimal state value for the MDP is not equal the action-value for that action. Should that have been the case if run enough simulations?</p>
<!-- Q8 -->
<ol start="8" type="1">
<li>Consider the very optimistic policy which set the price to 25 (where possible):</li>
</ol>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Set the policy to price 25</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getStateKeys</span>() <span class="sc">%&gt;%</span> <span class="fu">setdiff</span>(<span class="st">"0"</span>) </span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> states[<span class="sc">!</span><span class="fu">str_detect</span>(states, <span class="st">",15"</span>)]</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"25"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setPolicy</span>(states, pi)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># set last time-step</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> agent<span class="sc">$</span><span class="fu">getStateKeys</span>() <span class="sc">%&gt;%</span> <span class="fu">setdiff</span>(<span class="st">"0"</span>) </span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>states <span class="ot">&lt;-</span> states[<span class="fu">str_detect</span>(states, <span class="st">",15"</span>)]</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"5"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setPolicy</span>(states, pi)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="co"># set dummy</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>pi <span class="ot">=</span> <span class="fu">c</span>(<span class="st">"dummy"</span> <span class="ot">=</span> <span class="dv">1</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">setPolicy</span>(<span class="st">"0"</span>, pi)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Check</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getPolicy</span>()</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1,501 × 3</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    state action    pr</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt; &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  1 0     dummy      1</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  2 1,1   25         1</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  3 1,10  25         1</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  4 1,11  25         1</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  5 1,12  25         1</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  6 1,13  25         1</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  7 1,14  25         1</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  8 1,15  5          1</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;  9 1,2   25         1</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 10 1,3   25         1</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # ℹ 1,491 more rows</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We may generate an episode using:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>env<span class="sc">$</span><span class="fu">getEpisodePi</span>(agent, <span class="st">"5,1"</span>)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 7 × 3</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   s     a         r</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt;</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 5,1   25      -45</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 2 4,2   25       25</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 3 3,3   25        0</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 4 3,4   25        0</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 5 3,5   25       25</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 6 2,6   25       25</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 7 1,7   25       25</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let us try to evaluate this policy in states <span class="math inline">\((5,1)\)</span> and <span class="math inline">\((100,10)\)</span>:</p>
<div class="cell" data-layout-align="center">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">6778</span>)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">policyEvalMC</span>(env, <span class="at">states =</span> <span class="st">"5,1"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getStateValues</span>(<span class="st">"5,1"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Rowwise: </span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state     v</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;dbl&gt;</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 5,1      55</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>dfMDP <span class="sc">%&gt;%</span> <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"5,1"</span>)</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 5</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state   inv     t     v action</span></span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; </span></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 5,1       5     1  55.0 25</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">policyEvalMC</span>(env, <span class="at">states =</span> <span class="st">"100,10"</span>)</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>agent<span class="sc">$</span><span class="fu">getStateValues</span>(<span class="st">"100,10"</span>)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 2</span></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # Rowwise: </span></span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state      v</span></span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;  &lt;dbl&gt;</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 100,10  578.</span></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>dfMDP <span class="sc">%&gt;%</span> <span class="fu">filter</span>(state <span class="sc">==</span> <span class="st">"100,10"</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; # A tibble: 1 × 5</span></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   state    inv     t     v action</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;  &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; </span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a><span class="co">#&gt; 1 100,10   100    10 1001. 15</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-layout-align="center" data-solution="true" data-text="For state $(5,1)$ it is optimal to set the price high for all states in the sample-path and we estimate the optimal policy. For state $(100,10)$ it is not optimal to set the price high, i.e. the state-value we estimate here is not the optimal one." data-str_id="Y0jNdC3WCMCtd5h79qoX">
<div id="Y0jNdC3WCMCtd5h79qoX" class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="Y0jNdC3WCMCtd5h79qoX-title">
<div class="modal-dialog modal-lg" role="document">
<div class="modal-content">
<div class="modal-header">
<button type="button" class="close" data-dismiss="modal" aria-label="Close">
<span aria-hidden="true">×</span>
</button>
<h4 class="modal-title anchored" id="Y0jNdC3WCMCtd5h79qoX-title">
Solution
</h4>
</div>
<div class="modal-body">
<p>
For state ((5,1)) it is optimal to set the price high for all states in the sample-path and we estimate the optimal policy. For state ((100,10)) it is not optimal to set the price high, i.e.&nbsp;the state-value we estimate here is not the optimal one.
</p>
</div>
<div class="modal-footer">
<button class="btn btn-default" data-dismiss="modal">
Close
</button>
</div>
</div>
</div>
</div>
<button class="btn btn-default btn-xs" style="float:right" data-toggle="modal" data-target="#Y0jNdC3WCMCtd5h79qoX">
Solution
</button>
</div>
<p>Why do we have state-values close and not close to the optimal values for the MDP?</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-Sutton18" class="csl-entry" role="listitem">
Sutton, R. S., and A. G. Barto. 2018. <em>Reinforcement Learning: An Introduction</em>. Second Edition. MIT Press. <a href="http://incompleteideas.net/book/the-book.html">http://incompleteideas.net/book/the-book.html</a>.
</div>
</div>
</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./08_dp.html" class="pagination-link" aria-label="Dynamic programming">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Dynamic programming</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./references.html" class="pagination-link" aria-label="References">
        <span class="nav-page-text">References</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/bss-osca/rl/edit/master/book/09_mc.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/bss-osca/rl/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li><li><a href="https://github.com/bss-osca/rl/blob/master/book/09_mc.qmd" class="toc-action"><i class="bi empty"></i>View source</a></li></ul></div></div></div></footer><script src="site_libs/quarto-html/zenscroll-min.js"></script>
</body></html>